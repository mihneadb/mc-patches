# HG changeset patch
# Parent b91df6089f9f516b8ef1963e624db15dda17892c
# User Mihnea Dobrescu-Balaur <mihneadb@gmail.com>
Bug 911249 - Make sure harness does not block if killing a process hangs

diff --git a/testing/xpcshell/runxpcshelltests.py b/testing/xpcshell/runxpcshelltests.py
--- a/testing/xpcshell/runxpcshelltests.py
+++ b/testing/xpcshell/runxpcshelltests.py
@@ -1347,20 +1347,21 @@ class XPCShellTests(object):
             self.event.wait(1)
             self.event.clear()
 
             # find what tests are done (might be more than 1)
             done_tests = set()
             for test in running_tests:
                 if test.done:
                     done_tests.add(test)
-                    test.join()
+                    test.join(1) # join with timeout so we don't hang on blocked threads
                     # if the test had trouble, we will try running it again
                     # at the end of the run
-                    if test.retry:
+                    if test.retry or test.is_alive():
+                        # if the join call timed out, test.is_alive => True
                         self.try_again_list.append(test.test_object)
                         continue
                     # did the test encounter any exception?
                     if test.exception:
                         exceptions.append(test.exception)
                         tracebacks.append(test.traceback)
                         # we won't add any more tests, will just wait for
                         # the currently running ones to finish

# HG changeset patch
# User Mihnea Dobrescu-Balaur <mihneadb@gmail.com>
# Date 1374730543 25200
#      Wed Jul 24 22:35:43 2013 -0700
# Node ID 6f43eca4470ed2430f6487ae8e847e4a99c37155
# Parent 129ce98f4cb24f84d8d18d2563aaade4facb2a76
Bug 889182 - mozapps/extensions xpcshell tests cannot be run concurrently

diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_hard1_1/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_hard1_1/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_hard1_1/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_hard1_1/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>hardblock@tests.mozilla.org</em:id>
     <em:version>1.0</em:version>
     <em:name>Hardblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update1.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_hard1_2/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_hard1_2/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_hard1_2/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_hard1_2/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>hardblock@tests.mozilla.org</em:id>
     <em:version>2.0</em:version>
     <em:name>Hardblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update2.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_hard1_3/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_hard1_3/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_hard1_3/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_hard1_3/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>hardblock@tests.mozilla.org</em:id>
     <em:version>3.0</em:version>
     <em:name>Hardblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update3.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_regexp1_1/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_regexp1_1/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_regexp1_1/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_regexp1_1/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>regexpblock@tests.mozilla.org</em:id>
     <em:version>1.0</em:version>
     <em:name>RegExp-blocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update1.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_regexp1_2/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_regexp1_2/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_regexp1_2/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_regexp1_2/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>regexpblock@tests.mozilla.org</em:id>
     <em:version>2.0</em:version>
     <em:name>RegExp-blocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update2.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_regexp1_3/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_regexp1_3/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_regexp1_3/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_regexp1_3/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>regexpblock@tests.mozilla.org</em:id>
     <em:version>3.0</em:version>
     <em:name>RegExp-blocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update3.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft1_1/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft1_1/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft1_1/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft1_1/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock1@tests.mozilla.org</em:id>
     <em:version>1.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update1.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft1_2/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft1_2/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft1_2/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft1_2/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock1@tests.mozilla.org</em:id>
     <em:version>2.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update2.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft1_3/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft1_3/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft1_3/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft1_3/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock1@tests.mozilla.org</em:id>
     <em:version>3.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update3.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft2_1/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft2_1/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft2_1/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft2_1/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock2@tests.mozilla.org</em:id>
     <em:version>1.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update1.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft2_2/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft2_2/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft2_2/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft2_2/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock2@tests.mozilla.org</em:id>
     <em:version>2.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update2.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft2_3/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft2_3/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft2_3/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft2_3/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock2@tests.mozilla.org</em:id>
     <em:version>3.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update3.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft3_1/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft3_1/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft3_1/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft3_1/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock3@tests.mozilla.org</em:id>
     <em:version>1.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update1.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft3_2/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft3_2/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft3_2/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft3_2/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock3@tests.mozilla.org</em:id>
     <em:version>2.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update2.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft3_3/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft3_3/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft3_3/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft3_3/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock3@tests.mozilla.org</em:id>
     <em:version>3.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update3.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft4_1/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft4_1/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft4_1/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft4_1/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock4@tests.mozilla.org</em:id>
     <em:version>1.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update1.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft4_2/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft4_2/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft4_2/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft4_2/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock4@tests.mozilla.org</em:id>
     <em:version>2.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update2.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft4_3/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft4_3/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft4_3/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft4_3/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock4@tests.mozilla.org</em:id>
     <em:version>3.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update3.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft5_1/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft5_1/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft5_1/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft5_1/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock5@tests.mozilla.org</em:id>
     <em:version>1.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update1.rdf</em:updateURL>
     <em:internalName>test/1.0</em:internalName>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft5_2/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft5_2/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft5_2/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft5_2/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock5@tests.mozilla.org</em:id>
     <em:version>2.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update2.rdf</em:updateURL>
     <em:internalName>test/1.0</em:internalName>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
diff --git a/toolkit/mozapps/extensions/test/addons/blocklist_soft5_3/install.rdf b/toolkit/mozapps/extensions/test/addons/blocklist_soft5_3/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/blocklist_soft5_3/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/blocklist_soft5_3/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>softblock5@tests.mozilla.org</em:id>
     <em:version>3.0</em:version>
     <em:name>Softblocked add-on</em:name>
-    <em:updateURL>http://localhost:4444/data/addon_update3.rdf</em:updateURL>
     <em:internalName>test/1.0</em:internalName>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
diff --git a/toolkit/mozapps/extensions/test/addons/test_AddonRepository_1/install.rdf b/toolkit/mozapps/extensions/test/addons/test_AddonRepository_1/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/test_AddonRepository_1/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/test_AddonRepository_1/install.rdf
@@ -20,14 +20,14 @@
     <em:description>XPI Add-on 1 - Description</em:description>
     <em:creator>XPI Add-on 1 - Creator</em:creator>
     <em:developer>XPI Add-on 1 - First Developer</em:developer>
     <em:developer>XPI Add-on 1 - Second Developer</em:developer>
     <em:translator>XPI Add-on 1 - First Translator</em:translator>
     <em:translator>XPI Add-on 1 - Second Translator</em:translator>
     <em:contributor>XPI Add-on 1 - First Contributor</em:contributor>
     <em:contributor>XPI Add-on 1 - Second Contributor</em:contributor>
-    <em:homepageURL>http://localhost:4444/xpi/1/homepage.html</em:homepageURL>
-    <em:optionsURL>http://localhost:4444/xpi/1/options.html</em:optionsURL>
-    <em:aboutURL>http://localhost:4444/xpi/1/about.html</em:aboutURL>
-    <em:iconURL>http://localhost:4444/xpi/1/icon.png</em:iconURL>
+    <em:homepageURL>http://localhost/xpi/1/homepage.html</em:homepageURL>
+    <em:optionsURL>http://localhost/xpi/1/options.html</em:optionsURL>
+    <em:aboutURL>http://localhost/xpi/1/about.html</em:aboutURL>
+    <em:iconURL>http://localhost/xpi/1/icon.png</em:iconURL>
   </Description>
 </RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug463819_1/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug463819_1/install.rdf
deleted file mode 100644
--- a/toolkit/mozapps/extensions/test/addons/test_bug463819_1/install.rdf
+++ /dev/null
@@ -1,18 +0,0 @@
-<?xml version="1.0"?>
-
-<RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
-     xmlns:em="http://www.mozilla.org/2004/em-rdf#">
-  <Description about="urn:mozilla:install-manifest">
-    <em:id>test_bug463819_1@tests.mozilla.org</em:id>
-    <em:version>1</em:version>
-    <em:targetApplication>
-      <Description>
-        <em:id>xpcshell@tests.mozilla.org</em:id>
-        <em:minVersion>1</em:minVersion>
-        <em:maxVersion>2</em:maxVersion>
-      </Description>
-    </em:targetApplication>
-    <em:name>Test for Bug 463819</em:name>
-    <em:updateURL>http://localhost:4444/test_bug463819.rdf</em:updateURL>
-  </Description>
-</RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug463819_2/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug463819_2/install.rdf
deleted file mode 100644
--- a/toolkit/mozapps/extensions/test/addons/test_bug463819_2/install.rdf
+++ /dev/null
@@ -1,18 +0,0 @@
-<?xml version="1.0"?>
-
-<RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
-     xmlns:em="http://www.mozilla.org/2004/em-rdf#">
-  <Description about="urn:mozilla:install-manifest">
-    <em:id>test_bug463819_2@tests.mozilla.org</em:id>
-    <em:version>1</em:version>
-    <em:targetApplication>
-      <Description>
-        <em:id>xpcshell@tests.mozilla.org</em:id>
-        <em:minVersion>1</em:minVersion>
-        <em:maxVersion>1</em:maxVersion>
-      </Description>
-    </em:targetApplication>
-    <em:name>Test for Bug 463819</em:name>
-    <em:updateURL>http://localhost:4444/test_bug463819.rdf</em:updateURL>
-  </Description>
-</RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug463819_3/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug463819_3/install.rdf
deleted file mode 100644
--- a/toolkit/mozapps/extensions/test/addons/test_bug463819_3/install.rdf
+++ /dev/null
@@ -1,18 +0,0 @@
-<?xml version="1.0"?>
-
-<RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
-     xmlns:em="http://www.mozilla.org/2004/em-rdf#">
-  <Description about="urn:mozilla:install-manifest">
-    <em:id>test_bug463819_3@tests.mozilla.org</em:id>
-    <em:version>1</em:version>
-    <em:targetApplication>
-      <Description>
-        <em:id>xpcshell@tests.mozilla.org</em:id>
-        <em:minVersion>1</em:minVersion>
-        <em:maxVersion>1</em:maxVersion>
-      </Description>
-    </em:targetApplication>
-    <em:name>Test for Bug 463819</em:name>
-    <em:updateURL>http://localhost:4444/test_bug463819.rdf</em:updateURL>
-  </Description>
-</RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug463819_4/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug463819_4/install.rdf
deleted file mode 100644
--- a/toolkit/mozapps/extensions/test/addons/test_bug463819_4/install.rdf
+++ /dev/null
@@ -1,18 +0,0 @@
-<?xml version="1.0"?>
-
-<RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
-     xmlns:em="http://www.mozilla.org/2004/em-rdf#">
-  <Description about="urn:mozilla:install-manifest">
-    <em:id>test_bug463819_4@tests.mozilla.org</em:id>
-    <em:version>1</em:version>
-    <em:targetApplication>
-      <Description>
-        <em:id>xpcshell@tests.mozilla.org</em:id>
-        <em:minVersion>1</em:minVersion>
-        <em:maxVersion>2</em:maxVersion>
-      </Description>
-    </em:targetApplication>
-    <em:name>Test for Bug 463819</em:name>
-    <em:updateURL>http://localhost:4444/test_bug463819.rdf</em:updateURL>
-  </Description>
-</RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug463819_5/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug463819_5/install.rdf
deleted file mode 100644
--- a/toolkit/mozapps/extensions/test/addons/test_bug463819_5/install.rdf
+++ /dev/null
@@ -1,18 +0,0 @@
-<?xml version="1.0"?>
-
-<RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
-     xmlns:em="http://www.mozilla.org/2004/em-rdf#">
-  <Description about="urn:mozilla:install-manifest">
-    <em:id>test_bug463819_5@tests.mozilla.org</em:id>
-    <em:version>1</em:version>
-    <em:targetApplication>
-      <Description>
-        <em:id>xpcshell@tests.mozilla.org</em:id>
-        <em:minVersion>1</em:minVersion>
-        <em:maxVersion>1</em:maxVersion>
-      </Description>
-    </em:targetApplication>
-    <em:name>Test for Bug 463819</em:name>
-    <em:updateURL>http://localhost:4444/test_bug463819.rdf</em:updateURL>
-  </Description>
-</RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug463819_6/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug463819_6/install.rdf
deleted file mode 100644
--- a/toolkit/mozapps/extensions/test/addons/test_bug463819_6/install.rdf
+++ /dev/null
@@ -1,18 +0,0 @@
-<?xml version="1.0"?>
-
-<RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
-     xmlns:em="http://www.mozilla.org/2004/em-rdf#">
-  <Description about="urn:mozilla:install-manifest">
-    <em:id>test_bug463819_6@tests.mozilla.org</em:id>
-    <em:version>1</em:version>
-    <em:targetApplication>
-      <Description>
-        <em:id>xpcshell@tests.mozilla.org</em:id>
-        <em:minVersion>1</em:minVersion>
-        <em:maxVersion>1</em:maxVersion>
-      </Description>
-    </em:targetApplication>
-    <em:name>Test for Bug 463819</em:name>
-    <em:updateURL>http://localhost:4444/test_bug463819.rdf</em:updateURL>
-  </Description>
-</RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug463819_7/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug463819_7/install.rdf
deleted file mode 100644
--- a/toolkit/mozapps/extensions/test/addons/test_bug463819_7/install.rdf
+++ /dev/null
@@ -1,18 +0,0 @@
-<?xml version="1.0"?>
-
-<RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
-     xmlns:em="http://www.mozilla.org/2004/em-rdf#">
-  <Description about="urn:mozilla:install-manifest">
-    <em:id>test_bug463819_7@tests.mozilla.org</em:id>
-    <em:version>1</em:version>
-    <em:targetApplication>
-      <Description>
-        <em:id>xpcshell@tests.mozilla.org</em:id>
-        <em:minVersion>1</em:minVersion>
-        <em:maxVersion>2</em:maxVersion>
-      </Description>
-    </em:targetApplication>
-    <em:name>Test for Bug 463819</em:name>
-    <em:updateURL>http://localhost:4444/test_bug463819.rdf</em:updateURL>
-  </Description>
-</RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug463819_8/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug463819_8/install.rdf
deleted file mode 100644
--- a/toolkit/mozapps/extensions/test/addons/test_bug463819_8/install.rdf
+++ /dev/null
@@ -1,18 +0,0 @@
-<?xml version="1.0"?>
-
-<RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
-     xmlns:em="http://www.mozilla.org/2004/em-rdf#">
-  <Description about="urn:mozilla:install-manifest">
-    <em:id>test_bug463819_8@tests.mozilla.org</em:id>
-    <em:version>1</em:version>
-    <em:targetApplication>
-      <Description>
-        <em:id>xpcshell@tests.mozilla.org</em:id>
-        <em:minVersion>1</em:minVersion>
-        <em:maxVersion>1</em:maxVersion>
-      </Description>
-    </em:targetApplication>
-    <em:name>Test for Bug 463819</em:name>
-    <em:updateURL>http://localhost:4444/test_bug463819.rdf</em:updateURL>
-  </Description>
-</RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug463819_9/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug463819_9/install.rdf
deleted file mode 100644
--- a/toolkit/mozapps/extensions/test/addons/test_bug463819_9/install.rdf
+++ /dev/null
@@ -1,18 +0,0 @@
-<?xml version="1.0"?>
-
-<RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
-     xmlns:em="http://www.mozilla.org/2004/em-rdf#">
-  <Description about="urn:mozilla:install-manifest">
-    <em:id>test_bug463819_9@tests.mozilla.org</em:id>
-    <em:version>1</em:version>
-    <em:targetApplication>
-      <Description>
-        <em:id>xpcshell@tests.mozilla.org</em:id>
-        <em:minVersion>1</em:minVersion>
-        <em:maxVersion>1</em:maxVersion>
-      </Description>
-    </em:targetApplication>
-    <em:name>Test for Bug 463819</em:name>
-    <em:updateURL>http://localhost:4444/test_bug463819.rdf</em:updateURL>
-  </Description>
-</RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug470377_1/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug470377_1/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/test_bug470377_1/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/test_bug470377_1/install.rdf
@@ -8,11 +8,10 @@
     <em:targetApplication>
       <Description>
         <em:id>unknown@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>1</em:maxVersion>
       </Description>
     </em:targetApplication>
     <em:name>Test for Bug 470377</em:name>
-    <em:updateURL>http://localhost:4444/test_bug470377_1.rdf</em:updateURL>
   </Description>
 </RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug470377_2/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug470377_2/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/test_bug470377_2/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/test_bug470377_2/install.rdf
@@ -8,11 +8,10 @@
     <em:targetApplication>
       <Description>
         <em:id>toolkit@mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>1</em:maxVersion>
       </Description>
     </em:targetApplication>
     <em:name>Test for Bug 470377</em:name>
-    <em:updateURL>http://localhost:4444/test_bug470377_2.rdf</em:updateURL>
   </Description>
 </RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug470377_3/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug470377_3/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/test_bug470377_3/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/test_bug470377_3/install.rdf
@@ -8,11 +8,10 @@
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>1</em:maxVersion>
       </Description>
     </em:targetApplication>
     <em:name>Test for Bug 470377</em:name>
-    <em:updateURL>http://localhost:4444/test_bug470377_3.rdf</em:updateURL>
   </Description>
 </RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug470377_4/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug470377_4/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/test_bug470377_4/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/test_bug470377_4/install.rdf
@@ -8,11 +8,10 @@
     <em:targetApplication>
       <Description>
         <em:id>toolkit@mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>2</em:maxVersion>
       </Description>
     </em:targetApplication>
     <em:name>Test for Bug 470377</em:name>
-    <em:updateURL>http://localhost:4444/test_bug470377_4.rdf</em:updateURL>
   </Description>
 </RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug470377_5/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug470377_5/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/test_bug470377_5/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/test_bug470377_5/install.rdf
@@ -8,11 +8,10 @@
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>3</em:maxVersion>
       </Description>
     </em:targetApplication>
     <em:name>Test for Bug 470377</em:name>
-    <em:updateURL>http://localhost:4444/test_bug470377_5.rdf</em:updateURL>
   </Description>
 </RDF>
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug567184/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug567184/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/test_bug567184/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/test_bug567184/install.rdf
@@ -7,19 +7,16 @@
     <em:id>bug567184@tests.mozilla.org</em:id>
     <em:version>1.0</em:version>
     <em:bootstrap>true</em:bootstrap>
 
     <!-- Front End MetaData -->
     <em:name>Bug 567184 Test</em:name>
     <em:description>Test Description</em:description>
 
-    <!-- Prevent checking for updates on the default update server  -->
-    <em:updateURL>http://localhost:4444/data/</em:updateURL>
-
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>undefined</em:minVersion>
         <em:maxVersion>undefined</em:maxVersion>
       </Description>
     </em:targetApplication>
 
diff --git a/toolkit/mozapps/extensions/test/addons/test_bug655254/install.rdf b/toolkit/mozapps/extensions/test/addons/test_bug655254/install.rdf
--- a/toolkit/mozapps/extensions/test/addons/test_bug655254/install.rdf
+++ b/toolkit/mozapps/extensions/test/addons/test_bug655254/install.rdf
@@ -2,17 +2,16 @@
 
 <RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:em="http://www.mozilla.org/2004/em-rdf#">
 
   <Description about="urn:mozilla:install-manifest">
     <em:id>addon1@tests.mozilla.org</em:id>
     <em:version>1.0</em:version>
     <em:name>Test 1</em:name>
-    <em:updateURL>http://localhost:4444/data/test_bug655254.rdf</em:updateURL>
     <em:targetApplication>
       <Description>
         <em:id>xpcshell@tests.mozilla.org</em:id>
         <em:minVersion>1</em:minVersion>
         <em:maxVersion>1</em:maxVersion>
       </Description>
     </em:targetApplication>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/blocklistchange/addon_update1.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/blocklistchange/addon_update1.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/blocklistchange/addon_update1.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/blocklistchange/addon_update1.rdf
@@ -8,17 +8,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>2</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft1_2.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft1_2.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -28,17 +28,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>2</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft2_2.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft2_2.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -48,17 +48,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>2</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft3_2.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft3_2.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -68,17 +68,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>2</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft4_2.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft4_2.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -88,17 +88,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>2</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft5_2.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft5_2.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -108,17 +108,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>2</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_hard1_2.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_hard1_2.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -128,17 +128,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>2</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_regexp1_2.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_regexp1_2.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 </RDF:RDF>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/blocklistchange/addon_update2.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/blocklistchange/addon_update2.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/blocklistchange/addon_update2.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/blocklistchange/addon_update2.rdf
@@ -8,17 +8,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>3</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft1_3.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft1_3.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -28,17 +28,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>3</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft2_3.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft2_3.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -48,17 +48,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>3</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft3_3.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft3_3.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -68,17 +68,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>3</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft4_3.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft4_3.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -88,17 +88,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>3</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft5_3.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft5_3.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -108,17 +108,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>3</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_hard1_3.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_hard1_3.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -128,17 +128,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>3</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_regexp1_3.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_regexp1_3.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 </RDF:RDF>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/blocklistchange/addon_update3.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/blocklistchange/addon_update3.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/blocklistchange/addon_update3.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/blocklistchange/addon_update3.rdf
@@ -8,17 +8,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>4</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft1_1.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft1_1.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -28,17 +28,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>4</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft2_1.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft2_1.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -48,17 +48,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>4</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft3_1.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft3_1.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -68,17 +68,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>4</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft4_1.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft4_1.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -88,17 +88,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>4</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_soft5_1.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_soft5_1.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -108,17 +108,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>4</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_hard1_1.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_hard1_1.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -128,17 +128,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>4</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>*</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/blocklist_regexp1_1.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/blocklist_regexp1_1.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 </RDF:RDF>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository.xml b/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository.xml
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository.xml
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository.xml
@@ -4,142 +4,142 @@
   <addon>
     <name>PASS</name>
     <type id="1">Extension</type>
     <guid>test1@tests.mozilla.org</guid>
     <version>1.1</version>
     <authors>
       <author>
         <name>Test Creator 1</name>
-        <link>http://localhost:4444/creator1.html</link>
+        <link>http://localhost:%PORT%/creator1.html</link>
       </author>
     </authors>
     <status id="8">Preliminarily Reviewed</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
     <!-- Test that a negative rating is ignored -->
     <rating>-2</rating>
     <!-- Test that a <reviews> with a blank review URL is ignored -->
     <reviews num="   1111   ">   </reviews>
     <!-- Test that a negative total_downloads is ignored -->
     <total_downloads>-2</total_downloads>
-    <install>http://localhost:4444/test1.xpi</install>
+    <install>http://localhost:%PORT%/test1.xpi</install>
   </addon>
 
   <!-- Passes requirements. Tests optional attributes. Also tests that
        integer properties that are NaN in the XML are ignored -->
   <addon>
     <name>PASS</name>
     <!-- Test that extensions pass -->
     <type id="1">Extension</type>
     <guid>test2@tests.mozilla.org</guid>
     <version>1.2</version>
     <authors>
       <!-- Test that the first author becomes the creator,
            and the second one is a developer -->
       <author>
         <name>Test Creator 2</name>
-        <link>http://localhost:4444/creator2.html</link>
+        <link>http://localhost:%PORT%/creator2.html</link>
       </author>
       <author>
         <name>Test Developer 2</name>
-        <link>http://localhost:4444/developer2.html</link>
+        <link>http://localhost:%PORT%/developer2.html</link>
       </author>
     </authors>
     <summary>&lt;h1&gt;Test Summary 2&lt;/h1&gt;&lt;p&gt;paragraph&lt;/p&gt;</summary>
     <description>Test Description 2&lt;br&gt;newline</description>
     <developer_comments>Test Developer
                         Comments 2</developer_comments>
     <eula>Test EULA 2</eula>
-    <icon size="64">http://localhost:4444/icon2-64.png</icon>
-    <icon size="48">http://localhost:4444/icon2-48.png</icon>
-    <icon size="32">http://localhost:4444/icon2-32.png</icon>
+    <icon size="64">http://localhost:%PORT%/icon2-64.png</icon>
+    <icon size="48">http://localhost:%PORT%/icon2-48.png</icon>
+    <icon size="32">http://localhost:%PORT%/icon2-32.png</icon>
     <status id="4">Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
     <!-- Test that multiple preview images are correctly parsed -->
     <previews>
       <preview primary="0">
-        <full type="image/png">http://localhost:4444/full1-2.png</full>
-        <thumbnail type="image/png">http://localhost:4444/thumbnail1-2.png</thumbnail>
+        <full type="image/png">http://localhost:%PORT%/full1-2.png</full>
+        <thumbnail type="image/png">http://localhost:%PORT%/thumbnail1-2.png</thumbnail>
       </preview>
       <preview primary="0">
-        <full type="image/png">http://localhost:4444/full2-2.png</full>
-        <thumbnail type="image/png">http://localhost:4444/thumbnail2-2.png</thumbnail>
+        <full type="image/png">http://localhost:%PORT%/full2-2.png</full>
+        <thumbnail type="image/png">http://localhost:%PORT%/thumbnail2-2.png</thumbnail>
         <caption>Caption 2</caption>
       </preview>
     </previews>
     <rating>NaN</rating>
     <!-- Test that learnmore is used as the add-on's homepageURL
          if there is no homepage defined -->
-    <learnmore>http://localhost:4444/learnmore2.html</learnmore>
+    <learnmore>http://localhost:%PORT%/learnmore2.html</learnmore>
     <homepage/>
-    <support>http://localhost:4444/support2.html</support>
+    <support>http://localhost:%PORT%/support2.html</support>
     <contribution_data>
-      <link>http://localhost:4444/contribution2.html</link>
-      <meet_developers>http://localhost:4444/meetDevelopers2.html</meet_developers>
+      <link>http://localhost:%PORT%/contribution2.html</link>
+      <meet_developers>http://localhost:%PORT%/meetDevelopers2.html</meet_developers>
     </contribution_data>
-    <reviews num="NaN">http://localhost:4444/review2.html</reviews>
+    <reviews num="NaN">http://localhost:%PORT%/review2.html</reviews>
     <total_downloads>NaN</total_downloads>
     <weekly_downloads>NaN</weekly_downloads>
     <daily_users>NaN</daily_users>
     <last_updated epoch="NaN">Not an acual date</last_updated>
-    <install size="NaN" os="ALL">http://localhost:4444/test2.xpi</install>
+    <install size="NaN" os="ALL">http://localhost:%PORT%/test2.xpi</install>
   </addon>
 
   <!-- Passes requirements. Tests optional attributes with extra whitespace. -->
   <addon>
     <name>   PASS   </name>
     <!-- Test that themes pass -->
     <type id="   2   ">Theme</type>
     <guid>   test3@tests.mozilla.org   </guid>
     <version>   1.3   </version>
     <authors>
       <!-- Test that authors with blank names are ignored -->
       <author>
         <name>    </name>
-        <link>   http://localhost:4444/ignore3.html   </link>
+        <link>   http://localhost:%PORT%/ignore3.html   </link>
       </author>
       <!-- Test that authors with blank links are ignored -->
       <author>
         <name>   Test Creator Ignore   </name>
         <link>   </link>
       </author>
       <author>
         <name>   Test Creator 3   </name>
-        <link>   http://localhost:4444/creator3.html   </link>
+        <link>   http://localhost:%PORT%/creator3.html   </link>
       </author>
       <author>
         <name>   First Test Developer 3   </name>
-        <link>   http://localhost:4444/developer1-3.html   </link>
+        <link>   http://localhost:%PORT%/developer1-3.html   </link>
       </author>
       <author>
         <name>    </name>
         <link>    </link>
       </author>
       <author>
         <name>   Second Test Developer 3   </name>
-        <link>   http://localhost:4444/developer2-3.html   </link>
+        <link>   http://localhost:%PORT%/developer2-3.html   </link>
       </author>
     </authors>
     <summary>   Test Summary 3   </summary>
     <description>   Test Description 3&lt;br&gt;&lt;ul&gt;&lt;li&gt;List item 1&lt;li&gt;List item 2&lt;/ul&gt;   </description>
     <developer_comments>   Test Developer Comments 3   </developer_comments>
     <eula>   Test EULA 3   </eula>
-    <icon size="32">   http://localhost:4444/icon3.png   </icon>
+    <icon size="32">   http://localhost:%PORT%/icon3.png   </icon>
     <status id="   8   ">Preliminarily Reviewed</status>
     <!-- Test that an incompatible + compatible application list passes -->
     <compatible_applications>
       <application>
         <appID>   unknown@tests.mozilla.org   </appID>
         <min_version>   1   </min_version>
         <max_version>   1   </max_version>
       </application>
@@ -147,60 +147,60 @@
         <appID>   xpcshell@tests.mozilla.org   </appID>
         <min_version>   1   </min_version>
         <max_version>   1   </max_version>
       </application>
     </compatible_applications>
     <!-- Test that primary images appear first in the add-on's screenshots array -->
     <previews>
       <preview primary="   0   ">
-        <full type="   image/png   ">   http://localhost:4444/full2-3.png   </full>
+        <full type="   image/png   ">   http://localhost:%PORT%/full2-3.png   </full>
         <caption>   Caption 2 - 3   </caption>
       </preview>
       <!-- Test that a preview without a <full> element is ignored -->
       <preview primary="   0   ">
         <caption>   Caption ignore - 3   </caption>
       </preview>
       <!-- Test that a preview with an empty <full> element is ignored -->
       <preview primary="   0   ">
         <full type="   image/png   ">   </full>
         <caption>   Caption ignore - 3   </caption>
       <preview primary="   1   ">
-        <full type="   image/png   ">   http://localhost:4444/full1-3.png   </full>
-        <thumbnail type="   image/png   ">   http://localhost:4444/thumbnail1-3.png   </thumbnail>
+        <full type="   image/png   ">   http://localhost:%PORT%/full1-3.png   </full>
+        <thumbnail type="   image/png   ">   http://localhost:%PORT%/thumbnail1-3.png   </thumbnail>
         <caption>   Caption 1 - 3   </caption>
       </preview>
       <preview primary="   0   ">
-        <full type="   image/png   ">   http://localhost:4444/full3-3.png   </full>
-        <thumbnail type="   image/png   ">   http://localhost:4444/thumbnail3-3.png   </thumbnail>
+        <full type="   image/png   ">   http://localhost:%PORT%/full3-3.png   </full>
+        <thumbnail type="   image/png   ">   http://localhost:%PORT%/thumbnail3-3.png   </thumbnail>
         <caption>   Caption 3 - 3   </caption>
       </preview>
       </preview>
     </previews>
     <!-- Test that a rating between 1 and 5 is correctly parsed -->
     <rating>   2   </rating>
     <!-- Test that hompage is used as the add-on's homepageURL
          even if learnmore is defined -->
-    <learnmore>   http://localhost:4444/learnmore3.html   </learnmore>
-    <homepage>   http://localhost:4444/homepage3.html   </homepage>
-    <support>   http://localhost:4444/support3.html   </support>
+    <learnmore>   http://localhost:%PORT%/learnmore3.html   </learnmore>
+    <homepage>   http://localhost:%PORT%/homepage3.html   </homepage>
+    <support>   http://localhost:%PORT%/support3.html   </support>
     <contribution_data>
-      <link>   http://localhost:4444/contribution3.html   </link>
+      <link>   http://localhost:%PORT%/contribution3.html   </link>
       <suggested_amount currency="USD">   $11.11   </suggested_amount>
-      <meet_developers>   http://localhost:4444/meetDevelopers3.html   </meet_developers>
+      <meet_developers>   http://localhost:%PORT%/meetDevelopers3.html   </meet_developers>
     </contribution_data>
-    <reviews num="   1111   ">   http://localhost:4444/review3.html   </reviews>
+    <reviews num="   1111   ">   http://localhost:%PORT%/review3.html   </reviews>
     <total_downloads>   2222   </total_downloads>
     <weekly_downloads>   3333   </weekly_downloads>
     <daily_users>   4444   </daily_users>
     <last_updated epoch="   1265033045   ">   2010-02-01T14:04:05Z   </last_updated>
     <!-- Test that an incompatible install is ignored -->
-    <install size="   9999   " os="   UNKNOWN   ">   http://localhost:4444/fail3.xpi   </install>
+    <install size="   9999   " os="   UNKNOWN   ">   http://localhost:%PORT%/fail3.xpi   </install>
     <!-- Test that OS matching is case-insensitive -->
-    <install size="   5555   " os="   xpCShell   " hash="   sha1:c26f0b0d62e5dcddcda95074d3f3fedb9bbc26e3   ">   http://localhost:4444/test3.xpi   </install>
+    <install size="   5555   " os="   xpCShell   " hash="   sha1:c26f0b0d62e5dcddcda95074d3f3fedb9bbc26e3   ">   http://localhost:%PORT%/test3.xpi   </install>
   </addon>
 
   <!-- Fails because name is undefined -->
   <addon>
     <type id="1">Extension</type>
     <guid>test4@tests.mozilla.org</guid>
     <version>1.4</version>
     <authors><author><name>Test Creator 4</name></author></authors>
@@ -208,17 +208,17 @@
     <summary>Add-on with undefined name should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test4.xpi</install>
+    <install>http://localhost:%PORT%/test4.xpi</install>
   </addon>
 
   <!-- Fails because name is empty-->
   <addon>
     <name>   </name>
     <type id="1">Extension</type>
     <guid>test5@tests.mozilla.org</guid>
     <version>1.5</version>
@@ -227,17 +227,17 @@
     <summary>Add-on with empty name should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test5.xpi</install>
+    <install>http://localhost:%PORT%/test5.xpi</install>
   </addon>
 
   <!-- Fails because type is undefined -->
   <addon>
     <name>FAIL</name>
     <guid>test6@tests.mozilla.org</guid>
     <version>1.6</version>
     <authors><author><name>Test Creator 6</name></author></authors>
@@ -245,17 +245,17 @@
     <summary>Add-on with undefined type should be ignored</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test6.xpi</install>
+    <install>http://localhost:%PORT%/test6.xpi</install>
   </addon>
 
   <!-- Fails because type is empty -->
   <addon>
     <name>FAIL</name>
     <type id="">Empty id attribute</type>
     <guid>test7@tests.mozilla.org</guid>
     <version>1.7</version>
@@ -264,17 +264,17 @@
     <summary>Add-on with empty type should be ignored</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test7.xpi</install>
+    <install>http://localhost:%PORT%/test7.xpi</install>
   </addon>
 
   <!-- Fails because type is unknown -->
   <addon>
     <name>FAIL</name>
     <type id="9999">Unknown</type>
     <guid>test8@tests.mozilla.org</guid>
     <version>1.8</version>
@@ -283,17 +283,17 @@
     <summary>Add-on with unknown type should be ignored</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test8.xpi</install>
+    <install>http://localhost:%PORT%/test8.xpi</install>
   </addon>
 
   <!-- Fails because guid is undefined -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <version>1.9</version>
     <authors><author><name>Test Creator 9</name></author></authors>
@@ -301,17 +301,17 @@
     <summary>Add-on with undefined guid should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test9.xpi</install>
+    <install>http://localhost:%PORT%/test9.xpi</install>
   </addon>
 
   <!-- Fails because guid is empty -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>   </guid>
     <version>1.10</version>
@@ -320,17 +320,17 @@
     <summary>Add-on with empty guid should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test10.xpi</install>
+    <install>http://localhost:%PORT%/test10.xpi</install>
   </addon>
 
   <!-- Fails because guid matches previously successful result -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test1@tests.mozilla.org</guid>
     <version>1.11</version>
@@ -339,17 +339,17 @@
     <summary>Add-on with a guid that matches a previously successful result should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test11.xpi</install>
+    <install>http://localhost:%PORT%/test11.xpi</install>
   </addon>
 
   <!-- Fails because guid matches already installed add-on -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test_AddonRepository_1@tests.mozilla.org</guid>
     <version>1.12</version>
@@ -358,17 +358,17 @@
     <summary>Add-on with a guid that matches an installed Addon should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test12.xpi</install>
+    <install>http://localhost:%PORT%/test12.xpi</install>
   </addon>
 
   <!-- Fails because version is undefined -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test13@tests.mozilla.org</guid>
     <authors><author><name>Test Creator 13</name></author></authors>
@@ -376,17 +376,17 @@
     <summary>Add-on with undefined version should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test13.xpi</install>
+    <install>http://localhost:%PORT%/test13.xpi</install>
   </addon>
 
   <!-- Fails because version is empty -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test14@tests.mozilla.org</guid>
     <version>   </version>
@@ -395,17 +395,17 @@
     <summary>Add-on with empty version should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test14.xpi</install>
+    <install>http://localhost:%PORT%/test14.xpi</install>
   </addon>
 
   <!-- Fails because authors undefined -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test15@tests.mozilla.org</guid>
     <version>1.15</version>
@@ -413,17 +413,17 @@
     <summary>Add-on with undefined authors should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test15.xpi</install>
+    <install>http://localhost:%PORT%/test15.xpi</install>
   </addon>
 
   <!-- Fails because it has no defined author elements -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test16@tests.mozilla.org</guid>
     <version>1.16</version>
@@ -432,17 +432,17 @@
     <summary>Add-on with no defined author elements should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test16.xpi</install>
+    <install>http://localhost:%PORT%/test16.xpi</install>
   </addon>
 
   <!-- Fails because no non-empty author elements -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test17@tests.mozilla.org</guid>
     <version>1.17</version>
@@ -454,17 +454,17 @@
     <summary>Add-on with no non-empty author elements should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test17.xpi</install>
+    <install>http://localhost:%PORT%/test17.xpi</install>
   </addon>
 
   <!-- Fails because status is undefined -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test18@tests.mozilla.org</guid>
     <version>1.18</version>
@@ -472,17 +472,17 @@
     <summary>Add-on with undefined status should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test18.xpi</install>
+    <install>http://localhost:%PORT%/test18.xpi</install>
   </addon>
 
   <!-- Fails because status is not Public -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test19@tests.mozilla.org</guid>
     <version>1.19</version>
@@ -491,29 +491,29 @@
     <summary>Add-on with non-Public status should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test19.xpi</install>
+    <install>http://localhost:%PORT%/test19.xpi</install>
   </addon>
 
   <!-- Fails because compatible_applications is undefined -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test20@tests.mozilla.org</guid>
     <version>1.20</version>
     <authors><author><name>Test Creator 20</name></author></authors>
     <status id="4">Public</status>
     <summary>Add-on with undefined compatible_applications should be ignored.</summary>
-    <install>http://localhost:4444/test20.xpi</install>
+    <install>http://localhost:%PORT%/test20.xpi</install>
   </addon>
 
   <!-- Fails because no compatible applications matched -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test21@tests.mozilla.org</guid>
     <version>1.21</version>
@@ -522,17 +522,17 @@
     <summary>Add-on with no compatible applications should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>unknown@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test21.xpi</install>
+    <install>http://localhost:%PORT%/test21.xpi</install>
   </addon>
 
   <!-- Fails because compatible application's min version is undefined -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test22@tests.mozilla.org</guid>
     <version>1.22</version>
@@ -540,17 +540,17 @@
     <status id="4">Public</status>
     <summary>Add-on with too high of a compatible application min version should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <max_version>2.0</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test22.xpi</install>
+    <install>http://localhost:%PORT%/test22.xpi</install>
   </addon>
 
   <!-- Fails because compatible application's min version too high -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test23@tests.mozilla.org</guid>
     <version>1.23</version>
@@ -559,17 +559,17 @@
     <summary>Add-on with too high of a compatible application min version should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1.1</min_version>
         <max_version>2.0</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test23.xpi</install>
+    <install>http://localhost:%PORT%/test23.xpi</install>
   </addon>
 
   <!-- Fails because compatible application's max version is undefined -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test24@tests.mozilla.org</guid>
     <version>1.24</version>
@@ -577,17 +577,17 @@
     <status id="4">Public</status>
     <summary>Add-on with too low of a compatible application max version should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>0.9</min_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test24.xpi</install>
+    <install>http://localhost:%PORT%/test24.xpi</install>
   </addon>
 
   <!-- Fails because compatible application's max version is too low -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test25@tests.mozilla.org</guid>
     <version>1.25</version>
@@ -596,17 +596,17 @@
     <summary>Add-on with too low of a compatible application max version should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>0.9</min_version>
         <max_version>0.9.9</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test25.xpi</install>
+    <install>http://localhost:%PORT%/test25.xpi</install>
   </addon>
 
   <!-- Fails because XPI URL is undefined -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test26@tests.mozilla.org</guid>
     <version>1.26</version>
@@ -652,18 +652,18 @@
     <summary>Add-on with no installs with compatible OS should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install os="UNKNOWN1">http://localhost:4444/test28.xpi</install>
-    <install os="UNKNOWN2">http://localhost:4444/test28.xpi</install>
+    <install os="UNKNOWN1">http://localhost:%PORT%/test28.xpi</install>
+    <install os="UNKNOWN2">http://localhost:%PORT%/test28.xpi</install>
   </addon>
 
   <!-- Fails because XPI URL matches an installing AddonInstall -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test29@tests.mozilla.org</guid>
     <version>1.29</version>
@@ -672,134 +672,134 @@
     <summary>Add-on with an XPI URL that matches an installing AddonInstall should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/addons/test_AddonRepository_2.xpi</install>
+    <install>http://localhost:%PORT%/addons/test_AddonRepository_2.xpi</install>
   </addon>
 
   <!-- Passes because the add-on has the right payment info -->
   <addon>
     <name>PASS</name>
     <type id="1">Extension</type>
     <guid>purchase1@tests.mozilla.org</guid>
     <version>2.0</version>
     <authors>
       <author>
         <name>Test Creator - Last Passing</name>
-        <link>http://localhost:4444/creatorLastPassing.html</link>
+        <link>http://localhost:%PORT%/creatorLastPassing.html</link>
       </author>
     </authors>
     <status id="4">Public</status>
     <all_compatible_os>
       <os>ALL</os>
     </all_compatible_os>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
     <rating>5</rating>
     <payment_data>
-      <link>http://localhost:4444/purchaseURL1</link>
+      <link>http://localhost:%PORT%/purchaseURL1</link>
       <amount amount="5">$5</amount>
     </payment_data>
   </addon>
 
   <!-- Passes because the add-on has the right payment info -->
   <addon>
     <name>PASS</name>
     <type id="1">Extension</type>
     <guid>purchase2@tests.mozilla.org</guid>
     <version>2.0</version>
     <authors>
       <author>
         <name>Test Creator - Last Passing</name>
-        <link>http://localhost:4444/creatorLastPassing.html</link>
+        <link>http://localhost:%PORT%/creatorLastPassing.html</link>
       </author>
     </authors>
     <status id="4">Public</status>
     <all_compatible_os>
       <os>XPCShell</os>
     </all_compatible_os>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
     <rating>5</rating>
     <payment_data>
-      <link>http://localhost:4444/purchaseURL2</link>
+      <link>http://localhost:%PORT%/purchaseURL2</link>
       <amount amount="10.0">$10</amount>
     </payment_data>
   </addon>
 
   <!-- Fails because the add-on doesn't match the platform -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>purchase3@tests.mozilla.org</guid>
     <version>2.0</version>
     <authors>
       <author>
         <name>Test Creator - Last Passing</name>
-        <link>http://localhost:4444/creatorLastPassing.html</link>
+        <link>http://localhost:%PORT%/creatorLastPassing.html</link>
       </author>
     </authors>
     <status id="4">Public</status>
     <all_compatible_os>
       <os>FOO</os>
     </all_compatible_os>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
     <rating>5</rating>
     <payment_data>
-      <link>http://localhost:4444/purchaseURL3</link>
+      <link>http://localhost:%PORT%/purchaseURL3</link>
       <amount amount="10">$10</amount>
     </payment_data>
   </addon>
 
   <!-- Passes because the Addon that has a matching XPI URL
        has a state = STATE_AVAILABLE (non-active install). This is the
        last passing add-on. -->
   <addon>
     <name>PASS</name>
     <type id="1">Extension</type>
     <guid>test-lastPassing@tests.mozilla.org</guid>
     <version>2.0</version>
     <authors>
       <author>
         <name>Test Creator - Last Passing</name>
-        <link>http://localhost:4444/creatorLastPassing.html</link>
+        <link>http://localhost:%PORT%/creatorLastPassing.html</link>
       </author>
     </authors>
     <status id="4">Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
     <!-- Test that a rating > 5 becomes a rating = 5 -->
     <rating>10</rating>
-    <install>http://localhost:4444/addons/test_AddonRepository_3.xpi</install>
+    <install>http://localhost:%PORT%/addons/test_AddonRepository_3.xpi</install>
   </addon>
 
   <!-- Fails because of MAX_RESULTS limit. The previous <addon> should
        be the last passing add-on in order to correctly test the limit. -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>test-surpassesLimit@tests.mozilla.org</guid>
@@ -809,12 +809,12 @@
     <summary>Add-on should not be added because doing so would surpass MAX_RESULTS limit</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test-surpassesLimit.xpi</install>
+    <install>http://localhost:%PORT%/test-surpassesLimit.xpi</install>
   </addon>
 </searchresults>
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_cache.xml b/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_cache.xml
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_cache.xml
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_cache.xml
@@ -19,28 +19,28 @@
         <link>http://localhost:4444/repo/1/secondDeveloper.html</link>
       </author>
     </authors>
     <summary>Repo Add-on 1 - Description&lt;br&gt;Second line</summary>
     <description>&lt;p&gt;Repo Add-on 1 - Full Description &amp;amp; some extra&lt;/p&gt;</description>
     <eula>Repo Add-on 1 - EULA</eula>
     <developer_comments>Repo Add-on 1
                         Developer Comments</developer_comments>
-    <icon size="32">http://localhost:4444/repo/1/icon.png</icon>
+    <icon size="32">http://localhost/repo/1/icon.png</icon>
     <status id="4">Public</status>
     <rating>1</rating>
-    <learnmore>http://localhost:4444/repo/1/learnmore.html</learnmore>
-    <homepage>http://localhost:4444/repo/1/homepage.html</homepage>
-    <support>http://localhost:4444/repo/1/support.html</support>
+    <learnmore>http://localhost/repo/1/learnmore.html</learnmore>
+    <homepage>http://localhost/repo/1/homepage.html</homepage>
+    <support>http://localhost/repo/1/support.html</support>
     <contribution_data>
-      <link>http://localhost:4444/repo/1/contribution.html</link>
+      <link>http://localhost/repo/1/contribution.html</link>
       <suggested_amount currency="USD">$11.11</suggested_amount>
-      <meet_developers>http://localhost:4444/repo/1/meetDevelopers.html</meet_developers>
+      <meet_developers>http://localhost/repo/1/meetDevelopers.html</meet_developers>
     </contribution_data>
-    <reviews num="1111">http://localhost:4444/repo/1/review.html</reviews>
+    <reviews num="1111">http://localhost/repo/1/review.html</reviews>
     <total_downloads>2221</total_downloads>
     <weekly_downloads>3331</weekly_downloads>
     <daily_users>4441</daily_users>
     <last_updated epoch="9">1970-01-01T00:00:09Z</last_updated>
     <install size="9">http://localhost:4444/repo/1/install.xpi</install>
   </addon>
 
   <addon>
@@ -61,52 +61,52 @@
         <name>Repo Add-on 2 - Second Developer</name>
         <link>http://localhost:4444/repo/2/secondDeveloper.html</link>
       </author>
     </authors>
     <summary>Repo Add-on 2 - Description</summary>
     <description>Repo Add-on 2 - Full Description</description>
     <eula>Repo Add-on 2 - EULA</eula>
     <developer_comments>Repo Add-on 2 - Developer Comments</developer_comments>
-    <icon size="32">http://localhost:4444/repo/2/icon.png</icon>
+    <icon size="32">http://localhost/repo/2/icon.png</icon>
     <status id="9">Unknown</status>
     <previews>
       <preview primary="1">
         <full type="image/png">http://localhost:4444/repo/2/firstFull.png</full>
         <thumbnail type="image/png">http://localhost:4444/repo/2/firstThumbnail.png</thumbnail>
         <caption>Repo Add-on 2 - First Caption</caption>
       </preview>
       <preview primary="0">
         <full type="image/png">http://localhost:4444/repo/2/secondFull.png</full>
         <thumbnail type="image/png">http://localhost:4444/repo/2/secondThumbnail.png</thumbnail>
         <caption>Repo Add-on 2 - Second Caption</caption>
       </preview>
     </previews>
     <rating>2</rating>
-    <learnmore>http://localhost:4444/repo/2/learnmore.html</learnmore>
-    <homepage>http://localhost:4444/repo/2/homepage.html</homepage>
-    <support>http://localhost:4444/repo/2/support.html</support>
+    <learnmore>http://localhost/repo/2/learnmore.html</learnmore>
+    <homepage>http://localhost/repo/2/homepage.html</homepage>
+    <support>http://localhost/repo/2/support.html</support>
     <contribution_data>
-      <link>http://localhost:4444/repo/2/contribution.html</link>
-      <meet_developers>http://localhost:4444/repo/2/meetDevelopers.html</meet_developers>
+      <link>http://localhost/repo/2/contribution.html</link>
+      <meet_developers>http://localhost/repo/2/meetDevelopers.html</meet_developers>
     </contribution_data>
-    <reviews num="1112">http://localhost:4444/repo/2/review.html</reviews>
+    <reviews num="1112">http://localhost/repo/2/review.html</reviews>
     <total_downloads>2222</total_downloads>
     <weekly_downloads>3332</weekly_downloads>
     <daily_users>4442</daily_users>
     <last_updated epoch="9">1970-01-01T00:00:09Z</last_updated>
     <install size="9">http://localhost:4444/repo/2/install.xpi</install>
   </addon>
 
   <addon>
     <name>Repo Add-on 3</name>
     <type id="9999">Unknown</type>
     <guid>test_AddonRepository_3@tests.mozilla.org</guid>
     <version>2.3</version>
-    <icon size="32">http://localhost:4444/repo/3/icon.png</icon>
+    <icon size="32">http://localhost/repo/3/icon.png</icon>
     <previews>
       <preview primary="1">
         <full type="image/png">http://localhost:4444/repo/3/firstFull.png</full>
         <thumbnail type="image/png">http://localhost:4444/repo/3/firstThumbnail.png</thumbnail>
         <caption>Repo Add-on 3 - First Caption</caption>
       </preview>
       <preview primary="0">
         <full type="image/png">http://localhost:4444/repo/3/secondFull.png</full>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_compatmode_ignore.xml b/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_compatmode_ignore.xml
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_compatmode_ignore.xml
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_compatmode_ignore.xml
@@ -3,21 +3,21 @@
   <addon>
     <name>Test Repo Add-on - ignore</name>
     <type id="1">Extension</type>
     <guid>compatmode-ignore@tests.mozilla.org</guid>
     <version>1.1</version>
     <authors>
       <author>
         <name>Test Creator 1</name>
-        <link>http://localhost:4444/creator1.html</link>
+        <link>http://localhost:%PORT%/creator1.html</link>
       </author>
     </authors>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test1.xpi</install>
+    <install>http://localhost:%PORT%/test1.xpi</install>
   </addon>
 </searchresults>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_compatmode_normal.xml b/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_compatmode_normal.xml
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_compatmode_normal.xml
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_compatmode_normal.xml
@@ -3,21 +3,21 @@
   <addon>
     <name>Test Repo Add-on - normal</name>
     <type id="1">Extension</type>
     <guid>compatmode-normal@tests.mozilla.org</guid>
     <version>1.1</version>
     <authors>
       <author>
         <name>Test Creator 1</name>
-        <link>http://localhost:4444/creator1.html</link>
+        <link>http://localhost:%PORT%/creator1.html</link>
       </author>
     </authors>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test1.xpi</install>
+    <install>http://localhost:%PORT%/test1.xpi</install>
   </addon>
 </searchresults>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_compatmode_strict.xml b/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_compatmode_strict.xml
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_compatmode_strict.xml
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_compatmode_strict.xml
@@ -3,21 +3,21 @@
   <addon>
     <name>Test Repo Add-on - strict</name>
     <type id="1">Extension</type>
     <guid>compatmode-strict@tests.mozilla.org</guid>
     <version>1.1</version>
     <authors>
       <author>
         <name>Test Creator 1</name>
-        <link>http://localhost:4444/creator1.html</link>
+        <link>http://localhost:%PORT%/creator1.html</link>
       </author>
     </authors>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test1.xpi</install>
+    <install>http://localhost:%PORT%/test1.xpi</install>
   </addon>
 </searchresults>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_failed.xml b/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_failed.xml
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_failed.xml
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_failed.xml
@@ -10,12 +10,12 @@
     <status id="4">Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test1.xpi</install>
+    <install>http://localhost:%PORT%/test1.xpi</install>
   </addon>
 </searchresults>
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_getAddonsByIDs.xml b/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_getAddonsByIDs.xml
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_getAddonsByIDs.xml
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_AddonRepository_getAddonsByIDs.xml
@@ -5,66 +5,66 @@
   <addon>
     <name>PASS</name>
     <type id="1">Extension</type>
     <guid>test1@tests.mozilla.org</guid>
     <version>1.1</version>
     <authors>
       <author>
         <name>Test Creator 1</name>
-        <link>http://localhost:4444/creator1.html</link>
+        <link>http://localhost:%PORT%/creator1.html</link>
       </author>
       <author>
         <name>Test Developer 1</name>
-        <link>http://localhost:4444/developer1.html</link>
+        <link>http://localhost:%PORT%/developer1.html</link>
       </author>
     </authors>
     <summary>Test Summary 1</summary>
     <description>Test Description 1</description>
     <eula>Test EULA 1</eula>
     <developer_comments>Test Developer Comments 1</developer_comments>
-    <icon size="32">http://localhost:4444/icon1.png</icon>
+    <icon size="32">http://localhost:%PORT%/icon1.png</icon>
     <status id="8">Preliminarily Reviewed</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
     <previews>
       <preview primary="1">
         <full type="image/png" width="400" height="300">
-          http://localhost:4444/full1-1.png
+          http://localhost:%PORT%/full1-1.png
         </full>
         <thumbnail type="image/png" width="200" height="150">
-          http://localhost:4444/thumbnail1-1.png
+          http://localhost:%PORT%/thumbnail1-1.png
         </thumbnail>
         <caption>Caption 1 - 1</caption>
       </preview>
       <preview primary="0">
-        <full type="image/png">http://localhost:4444/full2-1.png</full>
-        <thumbnail type="image/png">http://localhost:4444/thumbnail2-1.png</thumbnail>
+        <full type="image/png">http://localhost:%PORT%/full2-1.png</full>
+        <thumbnail type="image/png">http://localhost:%PORT%/thumbnail2-1.png</thumbnail>
         <caption>Caption 2 - 1</caption>
       </preview>
     </previews>
     <rating>4</rating>
-    <learnmore>http://localhost:4444/learnmore1.html</learnmore>
-    <support>http://localhost:4444/support1.html</support>
+    <learnmore>http://localhost:%PORT%/learnmore1.html</learnmore>
+    <support>http://localhost:%PORT%/support1.html</support>
     <contribution_data>
-      <link>http://localhost:4444/contribution1.html</link>
+      <link>http://localhost:%PORT%/contribution1.html</link>
       <suggested_amount currency="USD">$11.11</suggested_amount>
-      <meet_developers>http://localhost:4444/meetDevelopers1.html</meet_developers>
+      <meet_developers>http://localhost:%PORT%/meetDevelopers1.html</meet_developers>
     </contribution_data>
-    <reviews num="1111">http://localhost:4444/review1.html</reviews>
+    <reviews num="1111">http://localhost:%PORT%/review1.html</reviews>
     <total_downloads>2222</total_downloads>
     <weekly_downloads>3333</weekly_downloads>
     <daily_users>4444</daily_users>
     <last_updated epoch="1265033045">2010-02-01T14:04:05Z</last_updated>
-    <install size="5555">http://localhost:4444/addons/test_AddonRepository_2.xpi</install>
+    <install size="5555">http://localhost:%PORT%/addons/test_AddonRepository_2.xpi</install>
   </addon>
 
   <addon_compatibility hosted="true" id="123">
     <guid>test1@tests.mozilla.org</guid>
     <name>PASS</name>
     <version_ranges>
       <!-- Will be included -->
       <version_range type="incompatible">
@@ -136,17 +136,17 @@
     <summary>Add-on with a guid that matches a previously successful result should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test2.xpi</install>
+    <install>http://localhost:%PORT%/test2.xpi</install>
   </addon>
 
   <!-- Fails because guid was not requested -->
   <addon>
     <name>FAIL</name>
     <type id="1">Extension</type>
     <guid>notRequested@tests.mozilla.org</guid>
     <version>1.3</version>
@@ -155,17 +155,17 @@
     <summary>Add-on with a guid that wasn't requested should be ignored.</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test3.xpi</install>
+    <install>http://localhost:%PORT%/test3.xpi</install>
   </addon>
 
   <!-- Passes even though guid matches already installed add-on,
        type is unknown, no defined author elements, status is not Public,
        no compatible applications matched, no installs compatible with OS
    -->
   <addon>
     <name>PASS</name>
@@ -175,13 +175,13 @@
     <status id="9999">Unknown</status>
     <compatible_applications>
       <application>
         <appID>unknown@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install os="UNKNOWN1">http://localhost:4444/test4.xpi</install>
-    <install os="UNKNOWN2">http://localhost:4444/test4.xpi</install>
+    <install os="UNKNOWN1">http://localhost:%PORT%/test4.xpi</install>
+    <install os="UNKNOWN2">http://localhost:%PORT%/test4.xpi</install>
   </addon>
 </searchresults>
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_backgroundupdate.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_backgroundupdate.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_backgroundupdate.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_backgroundupdate.rdf
@@ -10,17 +10,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>2</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>1</em:maxVersion>
-                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/broken.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -31,17 +31,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>2</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>1</em:maxVersion>
-                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/broken.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
@@ -52,17 +52,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>2</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>1</em:maxVersion>
-                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/broken.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_bug424262.xml b/toolkit/mozapps/extensions/test/xpcshell/data/test_bug424262.xml
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_bug424262.xml
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_bug424262.xml
@@ -3,183 +3,183 @@
   <addon>
     <name>TEST</name>
     <type id='1'>Extension</type>
     <guid>test1@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>TEST</name>
     <rating>-5</rating>
     <type id='1'>Extension</type>
     <guid>test2@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>TEST</name>
     <rating>0</rating>
     <type id='1'>Extension</type>
     <guid>test3@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>TEST</name>
     <rating>2</rating>
     <type id='1'>Extension</type>
     <guid>test4@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>TEST</name>
     <rating>4</rating>
     <type id='1'>Extension</type>
     <guid>test5@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>TEST</name>
     <rating>5</rating>
     <type id='1'>Extension</type>
     <guid>test6@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>TEST</name>
     <rating>10</rating>
     <type id='1'>Extension</type>
     <guid>test7@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>TEST</name>
     <rating>100</rating>
     <type id='1'>Extension</type>
     <guid>test8@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 </searchresults>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_1.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_1.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_1.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_1.rdf
@@ -9,17 +9,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>1</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>unknown@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>2</em:maxVersion>
-                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/broken.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_2.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_2.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_2.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_2.rdf
@@ -9,17 +9,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>1</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>1</em:maxVersion>
-                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/broken.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_3.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_3.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_3.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_3.rdf
@@ -9,17 +9,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>1</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>1</em:maxVersion>
-                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/broken.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_4.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_4.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_4.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_4.rdf
@@ -9,17 +9,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>1</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>toolkit@mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>2</em:maxVersion>
-                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/broken.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_5.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_5.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_5.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_bug470377/update_5.rdf
@@ -9,17 +9,17 @@
         <RDF:li>
           <RDF:Description>
             <em:version>1</em:version>
             <em:targetApplication>
               <RDF:Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>3</em:maxVersion>
-                <em:updateLink>http://localhost:4444/broken.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/broken.xpi</em:updateLink>
               </RDF:Description>
             </em:targetApplication>
           </RDF:Description>
         </RDF:li>
       </RDF:Seq>
     </em:updates>
   </RDF:Description>
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_bug554133.xml b/toolkit/mozapps/extensions/test/xpcshell/data/test_bug554133.xml
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_bug554133.xml
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_bug554133.xml
@@ -3,290 +3,290 @@
   <addon>
     <name>PASS</name>
     <type id='1'>Extension</type>
     <guid>test1@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>FAIL</name>
     <type id='1'>Extension</type>
     <guid>test2@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <summary>Should not return an incompatible add-on</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>2</min_version>
         <max_version>2</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>PASS</name>
     <type id='1'>Extension</type>
     <guid>test3@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>FAIL</name>
     <type id='1'>Extension</type>
     <guid>test4@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <summary>Should not return an add-on for a different OS</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install os="UNKNOWN">http://localhost:4444/test.xpi</install>
+    <install os="UNKNOWN">http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>PASS</name>
     <type id='1'>Extension</type>
     <guid>test5@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>FAIL</name>
     <type id='1'>Extension</type>
     <guid>test5@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <summary>Should not include the same result twice</summary>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>PASS</name>
     <type id='1'>Extension</type>
     <guid>test6@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>PASS</name>
     <type id='1'>Extension</type>
     <guid>test7@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>PASS</name>
     <type id='1'>Extension</type>
     <guid>test8@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>PASS</name>
     <type id='1'>Extension</type>
     <guid>test9@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>PASS</name>
     <type id='1'>Extension</type>
     <guid>test10@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>PASS</name>
     <type id='1'>Extension</type>
     <guid>test11@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 
   <addon>
     <name>PASS</name>
     <type id='1'>Extension</type>
     <guid>test12@tests.mozilla.org</guid>
     <version>1.0</version>
     <authors>
       <author>
         <name>Test Creator</name>
-        <link>http://localhost:4444/creator.html</link>
+        <link>http://localhost:%PORT%/creator.html</link>
       </author>
     </authors>
     <status id='4'>Public</status>
     <compatible_applications>
       <application>
         <appID>xpcshell@tests.mozilla.org</appID>
         <min_version>1</min_version>
         <max_version>1</max_version>
       </application>
     </compatible_applications>
-    <install>http://localhost:4444/test.xpi</install>
+    <install>http://localhost:%PORT%/test.xpi</install>
   </addon>
 </searchresults>
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_dictionary.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_dictionary.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_dictionary.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_dictionary.rdf
@@ -9,17 +9,17 @@
         <li>
           <Description>
             <em:version>2.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>1</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_dictionary_3.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_dictionary_3.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
 
@@ -29,17 +29,17 @@
         <li>
           <Description>
             <em:version>2.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>1</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_dictionary_4.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_dictionary_4.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
 
@@ -49,17 +49,17 @@
         <li>
           <Description>
             <em:version>2.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>1</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_dictionary_5.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_dictionary_5.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
 </RDF>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_hotfix_1.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_hotfix_1.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_hotfix_1.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_hotfix_1.rdf
@@ -9,17 +9,17 @@
         <li>
           <Description>
             <em:version>1.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>1</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_hotfix_1.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_hotfix_1.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_hotfix_2.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_hotfix_2.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_hotfix_2.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_hotfix_2.rdf
@@ -9,17 +9,17 @@
         <li>
           <Description>
             <em:version>2.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>1</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_hotfix_2.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_hotfix_2.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_hotfix_3.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_hotfix_3.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_hotfix_3.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_hotfix_3.rdf
@@ -9,17 +9,17 @@
         <li>
           <Description>
             <em:version>3.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>2</em:minVersion>
                 <em:maxVersion>2</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_hotfix_3.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_hotfix_3.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_migrate4.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_migrate4.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_migrate4.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_migrate4.rdf
@@ -28,17 +28,17 @@
         <li>
           <Description>
             <em:version>2.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>0</em:minVersion>
                 <em:maxVersion>2</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_migrate4_6.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_migrate4_6.xpi</em:updateLink>
                 <em:updateInfoURL>http://example.com/updateInfo.xhtml</em:updateInfoURL>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_update.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_update.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_update.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_update.rdf
@@ -34,17 +34,17 @@
         <li>
           <Description>
             <em:version>2.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>1</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_update.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_update.xpi</em:updateLink>
                 <em:updateInfoURL>http://example.com/updateInfo.xhtml</em:updateInfoURL>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
@@ -131,17 +131,17 @@
         <li>
           <Description>
             <em:version>2.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>1</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_update8.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_update8.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
 
@@ -151,59 +151,59 @@
         <li>
           <Description>
             <em:version>2.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>1</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_update9_2.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_update9_2.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
         <!-- Incompatible when strict compatibility is enabled -->
         <li>
           <Description>
             <em:version>3.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>0.9</em:minVersion>
                 <em:maxVersion>0.9</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_update9_3.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_update9_3.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
         <!-- Incompatible due to compatibility override -->
         <li>
           <Description>
             <em:version>4.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>0.9</em:minVersion>
                 <em:maxVersion>0.9</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_update9_4.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_update9_4.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
         <!-- Addon for future version of app -->
         <li>
           <Description>
             <em:version>5.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>5</em:minVersion>
                 <em:maxVersion>6</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_update9_5.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_update9_5.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
 
@@ -213,17 +213,17 @@
         <li>
           <Description>
             <em:version>1.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>0.1</em:minVersion>
                 <em:maxVersion>0.4</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_update10.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_update10.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
 
@@ -234,17 +234,17 @@
           <Description>
             <em:version>2.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>0.1</em:minVersion>
                 <em:maxVersion>0.2</em:maxVersion>
                 <em:strictCompatibility>true</em:strictCompatibility>
-                <em:updateLink>http://localhost:4444/addons/test_update11.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_update11.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
 
@@ -254,17 +254,17 @@
         <li>
           <Description>
             <em:version>2.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>1</em:maxVersion>
-                <em:updateLink>http://localhost:4444/addons/test_update12.xpi</em:updateLink>
+                <em:updateLink>http://localhost:%PORT%/addons/test_update12.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
 </RDF>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_updatecompatmode_ignore.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_updatecompatmode_ignore.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_updatecompatmode_ignore.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_updatecompatmode_ignore.rdf
@@ -10,17 +10,17 @@
         <li>
           <Description>
             <em:version>2.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>2</em:maxVersion>
-                <em:updateLink>https://localhost:4444/addons/test1.xpi</em:updateLink>
+                <em:updateLink>https://localhost:%PORT%/addons/test1.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
 </RDF>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_updatecompatmode_normal.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_updatecompatmode_normal.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_updatecompatmode_normal.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_updatecompatmode_normal.rdf
@@ -10,17 +10,17 @@
         <li>
           <Description>
             <em:version>2.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>2</em:maxVersion>
-                <em:updateLink>https://localhost:4444/addons/test1.xpi</em:updateLink>
+                <em:updateLink>https://localhost:%PORT%/addons/test1.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
 </RDF>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/data/test_updatecompatmode_strict.rdf b/toolkit/mozapps/extensions/test/xpcshell/data/test_updatecompatmode_strict.rdf
--- a/toolkit/mozapps/extensions/test/xpcshell/data/test_updatecompatmode_strict.rdf
+++ b/toolkit/mozapps/extensions/test/xpcshell/data/test_updatecompatmode_strict.rdf
@@ -10,17 +10,17 @@
         <li>
           <Description>
             <em:version>2.0</em:version>
             <em:targetApplication>
               <Description>
                 <em:id>xpcshell@tests.mozilla.org</em:id>
                 <em:minVersion>1</em:minVersion>
                 <em:maxVersion>2</em:maxVersion>
-                <em:updateLink>https://localhost:4444/addons/test1.xpi</em:updateLink>
+                <em:updateLink>https://localhost:%PORT%/addons/test1.xpi</em:updateLink>
               </Description>
             </em:targetApplication>
           </Description>
         </li>
       </Seq>
     </em:updates>
   </Description>
 </RDF>
diff --git a/toolkit/mozapps/extensions/test/xpcshell/head_addons.js b/toolkit/mozapps/extensions/test/xpcshell/head_addons.js
--- a/toolkit/mozapps/extensions/test/xpcshell/head_addons.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/head_addons.js
@@ -22,16 +22,19 @@ Components.utils.import("resource://gre/
 Components.utils.import("resource://gre/modules/FileUtils.jsm");
 Components.utils.import("resource://gre/modules/Services.jsm");
 Components.utils.import("resource://gre/modules/NetUtil.jsm");
 
 var gInternalManager = null;
 var gAppInfo = null;
 var gAddonsList;
 
+var gPort = null;
+var gUrlToFileMap = {};
+
 var TEST_UNPACKED = false;
 
 function isNightlyChannel() {
   var channel = "default";
   try {
     channel = Services.prefs.getCharPref("app.update.channel");
   }
   catch (e) { }
@@ -272,17 +275,17 @@ function do_check_addon(aActualAddon, aE
           do_check_compatibilityoverride(actualValue[i], expectedValue[i]);
         break;
 
       case "icons":
         do_check_icons(actualValue, expectedValue);
         break;
 
       default:
-        if (actualValue !== expectedValue)
+        if (remove_port(actualValue) !== remove_port(expectedValue))
           do_throw("Failed for " + aProperty + " for add-on " + aExpectedAddon.id +
                    " (" + actualValue + " === " + expectedValue + ")");
     }
   });
 }
 
 /**
  * Check that the actual author is the same as the expected author.
@@ -332,17 +335,17 @@ function do_check_compatibilityoverride(
   do_check_eq(aActual.maxVersion, aExpected.maxVersion);
   do_check_eq(aActual.appID, aExpected.appID);
   do_check_eq(aActual.appMinVersion, aExpected.appMinVersion);
   do_check_eq(aActual.appMaxVersion, aExpected.appMaxVersion);
 }
 
 function do_check_icons(aActual, aExpected) {
   for (var size in aExpected) {
-    do_check_eq(aActual[size], aExpected[size]);
+    do_check_eq(remove_port(aActual[size]), remove_port(aExpected[size]));
   }
 }
 
 /**
  * Starts up the add-on manager as if it was started by the application.
  *
  * @param  aAppChanged
  *         An optional boolean parameter to simulate the case where the
@@ -1310,16 +1313,80 @@ do_register_cleanup(function addon_clean
   try {
     Services.prefs.clearUserPref(PREF_EM_CHECK_UPDATE_SECURITY);
   } catch (e) {}
   try {
     Services.prefs.clearUserPref(PREF_EM_STRICT_COMPATIBILITY);
   } catch (e) {}
 });
 
+/**
+ * Handler function that responds with the interpolated
+ * static file associated to the URL specified by request.path.
+ * This replaces the %PORT% entries in the file with the actual
+ * value of the running server's port (stored in gPort).
+ */
+function interpolateAndServeFile(request, response) {
+  try {
+    let file = gUrlToFileMap[request.path];
+    var data = "";
+    var fstream = Components.classes["@mozilla.org/network/file-input-stream;1"].
+    createInstance(Components.interfaces.nsIFileInputStream);
+    var cstream = Components.classes["@mozilla.org/intl/converter-input-stream;1"].
+    createInstance(Components.interfaces.nsIConverterInputStream);
+    fstream.init(file, -1, 0, 0);
+    cstream.init(fstream, "UTF-8", 0, 0);
+
+    let (str = {}) {
+      let read = 0;
+      do {
+        // read as much as we can and put it in str.value
+        read = cstream.readString(0xffffffff, str);
+        data += str.value;
+      } while (read != 0);
+    }
+    data = data.replace(/%PORT%/g, gPort);
+
+    response.write(data);
+  } catch (e) {
+    do_throw("Exception while serving interpolated file.");
+  } finally {
+    cstream.close(); // this closes fstream as well
+  }
+}
+
+/**
+ * Sets up a path handler for the given URL and saves the
+ * corresponding file in the global url -> file map.
+ *
+ * @param  url
+ *         the actual URL
+ * @param  file
+ *         nsILocalFile representing a static file
+ */
+function mapUrlToFile(url, file, server) {
+  server.registerPathHandler(url, interpolateAndServeFile);
+  gUrlToFileMap[url] = file;
+}
+
+function mapFile(path, server) {
+  mapUrlToFile(path, do_get_file(path), server);
+}
+
+/**
+ * Take out the port number in an URL
+ *
+ * @param url
+ *        String that represents an URL with a port number in it
+ */
+function remove_port(url) {
+  if (typeof url === "string")
+    return url.replace(/:\d+/, "");
+  return url;
+}
 // Wrap a function (typically a callback) to catch and report exceptions
 function do_exception_wrap(func) {
   return function() {
     try {
       func.apply(null, arguments);
     }
     catch(e) {
       do_report_unexpected_exception(e);
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_AddonRepository.js b/toolkit/mozapps/extensions/test/xpcshell/test_AddonRepository.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_AddonRepository.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_AddonRepository.js
@@ -2,29 +2,32 @@
  * http://creativecommons.org/publicdomain/zero/1.0/
  */
 
 // Tests AddonRepository.jsm
 
 Components.utils.import("resource://gre/modules/AddonRepository.jsm");
 
 Components.utils.import("resource://testing-common/httpd.js");
-var gServer;
+var gServer = new HttpServer();
+gServer.start(-1);
 
 const PREF_GETADDONS_BROWSEADDONS        = "extensions.getAddons.browseAddons";
 const PREF_GETADDONS_BYIDS               = "extensions.getAddons.get.url";
 const PREF_GETADDONS_BROWSERECOMMENDED   = "extensions.getAddons.recommended.browseURL";
 const PREF_GETADDONS_GETRECOMMENDED      = "extensions.getAddons.recommended.url";
 const PREF_GETADDONS_BROWSESEARCHRESULTS = "extensions.getAddons.search.browseURL";
 const PREF_GETADDONS_GETSEARCHRESULTS    = "extensions.getAddons.search.url";
 
-const PORT          = 4444;
+const PORT          = gServer.identity.primaryPort;
 const BASE_URL      = "http://localhost:" + PORT;
 const DEFAULT_URL   = "about:blank";
 
+gPort = PORT;
+
 // Path to source URI of installed add-on
 const INSTALL_URL1  = "/addons/test_AddonRepository_1.xpi";
 // Path to source URI of installing add-on
 const INSTALL_URL2  = "/addons/test_AddonRepository_2.xpi";
 // Path to source URI of non-active add-on (state = STATE_AVAILABLE)
 const INSTALL_URL3  = "/addons/test_AddonRepository_3.xpi";
 
 // Properties of an individual add-on that should be checked
@@ -211,31 +214,31 @@ var SEARCH_RESULTS = [{
   type:                   "extension",
   version:                "2.0",
   creator:                {
                             name: "Test Creator - Last Passing",
                             url:  BASE_URL + "/creatorLastPassing.html"
                           },
   averageRating:          5,
   repositoryStatus:       4,
-  purchaseURL:            "http://localhost:4444/purchaseURL1",
+  purchaseURL:            "http://localhost:" + PORT + "/purchaseURL1",
   purchaseAmount:         5,
   purchaseDisplayAmount:  "$5",
   icons:                  {}
 }, {
   id:                     "purchase2@tests.mozilla.org",
   type:                   "extension",
   version:                "2.0",
   creator:                {
                             name: "Test Creator - Last Passing",
                             url:  BASE_URL + "/creatorLastPassing.html"
                           },
   averageRating:          5,
   repositoryStatus:       4,
-  purchaseURL:            "http://localhost:4444/purchaseURL2",
+  purchaseURL:            "http://localhost:" + PORT + "/purchaseURL2",
   purchaseAmount:         10,
   purchaseDisplayAmount:  "$10",
   icons:                  {}
 }, {
   id:                     "test-lastPassing@tests.mozilla.org",
   type:                   "extension",
   version:                "2.0",
   creator:                {
@@ -362,41 +365,43 @@ function run_test() {
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9");
 
   startupManager();
 
   // Install an add-on so can check that it isn't returned in the results
   installAllFiles([do_get_addon("test_AddonRepository_1")], function addon_1_install_callback() {
     restartManager();
 
-    gServer = new HttpServer();
-
     // Register other add-on XPI files
     gServer.registerFile(INSTALL_URL2,
                         do_get_addon("test_AddonRepository_2"));
     gServer.registerFile(INSTALL_URL3,
                         do_get_addon("test_AddonRepository_3"));
 
     // Register files used to test search failure
-    gServer.registerFile(GET_TEST.failedURL,
-                        do_get_file("data/test_AddonRepository_failed.xml"));
-    gServer.registerFile(RECOMMENDED_TEST.failedURL,
-                        do_get_file("data/test_AddonRepository_failed.xml"));
-    gServer.registerFile(SEARCH_TEST.failedURL,
-                        do_get_file("data/test_AddonRepository_failed.xml"));
+    mapUrlToFile(GET_TEST.failedURL,
+                 do_get_file("data/test_AddonRepository_failed.xml"),
+                 gServer);
+    mapUrlToFile(RECOMMENDED_TEST.failedURL,
+                 do_get_file("data/test_AddonRepository_failed.xml"),
+                 gServer);
+    mapUrlToFile(SEARCH_TEST.failedURL,
+                 do_get_file("data/test_AddonRepository_failed.xml"),
+                 gServer);
 
     // Register files used to test search success
-    gServer.registerFile(GET_TEST.successfulURL,
-                        do_get_file("data/test_AddonRepository_getAddonsByIDs.xml"));
-    gServer.registerFile(RECOMMENDED_TEST.successfulURL,
-                        do_get_file("data/test_AddonRepository.xml"));
-    gServer.registerFile(SEARCH_TEST.successfulURL,
-                        do_get_file("data/test_AddonRepository.xml"));
-
-    gServer.start(PORT);
+    mapUrlToFile(GET_TEST.successfulURL,
+                 do_get_file("data/test_AddonRepository_getAddonsByIDs.xml"),
+                 gServer);
+    mapUrlToFile(RECOMMENDED_TEST.successfulURL,
+                 do_get_file("data/test_AddonRepository.xml"),
+                 gServer);
+    mapUrlToFile(SEARCH_TEST.successfulURL,
+                 do_get_file("data/test_AddonRepository.xml"),
+                 gServer);
 
     // Create an active AddonInstall so can check that it isn't returned in the results
     AddonManager.getInstallForURL(BASE_URL + INSTALL_URL2, function addon_2_get(aInstall) {
       try {
         aInstall.install();
       }
       catch(e) {
         do_print("Failed to install add-on " + aInstall.sourceURI.spec);
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_AddonRepository_compatmode.js b/toolkit/mozapps/extensions/test/xpcshell/test_AddonRepository_compatmode.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_AddonRepository_compatmode.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_AddonRepository_compatmode.js
@@ -3,30 +3,32 @@
  */
 
 // This verifies that AddonRepository correctly fills in the
 // %COMPATIBILITY_MODE% token in the Search API URL.
 
 const PREF_GETADDONS_GETSEARCHRESULTS    = "extensions.getAddons.search.url";
 
 Components.utils.import("resource://testing-common/httpd.js");
-var gServer;
+var gServer = new HttpServer();
+gServer.start(-1);
+gPort = gServer.identity.primaryPort;
 var COMPATIBILITY_PREF;
 
+// register static files with server and interpolate port numbers in them
+mapFile("/data/test_AddonRepository_compatmode_ignore.xml", gServer);
+mapFile("/data/test_AddonRepository_compatmode_normal.xml", gServer);
+mapFile("/data/test_AddonRepository_compatmode_strict.xml", gServer);
+
 function run_test() {
   do_test_pending();
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9.2");
 
-  // Create and configure the HTTP server.
-  gServer = new HttpServer();
-  gServer.registerDirectory("/data/", do_get_file("data"));
-  gServer.start(4444);
-
   Services.prefs.setCharPref(PREF_GETADDONS_GETSEARCHRESULTS,
-                             "http://localhost:4444/data/test_AddonRepository_compatmode_%COMPATIBILITY_MODE%.xml");
+                             "http://localhost:" + gPort + "/data/test_AddonRepository_compatmode_%COMPATIBILITY_MODE%.xml");
   startupManager();
   run_test_1();
 }
 
 function end_test() {
   gServer.stop(do_test_finished);
 }
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_backgroundupdate.js b/toolkit/mozapps/extensions/test/xpcshell/test_backgroundupdate.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_backgroundupdate.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_backgroundupdate.js
@@ -3,28 +3,29 @@
  */
 
 // This verifies that background updates & notifications work as expected
 
 // The test extension uses an insecure update url.
 Services.prefs.setBoolPref(PREF_EM_CHECK_UPDATE_SECURITY, false);
 
 Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
 const profileDir = gProfD.clone();
 profileDir.append("extensions");
 
+// register static files with server and interpolate port numbers in them
+mapFile("/data/test_backgroundupdate.rdf", testserver);
+
 function run_test() {
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9.2");
 
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/data/", do_get_file("data"));
   testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.start(4444);
 
   startupManager();
 
   do_test_pending();
   run_test_1();
 }
 
 function end_test() {
@@ -48,29 +49,29 @@ function run_test_1() {
 }
 
 // Verify that with two add-ons installed both of which claim to have updates
 // available we get the notification after both updates attempted to start
 function run_test_2() {
   writeInstallRDFForExtension({
     id: "addon1@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_backgroundupdate.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_backgroundupdate.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 1",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon2@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_backgroundupdate.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_backgroundupdate.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 2",
   }, profileDir);
 
@@ -82,22 +83,22 @@ function run_test_2() {
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 3",
   }, profileDir);
 
   // Background update uses a different pref, if set
   Services.prefs.setCharPref("extensions.update.background.url",
-                             "http://localhost:4444/data/test_backgroundupdate.rdf");
+                             "http://localhost:" + gPort +"/data/test_backgroundupdate.rdf");
   restartManager();
 
   // Do hotfix checks
   Services.prefs.setCharPref("extensions.hotfix.id", "hotfix@tests.mozilla.org");
-  Services.prefs.setCharPref("extensions.hotfix.url", "http://localhost:4444/missing.rdf");
+  Services.prefs.setCharPref("extensions.hotfix.url", "http://localhost:" + gPort + "/missing.rdf");
 
   let installCount = 0;
   let completeCount = 0;
   let sawCompleteNotification = false;
 
   Services.obs.addObserver(function() {
     Services.obs.removeObserver(arguments.callee, "addons-background-update-complete");
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_badschema.js b/toolkit/mozapps/extensions/test/xpcshell/test_badschema.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_badschema.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_badschema.js
@@ -1,17 +1,22 @@
 /* Any copyright is dedicated to the Public Domain.
  * http://creativecommons.org/publicdomain/zero/1.0/
  */
 
 // Checks that we rebuild something sensible from a database with a bad schema
 
 
 Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+
+// register static files with server and interpolate port numbers in them
+mapFile("/data/test_corrupt.rdf", testserver);
 
 // The test extension uses an insecure update url.
 Services.prefs.setBoolPref("extensions.checkUpdateSecurity", false);
 
 // Will be enabled
 var addon1 = {
   id: "addon1@tests.mozilla.org",
   version: "1.0",
@@ -35,30 +40,30 @@ var addon2 = {
   }]
 };
 
 // Will get a compatibility update and be enabled
 var addon3 = {
   id: "addon3@tests.mozilla.org",
   version: "1.0",
   name: "Test 3",
-  updateURL: "http://localhost:4444/data/test_corrupt.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/test_corrupt.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "1"
   }]
 };
 
 // Will get a compatibility update and be disabled
 var addon4 = {
   id: "addon4@tests.mozilla.org",
   version: "1.0",
   name: "Test 4",
-  updateURL: "http://localhost:4444/data/test_corrupt.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/test_corrupt.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "1"
   }]
 };
 
 // Stays incompatible
@@ -138,20 +143,17 @@ function run_test() {
   writeInstallRDFForExtension(addon4, profileDir);
   writeInstallRDFForExtension(addon5, profileDir);
   writeInstallRDFForExtension(addon6, profileDir);
   writeInstallRDFForExtension(addon7, profileDir);
   writeInstallRDFForExtension(theme1, profileDir);
   writeInstallRDFForExtension(theme2, profileDir);
 
   // Create and configure the HTTP server.
-  testserver = new HttpServer();
   testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.registerDirectory("/data/", do_get_file("data"));
-  testserver.start(4444);
 
   // Startup the profile and setup the initial state
   startupManager();
 
   AddonManager.getAddonsByIDs(["addon2@tests.mozilla.org",
                                "addon3@tests.mozilla.org",
                                "addon4@tests.mozilla.org",
                                "addon7@tests.mozilla.org",
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_blocklist_regexp.js b/toolkit/mozapps/extensions/test/xpcshell/test_blocklist_regexp.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_blocklist_regexp.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_blocklist_regexp.js
@@ -1,22 +1,27 @@
 /* Any copyright is dedicated to the Public Domain.
  * http://creativecommons.org/publicdomain/zero/1.0/
  */
 
 // Checks that blocklist entries using RegExp work as expected. This only covers
-// behavior specific to RegExp entries - general behavior is already tested 
+// behavior specific to RegExp entries - general behavior is already tested
 // in test_blocklistchange.js.
 
 const {classes: Cc, interfaces: Ci, utils: Cu, results: Cr} = Components;
 
 const URI_EXTENSION_BLOCKLIST_DIALOG = "chrome://mozapps/content/extensions/blocklist.xul";
 
 Cu.import("resource://testing-common/httpd.js");
-var testserver;
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+
+// register static files with server and interpolate port numbers in them
+mapFile("/data/test_blocklist_regexp_1.xml", testserver);
 
 const profileDir = gProfD.clone();
 profileDir.append("extensions");
 
 // Don't need the full interface, attempts to call other methods will just
 // throw which is just fine
 var WindowWatcher = {
   openWindow: function(parent, url, name, features, arguments) {
@@ -61,33 +66,30 @@ registrar.registerFactory(Components.ID(
 
 function load_blocklist(aFile, aCallback) {
   Services.obs.addObserver(function() {
     Services.obs.removeObserver(arguments.callee, "blocklist-updated");
 
     do_execute_soon(aCallback);
   }, "blocklist-updated", false);
 
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + aFile);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + aFile);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 
 function end_test() {
   testserver.stop(do_test_finished);
 }
 
 
 function run_test() {
-  testserver = new HttpServer();
-  testserver.registerDirectory("/data/", do_get_file("data"));
-  testserver.start(4444);
-
   do_test_pending();
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1");
 
   writeInstallRDFForExtension({
     id: "block1@tests.mozilla.org",
     version: "1.0",
     name: "RegExp blocked add-on",
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_blocklistchange.js b/toolkit/mozapps/extensions/test/xpcshell/test_blocklistchange.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_blocklistchange.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_blocklistchange.js
@@ -35,17 +35,32 @@ const Cr = Components.results;
 const URI_EXTENSION_BLOCKLIST_DIALOG = "chrome://mozapps/content/extensions/blocklist.xul";
 
 Cu.import("resource://gre/modules/NetUtil.jsm");
 
 // Allow insecure updates
 Services.prefs.setBoolPref("extensions.checkUpdateSecurity", false)
 
 Cu.import("resource://testing-common/httpd.js");
-var testserver;
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+
+// register static files with server and interpolate port numbers in them
+mapFile("/data/blocklistchange/addon_update1.rdf", testserver);
+mapFile("/data/blocklistchange/addon_update2.rdf", testserver);
+mapFile("/data/blocklistchange/addon_update3.rdf", testserver);
+mapFile("/data/blocklistchange/addon_change.xml", testserver);
+mapFile("/data/blocklistchange/app_update.xml", testserver);
+mapFile("/data/blocklistchange/blocklist_update1.xml", testserver);
+mapFile("/data/blocklistchange/blocklist_update2.xml", testserver);
+mapFile("/data/blocklistchange/manual_update.xml", testserver);
+
+testserver.registerDirectory("/addons/", do_get_file("addons"));
+
 
 var default_theme = {
   id: "default@tests.mozilla.org",
   version: "1.0",
   name: "Softblocked add-on",
   internalName: "classic/1.0",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
@@ -53,260 +68,260 @@ var default_theme = {
     maxVersion: "3"
   }]
 };
 
 var softblock1_1 = {
   id: "softblock1@tests.mozilla.org",
   version: "1.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update1.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update1.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var softblock1_2 = {
   id: "softblock1@tests.mozilla.org",
   version: "2.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update2.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update2.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var softblock1_3 = {
   id: "softblock1@tests.mozilla.org",
   version: "3.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update3.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update3.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var softblock2_1 = {
   id: "softblock2@tests.mozilla.org",
   version: "1.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update1.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update1.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var softblock2_2 = {
   id: "softblock2@tests.mozilla.org",
   version: "2.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update2.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update2.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var softblock2_3 = {
   id: "softblock2@tests.mozilla.org",
   version: "3.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update3.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update3.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var softblock3_1 = {
   id: "softblock3@tests.mozilla.org",
   version: "1.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update1.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update1.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var softblock3_2 = {
   id: "softblock3@tests.mozilla.org",
   version: "2.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update2.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update2.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var softblock3_3 = {
   id: "softblock3@tests.mozilla.org",
   version: "3.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update3.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update3.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var softblock4_1 = {
   id: "softblock4@tests.mozilla.org",
   version: "1.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update1.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update1.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var softblock4_2 = {
   id: "softblock4@tests.mozilla.org",
   version: "2.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update2.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update2.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var softblock4_3 = {
   id: "softblock4@tests.mozilla.org",
   version: "3.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update3.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update3.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var softblock5_1 = {
   id: "softblock5@tests.mozilla.org",
   version: "1.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update1.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update1.rdf",
   internalName: "test/1.0",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var softblock5_2 = {
   id: "softblock5@tests.mozilla.org",
   version: "2.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update2.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update2.rdf",
   internalName: "test/1.0",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var softblock5_3 = {
   id: "softblock5@tests.mozilla.org",
   version: "3.0",
   name: "Softblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update3.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update3.rdf",
   internalName: "test/1.0",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var hardblock_1 = {
   id: "hardblock@tests.mozilla.org",
   version: "1.0",
   name: "Hardblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update1.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update1.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var hardblock_2 = {
   id: "hardblock@tests.mozilla.org",
   version: "2.0",
   name: "Hardblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update2.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update2.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var hardblock_3 = {
   id: "hardblock@tests.mozilla.org",
   version: "3.0",
   name: "Hardblocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update3.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update3.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var regexpblock_1 = {
   id: "regexpblock@tests.mozilla.org",
   version: "1.0",
   name: "RegExp-blocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update1.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update1.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var regexpblock_2 = {
   id: "regexpblock@tests.mozilla.org",
   version: "2.0",
   name: "RegExp-blocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update2.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update2.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 var regexpblock_3 = {
   id: "regexpblock@tests.mozilla.org",
   version: "3.0",
   name: "RegExp-blocked add-on",
-  updateURL: "http://localhost:4444/data/addon_update3.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/blocklistchange/addon_update3.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "3"
   }]
 };
 
 const ADDON_IDS = ["softblock1@tests.mozilla.org",
@@ -390,17 +405,17 @@ profileDir.append("extensions");
 
 function load_blocklist(aFile, aCallback) {
   Services.obs.addObserver(function() {
     Services.obs.removeObserver(arguments.callee, "blocklist-updated");
 
     do_execute_soon(aCallback);
   }, "blocklist-updated", false);
 
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + aFile);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" + gPort + "/data/blocklistchange/" + aFile);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Does a background update check for add-ons and waits for any started installs
 // to complete
 function background_update(aCallback) {
@@ -442,35 +457,35 @@ function background_update(aCallback) {
   }, "addons-background-update-complete", false);
 
   AddonManagerPrivate.backgroundUpdateCheck();
 }
 
 // Manually updates the test add-ons to the given version
 function manual_update(aVersion, aCallback) {
   var installs = [];
-  AddonManager.getInstallForURL("http://localhost:4444/addons/blocklist_soft1_" + aVersion + ".xpi",
+  AddonManager.getInstallForURL("http://localhost:" + gPort + "/addons/blocklist_soft1_" + aVersion + ".xpi",
                                 function(aInstall) {
     installs.push(aInstall);
-    AddonManager.getInstallForURL("http://localhost:4444/addons/blocklist_soft2_" + aVersion + ".xpi",
+    AddonManager.getInstallForURL("http://localhost:" + gPort + "/addons/blocklist_soft2_" + aVersion + ".xpi",
                                   function(aInstall) {
       installs.push(aInstall);
-      AddonManager.getInstallForURL("http://localhost:4444/addons/blocklist_soft3_" + aVersion + ".xpi",
+      AddonManager.getInstallForURL("http://localhost:" + gPort + "/addons/blocklist_soft3_" + aVersion + ".xpi",
                                     function(aInstall) {
         installs.push(aInstall);
-        AddonManager.getInstallForURL("http://localhost:4444/addons/blocklist_soft4_" + aVersion + ".xpi",
+        AddonManager.getInstallForURL("http://localhost:" + gPort + "/addons/blocklist_soft4_" + aVersion + ".xpi",
                                       function(aInstall) {
           installs.push(aInstall);
-          AddonManager.getInstallForURL("http://localhost:4444/addons/blocklist_soft5_" + aVersion + ".xpi",
+          AddonManager.getInstallForURL("http://localhost:" + gPort + "/addons/blocklist_soft5_" + aVersion + ".xpi",
                                         function(aInstall) {
             installs.push(aInstall);
-            AddonManager.getInstallForURL("http://localhost:4444/addons/blocklist_hard1_" + aVersion + ".xpi",
+            AddonManager.getInstallForURL("http://localhost:" + gPort + "/addons/blocklist_hard1_" + aVersion + ".xpi",
                                           function(aInstall) {
               installs.push(aInstall);
-              AddonManager.getInstallForURL("http://localhost:4444/addons/blocklist_regexp1_" + aVersion + ".xpi",
+              AddonManager.getInstallForURL("http://localhost:" + gPort + "/addons/blocklist_regexp1_" + aVersion + ".xpi",
                                             function(aInstall) {
                 installs.push(aInstall);
 
                 Services.obs.addObserver(function(aSubject, aTopic, aData) {
                   Services.obs.removeObserver(arguments.callee, "addon-install-blocked");
 
                   aSubject.QueryInterface(Ci.amIWebInstallInfo);
 
@@ -497,17 +512,17 @@ function manual_update(aVersion, aCallba
                   aSubject.installs.forEach(function(aInstall) {
                     aInstall.addListener(listener);
                   });
 
                   aSubject.install();
                 }, "addon-install-blocked", false);
 
                 AddonManager.installAddonsFromWebpage("application/x-xpinstall", null,
-                                                      NetUtil.newURI("http://localhost:4444/"),
+                                                      NetUtil.newURI("http://localhost:" + gPort + "/"),
                                                       installs);
               }, "application/x-xpinstall");
             }, "application/x-xpinstall");
           }, "application/x-xpinstall");
         }, "application/x-xpinstall");
       }, "application/x-xpinstall");
     }, "application/x-xpinstall");
   }, "application/x-xpinstall");
@@ -552,22 +567,16 @@ function check_addon(aAddon, aExpectedVe
     do_check_false(willBeActive);
   }
   else {
     do_check_true(willBeActive);
   }
 }
 
 function run_test() {
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/data/", do_get_file("data/blocklistchange"));
-  testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.start(4444);
-
   do_test_pending("test_blocklistchange main");
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1");
   writeInstallRDFForExtension(default_theme, profileDir);
   writeInstallRDFForExtension(softblock1_1, profileDir);
   writeInstallRDFForExtension(softblock2_1, profileDir);
   writeInstallRDFForExtension(softblock3_1, profileDir);
   writeInstallRDFForExtension(softblock4_1, profileDir);
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bootstrap.js b/toolkit/mozapps/extensions/test/xpcshell/test_bootstrap.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bootstrap.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bootstrap.js
@@ -25,17 +25,21 @@ createAppInfo("xpcshell@tests.mozilla.or
 const profileDir = gProfD.clone();
 profileDir.append("extensions");
 const userExtDir = gProfD.clone();
 userExtDir.append("extensions2");
 userExtDir.append(gAppInfo.ID);
 registerDirectory("XREUSysExt", userExtDir.parent);
 
 Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+
+testserver.registerDirectory("/addons/", do_get_file("addons"));
 
 function resetPrefs() {
   Services.prefs.setIntPref("bootstraptest.active_version", -1);
   Services.prefs.setIntPref("bootstraptest.installed_version", -1);
   Services.prefs.setIntPref("bootstraptest2.active_version", -1);
   Services.prefs.setIntPref("bootstraptest2.installed_version", -1);
   Services.prefs.setIntPref("bootstraptest.startup_reason", -1);
   Services.prefs.setIntPref("bootstraptest.shutdown_reason", -1);
@@ -137,21 +141,16 @@ function do_check_bootstrappedPref(aCall
 }
 
 
 function run_test() {
   do_test_pending();
 
   resetPrefs();
 
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.start(4444);
-
   startupManager();
 
   let file = gProfD.clone();
   file.append(EXTENSIONS_DB);
   do_check_false(file.exists());
 
   file.leafName = "extensions.ini";
   do_check_false(file.exists());
@@ -1132,17 +1131,17 @@ function run_test_22() {
 
 
 // Tests that installing from a URL doesn't require a restart
 function run_test_23() {
   prepare_test({ }, [
     "onNewInstall"
   ]);
 
-  let url = "http://localhost:4444/addons/test_bootstrap1_1.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_bootstrap1_1.xpi";
   AddonManager.getInstallForURL(url, function(install) {
     ensure_test_completed();
 
     do_check_neq(install, null);
 
     prepare_test({ }, [
       "onDownloadStarted",
       "onDownloadEnded"
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug384052.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug384052.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug384052.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug384052.js
@@ -1,22 +1,24 @@
 const CLASS_ID = Components.ID("{12345678-1234-1234-1234-123456789abc}");
 const CONTRACT_ID = "@mozilla.org/test-parameter-source;1";
 
-var gTestURL = "http://127.0.0.1:4444/update.rdf?itemID=%ITEM_ID%&custom1=%CUSTOM1%&custom2=%CUSTOM2%";
+// Get and create the HTTP server.
+Components.utils.import("resource://testing-common/httpd.js");
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+
+var gTestURL = "http://127.0.0.1:" + gPort + "/update.rdf?itemID=%ITEM_ID%&custom1=%CUSTOM1%&custom2=%CUSTOM2%";
 var gExpectedQuery = "itemID=test@mozilla.org&custom1=custom_parameter_1&custom2=custom_parameter_2";
 var gSeenExpectedURL = false;
 
 var gComponentRegistrar = Components.manager.QueryInterface(AM_Ci.nsIComponentRegistrar);
 var gCategoryManager = AM_Cc["@mozilla.org/categorymanager;1"].getService(AM_Ci.nsICategoryManager);
 
-// Get the HTTP server.
-Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
-
 // Factory for our parameter handler
 var paramHandlerFactory = {
   QueryInterface: function(iid) {
     if (iid.equals(AM_Ci.nsIFactory) || iid.equals(AM_Ci.nsISupports))
       return this;
 
     throw Components.results.NS_ERROR_NO_INTERFACE;
   },
@@ -31,23 +33,21 @@ var paramHandlerFactory = {
 };
 
 function initTest()
 {
   do_test_pending();
   // Setup extension manager
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9");
 
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
+  // Configure the HTTP server.
   testserver.registerPathHandler("/update.rdf", function(aRequest, aResponse) {
     gSeenExpectedURL = aRequest.queryString == gExpectedQuery;
     aResponse.setStatusLine(null, 404, "Not Found");
   });
-  testserver.start(4444);
 
   // Register our parameter handlers
   gComponentRegistrar.registerFactory(CLASS_ID, "Test component", CONTRACT_ID, paramHandlerFactory);
   gCategoryManager.addCategoryEntry("extension-update-params", "CUSTOM1", CONTRACT_ID, false, false);
   gCategoryManager.addCategoryEntry("extension-update-params", "CUSTOM2", CONTRACT_ID, false, false);
 
   // Install a test extension into the profile
   let dir = gProfD.clone();
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug424262.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug424262.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug424262.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug424262.js
@@ -1,15 +1,15 @@
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/.
  */
 Components.utils.import("resource://gre/modules/AddonRepository.jsm");
 
-const PREF_GETADDONS_GETRECOMMENDED      = "extensions.getAddons.recommended.url";
+const PREF_GETADDONS_GETRECOMMENDED = "extensions.getAddons.recommended.url";
 
 Components.utils.import("resource://testing-common/httpd.js");
 var server;
 var RESULTS = [
   null,
   null,
   0,
   2,
@@ -40,21 +40,23 @@ var RecommendedCallback = {
 
 function run_test()
 {
   // EM needs to be running.
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9");
   startupManager();
 
   server = new HttpServer();
-  server.registerDirectory("/", do_get_file("data"));
-  server.start(4444);
+  server.start(-1);
+  gPort = server.identity.primaryPort;
+  mapFile("/data/test_bug424262.xml", server);
 
   // Point the addons repository to the test server
-  Services.prefs.setCharPref(PREF_GETADDONS_GETRECOMMENDED, "http://localhost:4444/test_bug424262.xml");
+  Services.prefs.setCharPref(PREF_GETADDONS_GETRECOMMENDED, "http://localhost:" +
+                             gPort + "/data/test_bug424262.xml");
 
   do_check_neq(AddonRepository, null);
 
   do_test_pending();
   // Pull some results.
   AddonRepository.retrieveRecommendedAddons(RESULTS.length, RecommendedCallback);
 }
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug430120.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug430120.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug430120.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug430120.js
@@ -101,41 +101,42 @@ function run_test() {
   catch (e) {
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9");
 
   testserver = new HttpServer();
   testserver.registerPathHandler("/1", failHandler);
   testserver.registerPathHandler("/2", pathHandler);
-  testserver.start(4444);
+  testserver.start(-1);
+  gPort = testserver.identity.primaryPort;
 
   // Initialise the blocklist service
   gBlocklist = Components.classes["@mozilla.org/extensions/blocklist;1"]
                          .getService(Components.interfaces.nsIBlocklistService)
                          .QueryInterface(Components.interfaces.nsIObserver);
   gBlocklist.observe(null, "profile-after-change", "");
 
   do_check_true(timerService.hasTimer(BLOCKLIST_TIMER));
 
   do_test_pending();
 
   // This should have no effect as the blocklist is disabled
-  Services.prefs.setCharPref(PREF_BLOCKLIST_URL, "http://localhost:4444/1");
+  Services.prefs.setCharPref(PREF_BLOCKLIST_URL, "http://localhost:" + gPort + "/1");
   Services.prefs.setBoolPref(PREF_BLOCKLIST_ENABLED, false);
   timerService.fireTimer(BLOCKLIST_TIMER);
 
   // Some values have to be on the default branch to work
   var defaults = Services.prefs.QueryInterface(Components.interfaces.nsIPrefService)
                        .getDefaultBranch(null);
   defaults.setCharPref(PREF_APP_UPDATE_CHANNEL, "updatechannel");
   defaults.setCharPref(PREF_APP_DISTRIBUTION, "distribution");
   defaults.setCharPref(PREF_APP_DISTRIBUTION_VERSION, "distribution-version");
   defaults.setCharPref(PREF_GENERAL_USERAGENT_LOCALE, "locale");
 
   // This should correctly escape everything
-  Services.prefs.setCharPref(PREF_BLOCKLIST_URL, "http://localhost:4444/2?" +
+  Services.prefs.setCharPref(PREF_BLOCKLIST_URL, "http://localhost:" + gPort + "/2?" +
                      "%APP_ID%&%APP_VERSION%&%PRODUCT%&%VERSION%&%BUILD_ID%&" +
                      "%BUILD_TARGET%&%LOCALE%&%CHANNEL%&" +
                      "%OS_VERSION%&%PLATFORM_VERSION%&%DISTRIBUTION%&%DISTRIBUTION_VERSION%");
   Services.prefs.setBoolPref(PREF_BLOCKLIST_ENABLED, true);
   timerService.fireTimer(BLOCKLIST_TIMER);
 }
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug449027.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug449027.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug449027.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug449027.js
@@ -368,17 +368,17 @@ function check_state(test, lastTest, cal
 
       do_check_eq(expected, gNewBlocks.length);
     }
     do_execute_soon(callback);
   });
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" + gPort + "/data/" + file);
   var blocklist = Components.classes["@mozilla.org/extensions/blocklist;1"]
                             .getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 function run_test() {
   // Setup for test
   dump("Setting up tests\n");
@@ -387,17 +387,18 @@ function run_test() {
   for (let addon of ADDONS)
     create_addon(addon);
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
   gTestserver = new HttpServer();
   gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
+  gTestserver.start(-1);
+  gPort = gTestserver.identity.primaryPort;
 
   do_test_pending();
   check_test_pt1();
 }
 
 /**
  * Checks the initial state is correct
  */
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug455906.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug455906.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug455906.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug455906.js
@@ -1,24 +1,34 @@
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/.
  */
-const URI_EXTENSION_BLOCKLIST_DIALOG = "chrome://mozapps/content/extensions/blocklist.xul";
-
-// Workaround for Bug 658720 - URL formatter can leak during xpcshell tests
-const PREF_BLOCKLIST_ITEM_URL = "extensions.blocklist.itemURL";
-Services.prefs.setCharPref(PREF_BLOCKLIST_ITEM_URL, "http://localhost:4444/blocklist/%blockID%");
 
 const Cc = Components.classes;
 const Ci = Components.interfaces;
 const Cu = Components.utils;
 const Cr = Components.results;
 
+const URI_EXTENSION_BLOCKLIST_DIALOG = "chrome://mozapps/content/extensions/blocklist.xul";
+
 Cu.import("resource://testing-common/httpd.js");
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
+
+// register static files with server and interpolate port numbers in them
+mapFile("/data/bug455906_warn.xml", gTestserver);
+mapFile("/data/bug455906_start.xml", gTestserver);
+mapFile("/data/bug455906_block.xml", gTestserver);
+mapFile("/data/bug455906_empty.xml", gTestserver);
+
+// Workaround for Bug 658720 - URL formatter can leak during xpcshell tests
+const PREF_BLOCKLIST_ITEM_URL = "extensions.blocklist.itemURL";
+Services.prefs.setCharPref(PREF_BLOCKLIST_ITEM_URL, "http://localhost:" + gPort + "/blocklist/%blockID%");
 
 var ADDONS = [{
   // Tests how the blocklist affects a disabled add-on
   id: "test_bug455906_1@tests.mozilla.org",
   name: "Bug 455906 Addon Test 1",
   version: "5",
   appVersion: "3"
 }, {
@@ -100,17 +110,16 @@ var PLUGINS = [
   // Tests how the blocklist affects an enabled plugin that was already warned about
   new MockPlugin("test_bug455906_5", "5", Ci.nsIPluginTag.STATE_ENABLED),
   // Tests how the blocklist affects an already blocked plugin
   new MockPlugin("test_bug455906_6", "5", Ci.nsIPluginTag.STATE_ENABLED)
 ];
 
 var gNotificationCheck = null;
 var gTestCheck = null;
-var gTestserver = null;
 
 // A fake plugin host for the blocklist service to use
 var PluginHost = {
   getPluginTags: function(countRef) {
     countRef.value = PLUGINS.length;
     return PLUGINS;
   },
 
@@ -200,17 +209,17 @@ function create_addon(addon) {
   var stream = Cc["@mozilla.org/network/file-output-stream;1"].
                createInstance(Ci.nsIFileOutputStream);
   stream.init(target, 0x04 | 0x08 | 0x20, 0664, 0); // write, create, truncate
   stream.write(installrdf, installrdf.length);
   stream.close();
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" + gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 function check_addon_state(addon) {
   return addon.userDisabled + "," + addon.softDisabled + "," + addon.appDisabled;
 }
@@ -241,20 +250,16 @@ function run_test() {
   if (blocklistFile.exists())
     blocklistFile.remove(false);
   var blocklist = do_get_file("data/bug455906_start.xml")
   blocklist.copyTo(gProfD, "blocklist.xml");
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
   check_test_pt1();
 }
 
 // Before every main test this is the state the add-ons are meant to be in
 function check_initial_state(callback) {
   AddonManager.getAddonsByIDs([a.id for each (a in ADDONS)], function(addons) {
     do_check_eq(check_addon_state(addons[0]), "true,false,false");
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug470377_1.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug470377_1.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug470377_1.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug470377_1.js
@@ -19,17 +19,17 @@ Components.utils.import("resource://test
 var server;
 
 function run_test() {
   do_test_pending();
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "2", "2");
 
   server = new HttpServer();
   server.registerDirectory("/", do_get_file("data/test_bug470377"));
-  server.start(4444);
+  server.start(-1);
 
   startupManager();
 
   installAllFiles([do_get_addon(a) for each (a in ADDONS)], function() {
     restartManager();
 
     AddonManager.getAddonsByIDs(["bug470377_1@tests.mozilla.org",
                                  "bug470377_2@tests.mozilla.org",
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug470377_1_strictcompat.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug470377_1_strictcompat.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug470377_1_strictcompat.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug470377_1_strictcompat.js
@@ -19,17 +19,17 @@ Components.utils.import("resource://test
 var server;
 
 function run_test() {
   do_test_pending();
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "2", "2");
 
   server = new HttpServer();
   server.registerDirectory("/", do_get_file("data/test_bug470377"));
-  server.start(4444);
+  server.start(-1);
 
   startupManager();
 
   installAllFiles([do_get_addon(a) for each (a in ADDONS)], function() {
     restartManager();
 
     AddonManager.getAddonsByIDs(["bug470377_1@tests.mozilla.org",
                                  "bug470377_2@tests.mozilla.org",
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug470377_2.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug470377_2.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug470377_2.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug470377_2.js
@@ -18,17 +18,17 @@ Components.utils.import("resource://test
 var server;
 
 function run_test() {
   do_test_pending();
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "2", "2");
 
   server = new HttpServer();
   server.registerDirectory("/", do_get_file("data/test_bug470377"));
-  server.start(4444);
+  server.start(-1);
 
   startupManager();
   AddonManager.checkCompatibility = false;
 
   installAllFiles([do_get_addon(a) for each (a in ADDONS)], function() {
     restartManager();
 
     AddonManager.getAddonsByIDs(["bug470377_1@tests.mozilla.org",
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug514327_3.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug514327_3.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug514327_3.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug514327_3.js
@@ -105,26 +105,27 @@ registrar.registerFactory(Components.ID(
 registrar.registerFactory(Components.ID("{1dfeb90a-2193-45d5-9cb8-864928b2af55}"),
                           "Fake Window Watcher",
                           "@mozilla.org/embedcomp/window-watcher;1", WindowWatcherFactory);
 
 
 function do_update_blocklist(aDatafile, aNextPart) {
   gNextTestPart = aNextPart;
 
-  gPrefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + aDatafile);
+  gPrefs.setCharPref("extensions.blocklist.url", "http://localhost:" + gPort + "/data/" + aDatafile);
   gBlocklist.QueryInterface(Ci.nsITimerCallback).notify(null);
 }
 
 function run_test() {
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9");
 
   gTestserver = new HttpServer();
   gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
+  gTestserver.start(-1);
+  gPort = gTestserver.identity.primaryPort;
 
   startupManager();
 
   // initialize the blocklist with no entries
   var blocklistFile = gProfD.clone();
   blocklistFile.append("blocklist.xml");
   if (blocklistFile.exists())
     blocklistFile.remove(false);
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug554133.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug554133.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug554133.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug554133.js
@@ -66,18 +66,21 @@ function run_test()
   // Setup for test
   do_test_pending();
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9");
 
   startupManager();
 
   server = new HttpServer();
   server.registerDirectory("/", do_get_file("data"));
-  server.start(4444);
+  mapFile("/data/test_bug554133.xml", server);
+  server.start(-1);
+  gPort = server.identity.primaryPort;
 
   // Point search to the test server
-  Services.prefs.setCharPref(PREF_GETADDONS_GETSEARCHRESULTS, "http://localhost:4444/test_%TERMS%.xml");
+  Services.prefs.setCharPref(PREF_GETADDONS_GETSEARCHRESULTS,
+                             "http://localhost:" + gPort + "/data/test_%TERMS%.xml");
 
   do_check_neq(AddonRepository, null);
   gCurrentTest = 0;
   run_current_test();
 }
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug559800.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug559800.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug559800.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug559800.js
@@ -5,40 +5,46 @@
 // This verifies that deleting the database from the profile doesn't break
 // anything
 
 const EXTENSIONS_DB = "extensions.sqlite";
 
 const profileDir = gProfD.clone();
 profileDir.append("extensions");
 
+// getting an unused port
+Components.utils.import("resource://testing-common/httpd.js");
+let gServer = new HttpServer();
+gServer.start(-1);
+gPort = gServer.identity.primaryPort;
+
 function run_test() {
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9.2");
 
   writeInstallRDFForExtension({
     id: "addon1@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 1",
   }, profileDir);
 
   startupManager();
 
   do_test_pending();
 
   run_test_1();
 }
 
 function end_test() {
-  do_test_finished();
+  gServer.stop(do_test_finished);
 }
 
 function run_test_1() {
   AddonManager.getAddonByID("addon1@tests.mozilla.org", function(a1) {
     do_check_neq(a1, null);
     do_check_eq(a1.version, "1.0");
 
     shutdownManager();
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug570173.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug570173.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug570173.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug570173.js
@@ -14,22 +14,23 @@ profileDir.append("extensions");
 
 function run_test() {
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9.2");
 
   // Create and configure the HTTP server.
   testserver = new HttpServer();
   testserver.registerDirectory("/data/", do_get_file("data"));
   testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.start(4444);
+  testserver.start(-1);
+  gPort = testserver.identity.primaryPort;
 
   writeInstallRDFForExtension({
     id: "addon1@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_missing.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_missing.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 1",
   }, profileDir);
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug619730.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug619730.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug619730.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug619730.js
@@ -4,37 +4,37 @@
 
 // Tests whether
 const Cc = Components.classes;
 const Ci = Components.interfaces;
 const Cu = Components.utils;
 
 Cu.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
+mapFile("/data/test_bug619730.xml", gTestserver);
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 var gSawGFX = false;
 var gSawTest = false;
 
 // Performs the initial setup
 function run_test() {
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   Services.obs.addObserver(function(aSubject, aTopic, aData) {
     do_check_true(aSubject instanceof AM_Ci.nsIDOMElement);
     do_check_eq(aSubject.getAttribute("testattr"), "GFX");
     do_check_eq(aSubject.childNodes.length, 2);
     gSawGFX = true;
   }, "blocklist-data-gfxItems", false);
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug620837.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug620837.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug620837.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug620837.js
@@ -25,20 +25,22 @@ function pathHandler(metadata, response)
   gNextTest();
 }
 
 function run_test() {
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1");
 
   gTestserver = new HttpServer();
   gTestserver.registerPathHandler("/", pathHandler);
-  gTestserver.start(4444);
+  gTestserver.start(-1);
+  gPort = gTestserver.identity.primaryPort;
 
   Services.prefs.setCharPref("extensions.blocklist.url",
-                             "http://localhost:4444/?%PING_COUNT%&%TOTAL_PING_COUNT%&%DAYS_SINCE_LAST_PING%");
+                             "http://localhost:" + gPort +
+                             "/?%PING_COUNT%&%TOTAL_PING_COUNT%&%DAYS_SINCE_LAST_PING%");
 
   do_test_pending();
   test1();
 }
 
 function getNowInSeconds() {
   return Math.round(Date.now() / 1000);
 }
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_bug655254.js b/toolkit/mozapps/extensions/test/xpcshell/test_bug655254.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_bug655254.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_bug655254.js
@@ -9,17 +9,20 @@
 Services.prefs.setBoolPref("extensions.checkUpdateSecurity", false);
 // Enable loading extensions from the user and system scopes
 Services.prefs.setIntPref("extensions.enabledScopes",
                           AddonManager.SCOPE_PROFILE + AddonManager.SCOPE_USER);
 
 createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "2", "1.9.2");
 
 Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+mapFile("/data/test_bug655254.rdf", testserver);
 
 var userDir = gProfD.clone();
 userDir.append("extensions2");
 userDir.append(gAppInfo.ID);
 
 var dirProvider = {
   getFile: function(aProp, aPersistent) {
     aPersistent.value = false;
@@ -32,33 +35,27 @@ var dirProvider = {
                                          AM_Ci.nsISupports])
 };
 Services.dirsvc.registerProvider(dirProvider);
 
 var addon1 = {
   id: "addon1@tests.mozilla.org",
   version: "1.0",
   name: "Test 1",
-  updateURL: "http://localhost:4444/data/test_bug655254.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/test_bug655254.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "1"
   }]
 };
 
 // Set up the profile
 function run_test() {
   do_test_pending();
-
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/data/", do_get_file("data"));
-  testserver.start(4444);
-
   run_test_1();
 }
 
 function end_test() {
   testserver.stop(do_test_finished);
 }
 
 function run_test_1() {
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_compatoverrides.js b/toolkit/mozapps/extensions/test/xpcshell/test_compatoverrides.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_compatoverrides.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_compatoverrides.js
@@ -3,29 +3,34 @@
 
 // Tests compatibility overrides, for when strict compatibility checking is
 // disabled. See bug 693906.
 
 
 const PREF_GETADDONS_CACHE_ENABLED = "extensions.getAddons.cache.enabled";
 const PREF_GETADDONS_BYIDS         = "extensions.getAddons.getWithPerformance.url";
 
-const PORT            = 4444;
+Components.utils.import("resource://testing-common/httpd.js");
+var gServer = new HttpServer();
+gServer.start(-1);
+gPort = gServer.identity.primaryPort;
+
+const PORT            = gPort;
 const BASE_URL        = "http://localhost:" + PORT;
 const DEFAULT_URL     = "about:blank";
 const REQ_URL         = "/data.xml";
 
+// register static file and mark it for interpolation
+mapUrlToFile(REQ_URL, do_get_file("data/test_compatoverrides.xml"), gServer);
+
 Services.prefs.setBoolPref(PREF_EM_STRICT_COMPATIBILITY, false);
 Services.prefs.setBoolPref(PREF_GETADDONS_CACHE_ENABLED, true);
 Services.prefs.setCharPref(PREF_GETADDONS_BYIDS,
                            BASE_URL + REQ_URL);
 
-Components.utils.import("resource://testing-common/httpd.js");
-var gServer;
-
 
 // Not hosted, no overrides
 var addon1 = {
   id: "addon1@tests.mozilla.org",
   version: "1.0",
   name: "Test addon 1",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
@@ -174,20 +179,16 @@ function run_test() {
   writeInstallRDFForExtension(addon4, profileDir);
   writeInstallRDFForExtension(addon5, profileDir);
   writeInstallRDFForExtension(addon6, profileDir);
   writeInstallRDFForExtension(addon7, profileDir);
   writeInstallRDFForExtension(addon8, profileDir);
   writeInstallRDFForExtension(addon9, profileDir);
   writeInstallRDFForExtension(addon10, profileDir);
 
-  gServer = new HttpServer();
-  gServer.registerFile(REQ_URL, do_get_file("data/test_compatoverrides.xml"));
-  gServer.start(PORT);
-
   startupManager();
 
   trigger_background_update(run_test_1);
 }
 
 function end_test() {
   gServer.stop(do_test_finished);
 }
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_corrupt.js b/toolkit/mozapps/extensions/test/xpcshell/test_corrupt.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_corrupt.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_corrupt.js
@@ -1,17 +1,24 @@
 /* Any copyright is dedicated to the Public Domain.
  * http://creativecommons.org/publicdomain/zero/1.0/
  */
 
 // Checks that we rebuild something sensible from a corrupt database
 
 
 Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
+// Create and configure the HTTP server.
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+
+// register files with server
+testserver.registerDirectory("/addons/", do_get_file("addons"));
+mapFile("/data/test_corrupt.rdf", testserver);
 
 // The test extension uses an insecure update url.
 Services.prefs.setBoolPref(PREF_EM_CHECK_UPDATE_SECURITY, false);
 Services.prefs.setBoolPref(PREF_EM_STRICT_COMPATIBILITY, false);
 
 // Will be enabled
 var addon1 = {
   id: "addon1@tests.mozilla.org",
@@ -36,30 +43,30 @@ var addon2 = {
   }]
 };
 
 // Will get a compatibility update and stay enabled
 var addon3 = {
   id: "addon3@tests.mozilla.org",
   version: "1.0",
   name: "Test 3",
-  updateURL: "http://localhost:4444/data/test_corrupt.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/test_corrupt.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "1"
   }]
 };
 
 // Will get a compatibility update and be enabled
 var addon4 = {
   id: "addon4@tests.mozilla.org",
   version: "1.0",
   name: "Test 4",
-  updateURL: "http://localhost:4444/data/test_corrupt.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/test_corrupt.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "1"
   }]
 };
 
 // Would stay incompatible with strict compat
@@ -138,22 +145,16 @@ function run_test() {
   writeInstallRDFForExtension(addon3, profileDir);
   writeInstallRDFForExtension(addon4, profileDir);
   writeInstallRDFForExtension(addon5, profileDir);
   writeInstallRDFForExtension(addon6, profileDir);
   writeInstallRDFForExtension(addon7, profileDir);
   writeInstallRDFForExtension(theme1, profileDir);
   writeInstallRDFForExtension(theme2, profileDir);
 
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.registerDirectory("/data/", do_get_file("data"));
-  testserver.start(4444);
-
   // Startup the profile and setup the initial state
   startupManager();
 
   AddonManager.getAddonsByIDs(["addon2@tests.mozilla.org",
                                "addon3@tests.mozilla.org",
                                "addon4@tests.mozilla.org",
                                "addon7@tests.mozilla.org",
                                "theme2@tests.mozilla.org"], function([a2, a3, a4,
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_corrupt_strictcompat.js b/toolkit/mozapps/extensions/test/xpcshell/test_corrupt_strictcompat.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_corrupt_strictcompat.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_corrupt_strictcompat.js
@@ -1,17 +1,25 @@
 /* Any copyright is dedicated to the Public Domain.
  * http://creativecommons.org/publicdomain/zero/1.0/
  */
 
 // Checks that we rebuild something sensible from a corrupt database
 
 
 Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
+// Create and configure the HTTP server.
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+
+// register files with server
+testserver.registerDirectory("/addons/", do_get_file("addons"));
+mapFile("/data/test_corrupt.rdf", testserver);
+
 
 // The test extension uses an insecure update url.
 Services.prefs.setBoolPref(PREF_EM_CHECK_UPDATE_SECURITY, false);
 Services.prefs.setBoolPref(PREF_EM_STRICT_COMPATIBILITY, true);
 
 // Will be enabled
 var addon1 = {
   id: "addon1@tests.mozilla.org",
@@ -36,30 +44,30 @@ var addon2 = {
   }]
 };
 
 // Will get a compatibility update and be enabled
 var addon3 = {
   id: "addon3@tests.mozilla.org",
   version: "1.0",
   name: "Test 3",
-  updateURL: "http://localhost:4444/data/test_corrupt.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/test_corrupt.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "1"
   }]
 };
 
 // Will get a compatibility update and be disabled
 var addon4 = {
   id: "addon4@tests.mozilla.org",
   version: "1.0",
   name: "Test 4",
-  updateURL: "http://localhost:4444/data/test_corrupt.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/test_corrupt.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "1"
   }]
 };
 
 // Stays incompatible
@@ -138,22 +146,16 @@ function run_test() {
   writeInstallRDFForExtension(addon3, profileDir);
   writeInstallRDFForExtension(addon4, profileDir);
   writeInstallRDFForExtension(addon5, profileDir);
   writeInstallRDFForExtension(addon6, profileDir);
   writeInstallRDFForExtension(addon7, profileDir);
   writeInstallRDFForExtension(theme1, profileDir);
   writeInstallRDFForExtension(theme2, profileDir);
 
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.registerDirectory("/data/", do_get_file("data"));
-  testserver.start(4444);
-
   // Startup the profile and setup the initial state
   startupManager();
 
   AddonManager.getAddonsByIDs(["addon2@tests.mozilla.org",
                                "addon3@tests.mozilla.org",
                                "addon4@tests.mozilla.org",
                                "addon7@tests.mozilla.org",
                                "theme2@tests.mozilla.org"], function([a2, a3, a4,
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_dictionary.js b/toolkit/mozapps/extensions/test/xpcshell/test_dictionary.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_dictionary.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_dictionary.js
@@ -17,17 +17,24 @@ createAppInfo("xpcshell@tests.mozilla.or
 const profileDir = gProfD.clone();
 profileDir.append("extensions");
 const userExtDir = gProfD.clone();
 userExtDir.append("extensions2");
 userExtDir.append(gAppInfo.ID);
 registerDirectory("XREUSysExt", userExtDir.parent);
 
 Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
+// Create and configure the HTTP server.
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+
+// register files with server
+testserver.registerDirectory("/addons/", do_get_file("addons"));
+mapFile("/data/test_dictionary.rdf", testserver);
 
 /**
  * This object is both a factory and an mozISpellCheckingEngine implementation (so, it
  * is de-facto a service). It's also an interface requestor that gives out
  * itself when asked for mozISpellCheckingEngine.
  */
 var HunspellEngine = {
   dictionaryDirs: [],
@@ -96,22 +103,16 @@ var HunspellEngine = {
       return dic.exists();
     });
   }
 };
 
 function run_test() {
   do_test_pending();
 
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/data/", do_get_file("data"));
-  testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.start(4444);
-
   startupManager();
 
   run_test_1();
 }
 
 // Tests that installing doesn't require a restart
 function run_test_1() {
   prepare_test({ }, [
@@ -501,17 +502,17 @@ function run_test_17() {
 }
 
 // Tests that installing from a URL doesn't require a restart
 function run_test_23() {
   prepare_test({ }, [
     "onNewInstall"
   ]);
 
-  let url = "http://localhost:4444/addons/test_dictionary.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_dictionary.xpi";
   AddonManager.getInstallForURL(url, function(install) {
     ensure_test_completed();
 
     do_check_neq(install, null);
 
     prepare_test({ }, [
       "onDownloadStarted",
       "onDownloadEnded"
@@ -648,17 +649,17 @@ function run_test_26() {
 }
 
 // Tests that an update check from a normal add-on to a bootstrappable add-on works
 function run_test_27() {
   restartManager();
   writeInstallRDFForExtension({
     id: "ab-CD@dictionaries.addons.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_dictionary.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_dictionary.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Dictionary",
   }, profileDir);
   restartManager();
@@ -694,17 +695,17 @@ function check_test_27(install) {
 // Tests that an update check from a bootstrappable add-on to a normal add-on works
 function run_test_28() {
   restartManager();
 
   writeInstallRDFForExtension({
     id: "ef@dictionaries.addons.mozilla.org",
     version: "1.0",
     type: "64",
-    updateURL: "http://localhost:4444/data/test_dictionary.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_dictionary.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Dictionary ef",
   }, profileDir);
   restartManager();
@@ -740,17 +741,17 @@ function check_test_28(install) {
 // Tests that an update check from a bootstrappable add-on to a bootstrappable add-on works
 function run_test_29() {
   restartManager();
 
   writeInstallRDFForExtension({
     id: "gh@dictionaries.addons.mozilla.org",
     version: "1.0",
     type: "64",
-    updateURL: "http://localhost:4444/data/test_dictionary.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_dictionary.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Dictionary gh",
   }, profileDir);
   restartManager();
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_dss.js b/toolkit/mozapps/extensions/test/xpcshell/test_dss.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_dss.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_dss.js
@@ -1,14 +1,20 @@
 /* Any copyright is dedicated to the Public Domain.
  * http://creativecommons.org/publicdomain/zero/1.0/
  */
 
 Components.utils.import("resource://gre/modules/NetUtil.jsm");
 
+// using a dynamic port in the addon metadata
+Components.utils.import("resource://testing-common/httpd.js");
+let gServer = new HttpServer();
+gServer.start(-1);
+gPort = gServer.identity.primaryPort;
+
 // This verifies that themes behave as expected
 
 const PREF_GENERAL_SKINS_SELECTEDSKIN = "general.skins.selectedSkin";
 const PREF_EXTENSIONS_DSS_ENABLED = "extensions.dss.enabled";
 
 Components.utils.import("resource://gre/modules/LightweightThemeManager.jsm");
 
 const profileDir = gProfD.clone();
@@ -226,36 +232,36 @@ function run_test_3() {
   ]);
 
   LightweightThemeManager.currentTheme = {
     id: "1",
     version: "1",
     name: "Test LW Theme",
     description: "A test theme",
     author: "Mozilla",
-    homepageURL: "http://localhost:4444/data/index.html",
-    headerURL: "http://localhost:4444/data/header.png",
-    footerURL: "http://localhost:4444/data/footer.png",
-    previewURL: "http://localhost:4444/data/preview.png",
-    iconURL: "http://localhost:4444/data/icon.png"
+    homepageURL: "http://localhost:" + gPort + "/data/index.html",
+    headerURL: "http://localhost:" + gPort + "/data/header.png",
+    footerURL: "http://localhost:" + gPort + "/data/footer.png",
+    previewURL: "http://localhost:" + gPort + "/data/preview.png",
+    iconURL: "http://localhost:" + gPort + "/data/icon.png"
   };
 
   ensure_test_completed();
 
   AddonManager.getAddonByID("1@personas.mozilla.org", function(p1) {
     do_check_neq(null, p1);
     do_check_eq(p1.name, "Test LW Theme");
     do_check_eq(p1.version, "1");
     do_check_eq(p1.type, "theme");
     do_check_eq(p1.description, "A test theme");
     do_check_eq(p1.creator, "Mozilla");
-    do_check_eq(p1.homepageURL, "http://localhost:4444/data/index.html");
-    do_check_eq(p1.iconURL, "http://localhost:4444/data/icon.png");
+    do_check_eq(p1.homepageURL, "http://localhost:" + gPort + "/data/index.html");
+    do_check_eq(p1.iconURL, "http://localhost:" + gPort + "/data/icon.png");
     do_check_eq(p1.screenshots.length, 1);
-    do_check_eq(p1.screenshots[0], "http://localhost:4444/data/preview.png");
+    do_check_eq(p1.screenshots[0], "http://localhost:" + gPort + "/data/preview.png");
     do_check_false(p1.appDisabled);
     do_check_false(p1.userDisabled);
     do_check_true(p1.isCompatible);
     do_check_true(p1.providesUpdatesSecurely);
     do_check_eq(p1.blocklistState, 0);
     do_check_true(p1.isActive);
     do_check_eq(p1.pendingOperations, 0);
     do_check_eq(p1.permissions, AddonManager.PERM_CAN_UNINSTALL | AddonManager.PERM_CAN_DISABLE);
@@ -303,21 +309,21 @@ function run_test_4() {
   ]);
 
   LightweightThemeManager.currentTheme = {
     id: "2",
     version: "1",
     name: "Test LW Theme",
     description: "A second test theme",
     author: "Mozilla",
-    homepageURL: "http://localhost:4444/data/index.html",
-    headerURL: "http://localhost:4444/data/header.png",
-    footerURL: "http://localhost:4444/data/footer.png",
-    previewURL: "http://localhost:4444/data/preview.png",
-    iconURL: "http://localhost:4444/data/icon.png"
+    homepageURL: "http://localhost:" + gPort + "/data/index.html",
+    headerURL: "http://localhost:" + gPort + "/data/header.png",
+    footerURL: "http://localhost:" + gPort + "/data/footer.png",
+    previewURL: "http://localhost:" + gPort + "/data/preview.png",
+    iconURL: "http://localhost:" + gPort + "/data/icon.png"
   };
 
   ensure_test_completed();
 
   AddonManager.getAddonsByIDs(["1@personas.mozilla.org",
                                "2@personas.mozilla.org"], function([p1, p2]) {
     do_check_neq(null, p2);
     do_check_false(p2.appDisabled);
@@ -776,21 +782,21 @@ function check_test_13() {
 // a restart
 function run_test_14() {
   LightweightThemeManager.currentTheme = {
     id: "1",
     version: "1",
     name: "Test LW Theme",
     description: "A test theme",
     author: "Mozilla",
-    homepageURL: "http://localhost:4444/data/index.html",
-    headerURL: "http://localhost:4444/data/header.png",
-    footerURL: "http://localhost:4444/data/footer.png",
-    previewURL: "http://localhost:4444/data/preview.png",
-    iconURL: "http://localhost:4444/data/icon.png"
+    homepageURL: "http://localhost:" + gPort + "/data/index.html",
+    headerURL: "http://localhost:" + gPort + "/data/header.png",
+    footerURL: "http://localhost:" + gPort + "/data/footer.png",
+    previewURL: "http://localhost:" + gPort + "/data/preview.png",
+    iconURL: "http://localhost:" + gPort + "/data/icon.png"
   };
 
   AddonManager.getAddonByID("default@tests.mozilla.org", function(d) {
     do_check_true(d.userDisabled);
     do_check_false(d.isActive);
 
     prepare_test({
       "1@personas.mozilla.org": [
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_filepointer.js b/toolkit/mozapps/extensions/test/xpcshell/test_filepointer.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_filepointer.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_filepointer.js
@@ -89,17 +89,18 @@ function run_test() {
 
   do_test_pending();
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1");
 
   // Create and configure the HTTP server.
   testserver = new HttpServer();
   testserver.registerDirectory("/data/", do_get_file("data"));
   testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.start(4444);
+  testserver.start(-1);
+  gPort = testserver.identity.primaryPort;
 
   run_test_1();
 }
 
 function end_test() {
   testserver.stop(do_test_finished);
 }
 
@@ -131,17 +132,17 @@ function run_test_1() {
 
 // Tests that installing the addon from some other source doesn't clobber
 // the original sources
 function run_test_2() {
   prepare_test({}, [
     "onNewInstall",
   ]);
 
-  let url = "http://localhost:4444/addons/test_filepointer.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_filepointer.xpi";
   AddonManager.getInstallForURL(url, function(install) {
     ensure_test_completed();
 
     prepare_test({
       "addon1@tests.mozilla.org": [
         "onInstalling"
       ]
     }, [
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Device.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Device.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Device.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Device.js
@@ -3,26 +3,30 @@
  */
 
 // Test whether a machine which differs only on device ID, but otherwise
 // exactly matches the blacklist entry, is not blocked.
 // Uses test_gfxBlacklist.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
+mapFile("/data/test_gfxBlacklist.xml", gTestserver);
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -63,20 +67,16 @@ function run_test() {
       gfxInfo.spoofDeviceID("aabb");
       gfxInfo.spoofDriverVersion("5");
       break;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function checkBlacklist()
   {
     var status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT2D);
     do_check_eq(status, Ci.nsIGfxInfo.FEATURE_NO_INFO);
 
     status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT3D_9_LAYERS);
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_DriverNew.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_DriverNew.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_DriverNew.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_DriverNew.js
@@ -3,26 +3,30 @@
  */
 
 // Test whether a new-enough driver bypasses the blacklist, even if the rest of
 // the attributes match the blacklist entry.
 // Uses test_gfxBlacklist.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
+mapFile("/data/test_gfxBlacklist.xml", gTestserver);
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -62,20 +66,16 @@ function run_test() {
       gfxInfo.spoofDeviceID("wxyz");
       gfxInfo.spoofDriverVersion("6");
       break;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function checkBlacklist()
   {
     var status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT2D);
     do_check_eq(status, Ci.nsIGfxInfo.FEATURE_NO_INFO);
 
     status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT3D_9_LAYERS);
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Equal_DriverNew.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Equal_DriverNew.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Equal_DriverNew.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Equal_DriverNew.js
@@ -3,26 +3,30 @@
  */
 
 // Test whether a machine which is newer than the equal
 // blacklist entry is allowed.
 // Uses test_gfxBlacklist.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
+mapFile("/data/test_gfxBlacklist.xml", gTestserver);
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -62,20 +66,16 @@ function run_test() {
       gfxInfo.spoofDeviceID("uiop");
       gfxInfo.spoofDriverVersion("6");
       break;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function checkBlacklist()
   {
     var status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT2D);
     do_check_eq(status, Ci.nsIGfxInfo.FEATURE_NO_INFO);
 
     // Make sure unrelated features aren't affected
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Equal_DriverOld.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Equal_DriverOld.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Equal_DriverOld.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Equal_DriverOld.js
@@ -3,26 +3,30 @@
  */
 
 // Test whether a machine which is older than the equal
 // blacklist entry is correctly allowed.
 // Uses test_gfxBlacklist.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
+mapFile("/data/test_gfxBlacklist.xml", gTestserver);
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -62,20 +66,16 @@ function run_test() {
       gfxInfo.spoofDeviceID("uiop");
       gfxInfo.spoofDriverVersion("4");
       break;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function checkBlacklist()
   {
     var status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT2D);
     do_check_eq(status, Ci.nsIGfxInfo.FEATURE_NO_INFO);
 
     // Make sure unrelated features aren't affected
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Equal_OK.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Equal_OK.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Equal_OK.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Equal_OK.js
@@ -3,26 +3,30 @@
  */
 
 // Test whether a machine which exactly matches the equal
 // blacklist entry is successfully blocked.
 // Uses test_gfxBlacklist.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
+mapFile("/data/test_gfxBlacklist.xml", gTestserver);
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -62,20 +66,16 @@ function run_test() {
       gfxInfo.spoofDeviceID("uiop");
       gfxInfo.spoofDriverVersion("5");
       break;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function checkBlacklist()
   {
     var status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT2D);
     do_check_eq(status, Ci.nsIGfxInfo.FEATURE_BLOCKED_DRIVER_VERSION);
 
     // Make sure unrelated features aren't affected
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_GTE_DriverOld.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_GTE_DriverOld.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_GTE_DriverOld.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_GTE_DriverOld.js
@@ -3,26 +3,30 @@
  */
 
 // Test whether a machine which is lower than the greater-than-or-equal
 // blacklist entry is allowed.
 // Uses test_gfxBlacklist.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
+mapFile("/data/test_gfxBlacklist.xml", gTestserver);
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -62,20 +66,16 @@ function run_test() {
       gfxInfo.spoofDeviceID("ghjk");
       gfxInfo.spoofDriverVersion("6");
       break;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function checkBlacklist()
   {
     var status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT2D);
     do_check_eq(status, Ci.nsIGfxInfo.FEATURE_NO_INFO);
 
     // Make sure unrelated features aren't affected
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_GTE_OK.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_GTE_OK.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_GTE_OK.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_GTE_OK.js
@@ -3,26 +3,30 @@
  */
 
 // Test whether a machine which exactly matches the greater-than-or-equal
 // blacklist entry is successfully blocked.
 // Uses test_gfxBlacklist.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
+mapFile("/data/test_gfxBlacklist.xml", gTestserver);
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -62,20 +66,16 @@ function run_test() {
       gfxInfo.spoofDeviceID("ghjk");
       gfxInfo.spoofDriverVersion("7");
       break;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function checkBlacklist()
   {
     var status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT2D);
     do_check_eq(status, Ci.nsIGfxInfo.FEATURE_BLOCKED_DRIVER_VERSION);
 
     // Make sure unrelated features aren't affected
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_No_Comparison.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_No_Comparison.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_No_Comparison.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_No_Comparison.js
@@ -3,26 +3,30 @@
  */
 
 // Test whether a machine which exactly matches the blacklist entry is
 // successfully blocked.
 // Uses test_gfxBlacklist.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
+mapFile("/data/test_gfxBlacklist.xml", gTestserver);
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -56,20 +60,16 @@ function run_test() {
       break;
     case "Android":
       break;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function checkBlacklist()
   {
     var status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT2D);
     do_check_eq(status, Ci.nsIGfxInfo.FEATURE_BLOCKED_DEVICE);
 
     // Make sure unrelated features aren't affected
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OK.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OK.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OK.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OK.js
@@ -3,26 +3,30 @@
  */
 
 // Test whether a machine which exactly matches the blacklist entry is
 // successfully blocked.
 // Uses test_gfxBlacklist.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
+mapFile("/data/test_gfxBlacklist.xml", gTestserver);
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -63,20 +67,16 @@ function run_test() {
       gfxInfo.spoofDeviceID("asdf");
       gfxInfo.spoofDriverVersion("5");
       break;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function checkBlacklist()
   {
     var status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT2D);
     do_check_eq(status, Ci.nsIGfxInfo.FEATURE_BLOCKED_DRIVER_VERSION);
 
     // Make sure unrelated features aren't affected
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OS.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OS.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OS.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OS.js
@@ -3,26 +3,30 @@
  */
 
 // Test whether a machine which differs only on OS version, but otherwise
 // exactly matches the blacklist entry, is not blocked.
 // Uses test_gfxBlacklist.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
+mapFile("/data/test_gfxBlacklist.xml", gTestserver);
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -64,20 +68,16 @@ function run_test() {
       // there's so many of them).
       do_test_finished();
       return;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function checkBlacklist()
   {
     var status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT2D);
     do_check_eq(status, Ci.nsIGfxInfo.FEATURE_NO_INFO);
 
     status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT3D_9_LAYERS);
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OSVersion_match.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OSVersion_match.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OSVersion_match.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OSVersion_match.js
@@ -2,26 +2,29 @@
  * http://creativecommons.org/publicdomain/zero/1.0/
  */
 
 // Test whether new OS versions are matched properly.
 // Uses test_gfxBlacklist_OS.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -63,20 +66,16 @@ function run_test() {
       // there's so many of them).
       do_test_finished();
       return;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function checkBlacklist()
   {
     if (get_platform() == "WINNT") {
       var status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT2D);
       do_check_eq(status, Ci.nsIGfxInfo.FEATURE_BLOCKED_DRIVER_VERSION);
     } else if (get_platform() == "Darwin") {
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OSVersion_mismatch_DriverVersion.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OSVersion_mismatch_DriverVersion.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OSVersion_mismatch_DriverVersion.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OSVersion_mismatch_DriverVersion.js
@@ -3,26 +3,29 @@
  */
 
 // Test whether blocklists specifying new OSeswcorrectly don't block if driver
 // versions are appropriately up-to-date.
 // Uses test_gfxBlacklist_OS.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -64,20 +67,16 @@ function run_test() {
       // there's so many of them).
       do_test_finished();
       return;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function checkBlacklist()
   {
     if (get_platform() == "WINNT") {
       var status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT2D);
       do_check_eq(status, Ci.nsIGfxInfo.FEATURE_NO_INFO);
     } else if (get_platform() == "Darwin") {
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OSVersion_mismatch_OSVersion.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OSVersion_mismatch_OSVersion.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OSVersion_mismatch_OSVersion.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_OSVersion_mismatch_OSVersion.js
@@ -3,26 +3,29 @@
  */
 
 // Test whether old OS versions are not matched when the blacklist contains
 // only new OS versions.
 // Uses test_gfxBlacklist_OS.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -64,20 +67,16 @@ function run_test() {
       // there's so many of them).
       do_test_finished();
       return;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function checkBlacklist()
   {
     if (get_platform() == "WINNT") {
       var status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT2D);
       do_check_eq(status, Ci.nsIGfxInfo.FEATURE_NO_INFO);
     } else if (get_platform() == "Darwin") {
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Vendor.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Vendor.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Vendor.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_Vendor.js
@@ -3,26 +3,30 @@
  */
 
 // Test whether a machine which differs only on vendor, but otherwise
 // exactly matches the blacklist entry, is not blocked.
 // Uses test_gfxBlacklist.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
+mapFile("/data/test_gfxBlacklist.xml", gTestserver);
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -63,20 +67,16 @@ function run_test() {
       gfxInfo.spoofDeviceID("asdf");
       gfxInfo.spoofDriverVersion("5");
       break;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function checkBlacklist()
   {
     var status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT2D);
     do_check_eq(status, Ci.nsIGfxInfo.FEATURE_NO_INFO);
 
     status = gfxInfo.getFeatureStatus(Ci.nsIGfxInfo.FEATURE_DIRECT3D_9_LAYERS);
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_prefs.js b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_prefs.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_prefs.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_gfxBlacklist_prefs.js
@@ -3,26 +3,30 @@
  */
 
 // Test whether the blacklist succesfully adds and removes the prefs that store
 // its decisions when the remote blacklist is changed.
 // Uses test_gfxBlacklist.xml and test_gfxBlacklist2.xml
 
 Components.utils.import("resource://testing-common/httpd.js");
 
-var gTestserver = null;
+var gTestserver = new HttpServer();
+gTestserver.start(-1);
+gPort = gTestserver.identity.primaryPort;
+mapFile("/data/test_gfxBlacklist.xml", gTestserver);
 
 function get_platform() {
   var xulRuntime = Components.classes["@mozilla.org/xre/app-info;1"]
                              .getService(Components.interfaces.nsIXULRuntime);
   return xulRuntime.OS;
 }
 
 function load_blocklist(file) {
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/" + file);
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" +
+                             gPort + "/data/" + file);
   var blocklist = Cc["@mozilla.org/extensions/blocklist;1"].
                   getService(Ci.nsITimerCallback);
   blocklist.notify(null);
 }
 
 // Performs the initial setup
 function run_test() {
   try {
@@ -63,20 +67,16 @@ function run_test() {
       gfxInfo.spoofDeviceID("asdf");
       gfxInfo.spoofDriverVersion("5");
       break;
   }
 
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "3", "8");
   startupManager();
 
-  gTestserver = new HttpServer();
-  gTestserver.registerDirectory("/data/", do_get_file("data"));
-  gTestserver.start(4444);
-
   do_test_pending();
 
   function blacklistAdded(aSubject, aTopic, aData)
   {
     // If we wait until after we go through the event loop, gfxInfo is sure to
     // have processed the gfxItems event.
     do_execute_soon(ensureBlacklistSet);
   }
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_hotfix.js b/toolkit/mozapps/extensions/test/xpcshell/test_hotfix.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_hotfix.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_hotfix.js
@@ -5,43 +5,45 @@
 // This verifies that hotfix installation works
 
 // The test extension uses an insecure update url.
 Services.prefs.setBoolPref("extensions.checkUpdateSecurity", false);
 // Ignore any certificate requirements the app has set
 Services.prefs.setBoolPref("extensions.hotfix.cert.checkAttributes", false);
 
 Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+testserver.registerDirectory("/addons/", do_get_file("addons"));
+mapFile("/data/test_hotfix_1.rdf", testserver);
+mapFile("/data/test_hotfix_2.rdf", testserver);
+mapFile("/data/test_hotfix_3.rdf", testserver);
+
 const profileDir = gProfD.clone();
 profileDir.append("extensions");
 
 function run_test() {
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9.2");
 
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/data/", do_get_file("data"));
-  testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.start(4444);
-
   startupManager();
 
   do_test_pending();
   run_test_1();
 }
 
 function end_test() {
   testserver.stop(do_test_finished);
 }
 
 // Test that background updates find and install any available hotfix
 function run_test_1() {
   Services.prefs.setCharPref("extensions.hotfix.id", "hotfix@tests.mozilla.org");
-  Services.prefs.setCharPref("extensions.update.background.url", "http://localhost:4444/data/test_hotfix_1.rdf");
+  Services.prefs.setCharPref("extensions.update.background.url", "http://localhost:" +
+                             gPort + "/data/test_hotfix_1.rdf");
 
   prepare_test({
     "hotfix@tests.mozilla.org": [
       "onInstalling"
     ]
   }, [
     "onNewInstall",
     "onDownloadStarted",
@@ -85,17 +87,18 @@ function run_test_2() {
 
   // Fake a timer event
   gInternalManager.notify(null);
 }
 
 // Install a newer hotfix
 function run_test_3() {
   restartManager();
-  Services.prefs.setCharPref("extensions.hotfix.url", "http://localhost:4444/data/test_hotfix_2.rdf");
+  Services.prefs.setCharPref("extensions.hotfix.url", "http://localhost:" +
+                             gPort + "/data/test_hotfix_2.rdf");
 
   prepare_test({
     "hotfix@tests.mozilla.org": [
       "onInstalling"
     ]
   }, [
     "onNewInstall",
     "onDownloadStarted",
@@ -119,17 +122,18 @@ function check_test_3() {
     do_execute_soon(run_test_4);
   });
 }
 
 // Don't install an incompatible hotfix
 function run_test_4() {
   restartManager();
 
-  Services.prefs.setCharPref("extensions.hotfix.url", "http://localhost:4444/data/test_hotfix_3.rdf");
+  Services.prefs.setCharPref("extensions.hotfix.url", "http://localhost:" +
+                             gPort + "/data/test_hotfix_3.rdf");
 
   AddonManager.addInstallListener({
     onNewInstall: function() {
       do_throw("Should not have seen a new install created");
     }
   });
 
   function observer() {
@@ -142,17 +146,18 @@ function run_test_4() {
   // Fake a timer event
   gInternalManager.notify(null);
 }
 
 // Don't install an older hotfix
 function run_test_5() {
   restartManager();
 
-  Services.prefs.setCharPref("extensions.hotfix.url", "http://localhost:4444/data/test_hotfix_1.rdf");
+  Services.prefs.setCharPref("extensions.hotfix.url", "http://localhost:" +
+                             gPort + "/data/test_hotfix_1.rdf");
 
   AddonManager.addInstallListener({
     onNewInstall: function() {
       do_throw("Should not have seen a new install created");
     }
   });
 
   function observer() {
@@ -166,17 +171,18 @@ function run_test_5() {
   gInternalManager.notify(null);
 }
 
 // Don't re-download an already pending install
 function run_test_6() {
   restartManager();
 
   Services.prefs.setCharPref("extensions.hotfix.lastVersion", "0");
-  Services.prefs.setCharPref("extensions.hotfix.url", "http://localhost:4444/data/test_hotfix_1.rdf");
+  Services.prefs.setCharPref("extensions.hotfix.url", "http://localhost:" +
+                             gPort + "/data/test_hotfix_1.rdf");
 
   prepare_test({
     "hotfix@tests.mozilla.org": [
       "onInstalling"
     ]
   }, [
     "onNewInstall",
     "onDownloadStarted",
@@ -273,17 +279,18 @@ function finish_test_7() {
   });
 }
 
 // Cancel a pending install when a newer version is already available
 function run_test_8() {
   restartManager();
 
   Services.prefs.setCharPref("extensions.hotfix.lastVersion", "0");
-  Services.prefs.setCharPref("extensions.hotfix.url", "http://localhost:4444/data/test_hotfix_1.rdf");
+  Services.prefs.setCharPref("extensions.hotfix.url", "http://localhost:" +
+                             gPort + "/data/test_hotfix_1.rdf");
 
   prepare_test({
     "hotfix@tests.mozilla.org": [
       "onInstalling"
     ]
   }, [
     "onNewInstall",
     "onDownloadStarted",
@@ -292,17 +299,18 @@ function run_test_8() {
     "onInstallEnded",
   ], check_test_8);
 
   // Fake a timer event
   gInternalManager.notify(null);
 }
 
 function check_test_8() {
-  Services.prefs.setCharPref("extensions.hotfix.url", "http://localhost:4444/data/test_hotfix_2.rdf");
+  Services.prefs.setCharPref("extensions.hotfix.url", "http://localhost:" +
+                             gPort + "/data/test_hotfix_2.rdf");
 
   prepare_test({
     "hotfix@tests.mozilla.org": [
       "onOperationCancelled",
       "onInstalling"
     ]
   }, [
     "onNewInstall",
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_install.js b/toolkit/mozapps/extensions/test/xpcshell/test_install.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_install.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_install.js
@@ -44,17 +44,18 @@ function run_test() {
   testserver = new HttpServer();
   testserver.registerDirectory("/addons/", do_get_file("addons"));
   testserver.registerDirectory("/data/", do_get_file("data"));
   testserver.registerPathHandler("/redirect", function(aRequest, aResponse) {
     aResponse.setStatusLine(null, 301, "Moved Permanently");
     let url = aRequest.host + ":" + aRequest.port + aRequest.queryString;
     aResponse.setHeader("Location", "http://" + url);
   });
-  testserver.start(4444);
+  testserver.start(-1);
+  gPort = testserver.identity.primaryPort;
 
   do_test_pending();
   run_test_1();
 }
 
 function end_test() {
   testserver.stop(do_test_finished);
 }
@@ -201,17 +202,17 @@ function check_test_1(installSyncGUID) {
         });
       });
     });
   });
 }
 
 // Tests that an install from a url downloads.
 function run_test_2() {
-  let url = "http://localhost:4444/addons/test_install2_1.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install2_1.xpi";
   AddonManager.getInstallForURL(url, function(install) {
     do_check_neq(install, null);
     do_check_eq(install.linkedInstalls, null);
     do_check_eq(install.version, "1.0");
     do_check_eq(install.name, "Test 2");
     do_check_eq(install.state, AddonManager.STATE_AVAILABLE);
     do_check_eq(install.iconURL, null);
     do_check_eq(install.sourceURI.spec, url);
@@ -286,17 +287,17 @@ function check_test_3(aInstall) {
         do_check_neq(a2.syncGUID, null);
         do_check_eq(a2.type, "extension");
         do_check_eq(a2.version, "2.0");
         do_check_eq(a2.name, "Real Test 2");
         do_check_true(isExtensionInAddonsList(profileDir, a2.id));
         do_check_true(do_get_addon("test_install2_1").exists());
         do_check_in_crash_annotation(a2.id, a2.version);
         do_check_eq(a2.sourceURI.spec,
-                    "http://localhost:4444/addons/test_install2_1.xpi");
+                    "http://localhost:" + gPort + "/addons/test_install2_1.xpi");
 
         let difference = a2.installDate.getTime() - updateDate;
         if (Math.abs(difference) > MAX_TIME_DIFFERENCE)
           do_throw("Add-on install time was out by " + difference + "ms");
 
         difference = a2.updateDate.getTime() - updateDate;
         if (Math.abs(difference) > MAX_TIME_DIFFERENCE)
           do_throw("Add-on update time was out by " + difference + "ms");
@@ -310,17 +311,17 @@ function check_test_3(aInstall) {
 }
 
 // Tests that installing a new version of an existing add-on works
 function run_test_4() {
   prepare_test({ }, [
     "onNewInstall"
   ]);
 
-  let url = "http://localhost:4444/addons/test_install2_2.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install2_2.xpi";
   AddonManager.getInstallForURL(url, function(install) {
     ensure_test_completed();
 
     do_check_neq(install, null);
     do_check_eq(install.version, "3.0");
     do_check_eq(install.name, "Test 3");
     do_check_eq(install.state, AddonManager.STATE_AVAILABLE);
 
@@ -388,17 +389,17 @@ function check_test_5(install) {
           do_check_eq(a2.type, "extension");
           do_check_eq(a2.version, "3.0");
           do_check_eq(a2.name, "Real Test 3");
           do_check_true(a2.isActive);
           do_check_true(isExtensionInAddonsList(profileDir, a2.id));
           do_check_true(do_get_addon("test_install2_2").exists());
           do_check_in_crash_annotation(a2.id, a2.version);
           do_check_eq(a2.sourceURI.spec,
-                      "http://localhost:4444/addons/test_install2_2.xpi");
+                      "http://localhost:" + gPort + "/addons/test_install2_2.xpi");
           do_check_false(a2.foreignInstall);
 
           do_check_eq(a2.installDate.getTime(), gInstallDate);
           // Update date should be later (or the same if this test is too fast)
           do_check_true(a2.installDate <= a2.updateDate);
 
           a2.uninstall();
           restartManager();
@@ -411,17 +412,17 @@ function check_test_5(install) {
 }
 
 // Tests that an install that requires a compatibility update works
 function run_test_6() {
   prepare_test({ }, [
     "onNewInstall"
   ]);
 
-  let url = "http://localhost:4444/addons/test_install3.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install3.xpi";
   AddonManager.getInstallForURL(url, function(install) {
     ensure_test_completed();
 
     do_check_neq(install, null);
     do_check_eq(install.version, "1.0");
     do_check_eq(install.name, "Real Test 4");
     do_check_eq(install.state, AddonManager.STATE_AVAILABLE);
 
@@ -533,17 +534,17 @@ function check_test_8() {
 }
 
 // Test that after cancelling a download it is removed from the active installs
 function run_test_9() {
   prepare_test({ }, [
     "onNewInstall"
   ]);
 
-  let url = "http://localhost:4444/addons/test_install3.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install3.xpi";
   AddonManager.getInstallForURL(url, function(install) {
     ensure_test_completed();
 
     do_check_neq(install, null);
     do_check_eq(install.version, "1.0");
     do_check_eq(install.name, "Real Test 4");
     do_check_eq(install.state, AddonManager.STATE_AVAILABLE);
 
@@ -578,17 +579,17 @@ function check_test_9(install) {
 
 // Tests that after cancelling a pending install it is removed from the active
 // installs
 function run_test_10() {
   prepare_test({ }, [
     "onNewInstall"
   ]);
 
-  let url = "http://localhost:4444/addons/test_install3.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install3.xpi";
   AddonManager.getInstallForURL(url, function(install) {
     ensure_test_completed();
 
     do_check_neq(install, null);
     do_check_eq(install.version, "1.0");
     do_check_eq(install.name, "Real Test 4");
     do_check_eq(install.state, AddonManager.STATE_AVAILABLE);
 
@@ -777,17 +778,17 @@ function check_test_11() {
 }
 
 // Same as test 11 but for a remote XPI
 function run_test_12() {
   prepare_test({ }, [
     "onNewInstall",
   ]);
 
-  let url = "http://localhost:4444/addons/test_install4.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install4.xpi";
   AddonManager.getInstallForURL(url, function(install) {
     gInstall = install;
 
     ensure_test_completed();
     do_check_neq(install, null);
     do_check_eq(install.linkedInstalls, null);
     do_check_eq(install.state, AddonManager.STATE_AVAILABLE);
 
@@ -907,17 +908,17 @@ function check_test_12() {
 function run_test_13() {
   installAllFiles([do_get_addon("test_install2_1")], function() {
     restartManager();
 
     prepare_test({ }, [
       "onNewInstall"
     ]);
 
-    let url = "http://localhost:4444/addons/test_install2_2.xpi";
+    let url = "http://localhost:" + gPort + "/addons/test_install2_2.xpi";
     AddonManager.getInstallForURL(url, function(install) {
       ensure_test_completed();
 
       do_check_neq(install, null);
       do_check_eq(install.version, "3.0");
       do_check_eq(install.name, "Test 3");
       do_check_eq(install.state, AddonManager.STATE_AVAILABLE);
 
@@ -991,17 +992,17 @@ function check_test_13(install) {
 }
 
 // Check that cancelling the install from onDownloadStarted actually cancels it
 function run_test_14() {
   prepare_test({ }, [
     "onNewInstall"
   ]);
 
-  let url = "http://localhost:4444/addons/test_install2_1.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install2_1.xpi";
   AddonManager.getInstallForURL(url, function(install) {
     ensure_test_completed();
 
     do_check_eq(install.file, null);
 
     prepare_test({ }, [
       "onDownloadStarted"
     ], check_test_14);
@@ -1038,17 +1039,17 @@ function check_test_14(install) {
 }
 
 // Checks that cancelling the install from onDownloadEnded actually cancels it
 function run_test_15() {
   prepare_test({ }, [
     "onNewInstall"
   ]);
 
-  let url = "http://localhost:4444/addons/test_install2_1.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install2_1.xpi";
   AddonManager.getInstallForURL(url, function(install) {
     ensure_test_completed();
 
     do_check_eq(install.file, null);
 
     prepare_test({ }, [
       "onDownloadStarted",
       "onDownloadEnded"
@@ -1075,33 +1076,33 @@ function check_test_15(install) {
   // Allow the listener to return to see if it starts installing
   do_execute_soon(run_test_16);
 }
 
 // Verify that the userDisabled value carries over to the upgrade by default
 function run_test_16() {
   restartManager();
 
-  let url = "http://localhost:4444/addons/test_install2_1.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install2_1.xpi";
   AddonManager.getInstallForURL(url, function(aInstall) {
     aInstall.addListener({
       onInstallStarted: function() {
         do_check_false(aInstall.addon.userDisabled);
         aInstall.addon.userDisabled = true;
       },
 
       onInstallEnded: function() {
        do_execute_soon(function install2_1_ended() {
         restartManager();
 
         AddonManager.getAddonByID("addon2@tests.mozilla.org", function(a2) {
           do_check_true(a2.userDisabled);
           do_check_false(a2.isActive);
 
-          let url = "http://localhost:4444/addons/test_install2_2.xpi";
+          let url = "http://localhost:" + gPort + "/addons/test_install2_2.xpi";
           AddonManager.getInstallForURL(url, function(aInstall) {
             aInstall.addListener({
               onInstallEnded: function() {
                do_execute_soon(function install2_2_ended() {
                 do_check_true(aInstall.addon.userDisabled);
 
                 restartManager();
 
@@ -1124,30 +1125,30 @@ function run_test_16() {
     aInstall.install();
   }, "application/x-xpinstall");
 }
 
 // Verify that changing the userDisabled value before onInstallEnded works
 function run_test_17() {
   restartManager();
 
-  let url = "http://localhost:4444/addons/test_install2_1.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install2_1.xpi";
   AddonManager.getInstallForURL(url, function(aInstall) {
     aInstall.addListener({
       onInstallEnded: function() {
        do_execute_soon(function install2_1_ended2() {
         do_check_false(aInstall.addon.userDisabled);
 
         restartManager();
 
         AddonManager.getAddonByID("addon2@tests.mozilla.org", function(a2) {
           do_check_false(a2.userDisabled);
           do_check_true(a2.isActive);
 
-          let url = "http://localhost:4444/addons/test_install2_2.xpi";
+          let url = "http://localhost:" + gPort + "/addons/test_install2_2.xpi";
           AddonManager.getInstallForURL(url, function(aInstall) {
             aInstall.addListener({
               onInstallStarted: function() {
                 do_check_false(aInstall.addon.userDisabled);
                 aInstall.addon.userDisabled = true;
               },
 
               onInstallEnded: function() {
@@ -1173,33 +1174,33 @@ function run_test_17() {
     aInstall.install();
   }, "application/x-xpinstall");
 }
 
 // Verify that changing the userDisabled value before onInstallEnded works
 function run_test_18() {
   restartManager();
 
-  let url = "http://localhost:4444/addons/test_install2_1.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install2_1.xpi";
   AddonManager.getInstallForURL(url, function(aInstall) {
     aInstall.addListener({
       onInstallStarted: function() {
         do_check_false(aInstall.addon.userDisabled);
         aInstall.addon.userDisabled = true;
       },
 
       onInstallEnded: function() {
        do_execute_soon(function install_2_1_ended3() {
         restartManager();
 
         AddonManager.getAddonByID("addon2@tests.mozilla.org", function(a2) {
           do_check_true(a2.userDisabled);
           do_check_false(a2.isActive);
 
-          let url = "http://localhost:4444/addons/test_install2_2.xpi";
+          let url = "http://localhost:" + gPort + "/addons/test_install2_2.xpi";
           AddonManager.getInstallForURL(url, function(aInstall) {
             aInstall.addListener({
               onInstallStarted: function() {
                 do_check_true(aInstall.addon.userDisabled);
                 aInstall.addon.userDisabled = false;
               },
 
               onInstallEnded: function() {
@@ -1228,21 +1229,21 @@ function run_test_18() {
 
 
 // Checks that metadata is not stored if the pref is set to false
 function run_test_18_1() {
   restartManager();
 
   Services.prefs.setBoolPref("extensions.getAddons.cache.enabled", true);
   Services.prefs.setCharPref("extensions.getAddons.get.url",
-                             "http://localhost:4444/data/test_install.xml");
+                             "http://localhost:" + gPort + "/data/test_install.xml");
 
   Services.prefs.setBoolPref("extensions.addon2@tests.mozilla.org.getAddons.cache.enabled", false);
 
-  let url = "http://localhost:4444/addons/test_install2_1.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install2_1.xpi";
   AddonManager.getInstallForURL(url, function(aInstall) {
     aInstall.addListener({
       onInstallEnded: function(aInstall, aAddon) {
        do_execute_soon(function test18_1_install_ended() {
         do_check_neq(aAddon.fullDescription, "Repository description");
 
         restartManager();
 
@@ -1260,17 +1261,17 @@ function run_test_18_1() {
 }
 
 // Checks that metadata is downloaded for new installs and is visible before and
 // after restart
 function run_test_19() {
   restartManager();
   Services.prefs.setBoolPref("extensions.addon2@tests.mozilla.org.getAddons.cache.enabled", true);
 
-  let url = "http://localhost:4444/addons/test_install2_1.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install2_1.xpi";
   AddonManager.getInstallForURL(url, function(aInstall) {
     aInstall.addListener({
       onInstallEnded: function(aInstall, aAddon) {
        do_execute_soon(function test19_install_ended() {
         do_check_eq(aAddon.fullDescription, "Repository description");
 
         restartManager();
 
@@ -1286,17 +1287,17 @@ function run_test_19() {
     aInstall.install();
   }, "application/x-xpinstall");
 }
 
 // Do the same again to make sure it works when the data is already in the cache
 function run_test_20() {
   restartManager();
 
-  let url = "http://localhost:4444/addons/test_install2_1.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install2_1.xpi";
   AddonManager.getInstallForURL(url, function(aInstall) {
     aInstall.addListener({
       onInstallEnded: function(aInstall, aAddon) {
        do_execute_soon(function test20_install_ended() {
         do_check_eq(aAddon.fullDescription, "Repository description");
 
         restartManager();
 
@@ -1332,17 +1333,17 @@ function run_test_21() {
         "onNewInstall",
         "onDownloadStarted",
         "onDownloadEnded",
         "onInstallStarted",
         "onInstallCancelled",
         "onInstallEnded",
       ], check_test_21);
 
-      let url = "http://localhost:4444/addons/test_install2_1.xpi";
+      let url = "http://localhost:" + gPort + "/addons/test_install2_1.xpi";
       AddonManager.getInstallForURL(url, function(aInstall) {
         aInstall.install();
       }, "application/x-xpinstall");
     });
   });
 }
 
 function check_test_21(aInstall) {
@@ -1373,17 +1374,17 @@ function check_test_21(aInstall) {
 }
 
 // Tests that an install can be restarted after being cancelled
 function run_test_22() {
   prepare_test({ }, [
     "onNewInstall"
   ]);
 
-  let url = "http://localhost:4444/addons/test_install3.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install3.xpi";
   AddonManager.getInstallForURL(url, function(aInstall) {
     ensure_test_completed();
 
     do_check_neq(aInstall, null);
     do_check_eq(aInstall.state, AddonManager.STATE_AVAILABLE);
 
     prepare_test({}, [
       "onDownloadStarted",
@@ -1434,17 +1435,17 @@ function finish_test_22(aInstall) {
 
 // Tests that an install can be restarted after being cancelled when a hash
 // was provided
 function run_test_23() {
   prepare_test({ }, [
     "onNewInstall"
   ]);
 
-  let url = "http://localhost:4444/addons/test_install3.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install3.xpi";
   AddonManager.getInstallForURL(url, function(aInstall) {
     ensure_test_completed();
 
     do_check_neq(aInstall, null);
     do_check_eq(aInstall.state, AddonManager.STATE_AVAILABLE);
 
     prepare_test({}, [
       "onDownloadStarted",
@@ -1495,17 +1496,17 @@ function finish_test_23(aInstall) {
 
 // Tests that an install with a bad hash can be restarted after it fails, though
 // it will only fail again
 function run_test_24() {
   prepare_test({ }, [
     "onNewInstall"
   ]);
 
-  let url = "http://localhost:4444/addons/test_install3.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install3.xpi";
   AddonManager.getInstallForURL(url, function(aInstall) {
     ensure_test_completed();
 
     do_check_neq(aInstall, null);
     do_check_eq(aInstall.state, AddonManager.STATE_AVAILABLE);
 
     prepare_test({}, [
       "onDownloadStarted",
@@ -1559,31 +1560,31 @@ function run_test_26() {
 
   let observerService = AM_Cc["@mozilla.org/network/http-activity-distributor;1"].
                         getService(AM_Ci.nsIHttpActivityDistributor);
   observerService.addObserver({
     observeActivity: function(aChannel, aType, aSubtype, aTimestamp, aSizeData,
                               aStringData) {
       aChannel.QueryInterface(AM_Ci.nsIChannel);
       // Wait for the final event for the redirected URL
-      if (aChannel.URI.spec != "http://localhost:4444/addons/test_install1.xpi" ||
+      if (aChannel.URI.spec != "http://localhost:" + gPort + "/addons/test_install1.xpi" ||
           aType != AM_Ci.nsIHttpActivityObserver.ACTIVITY_TYPE_HTTP_TRANSACTION ||
           aSubtype != AM_Ci.nsIHttpActivityObserver.ACTIVITY_SUBTYPE_TRANSACTION_CLOSE)
         return;
 
       // Request should have been cancelled
       do_check_eq(aChannel.status, Components.results.NS_BINDING_ABORTED);
 
       observerService.removeObserver(this);
 
       run_test_27();
     }
   });
 
-  let url = "http://localhost:4444/redirect?/addons/test_install1.xpi";
+  let url = "http://localhost:" + gPort + "/redirect?/addons/test_install1.xpi";
   AddonManager.getInstallForURL(url, function(aInstall) {
     aInstall.addListener({
       onDownloadProgress: function(aInstall) {
         aInstall.cancel();
       }
     });
 
     aInstall.install();
@@ -1593,17 +1594,17 @@ function run_test_26() {
 
 // Tests that an install can be restarted during onDownloadCancelled after being
 // cancelled in mid-download
 function run_test_27() {
   prepare_test({ }, [
     "onNewInstall"
   ]);
 
-  let url = "http://localhost:4444/addons/test_install3.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install3.xpi";
   AddonManager.getInstallForURL(url, function(aInstall) {
     ensure_test_completed();
 
     do_check_neq(aInstall, null);
     do_check_eq(aInstall.state, AddonManager.STATE_AVAILABLE);
 
     aInstall.addListener({
       onDownloadProgress: function() {
@@ -1653,17 +1654,17 @@ function finish_test_27(aInstall) {
 
 // Tests that an install that isn't strictly compatible and has
 // binary components correctly has appDisabled set (see bug 702868).
 function run_test_28() {
   prepare_test({ }, [
     "onNewInstall"
   ]);
 
-  let url = "http://localhost:4444/addons/test_install5.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install5.xpi";
   AddonManager.getInstallForURL(url, function(install) {
     ensure_test_completed();
 
     do_check_neq(install, null);
     do_check_eq(install.version, "1.0");
     do_check_eq(install.name, "Real Test 5");
     do_check_eq(install.state, AddonManager.STATE_AVAILABLE);
 
@@ -1708,17 +1709,17 @@ function finish_test_28(install) {
 // set correctly.
 function run_test_29() {
   Services.prefs.setBoolPref("extensions.getAddons.cache.enabled", true);
 
   prepare_test({ }, [
     "onNewInstall"
   ]);
 
-  let url = "http://localhost:4444/addons/test_install6.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install6.xpi";
   AddonManager.getInstallForURL(url, function(install) {
     ensure_test_completed();
 
     do_check_neq(install, null);
     do_check_eq(install.version, "1.0");
     do_check_eq(install.name, "Addon Test 6");
     do_check_eq(install.state, AddonManager.STATE_AVAILABLE);
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_install_icons.js b/toolkit/mozapps/extensions/test/xpcshell/test_install_icons.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_install_icons.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_install_icons.js
@@ -1,15 +1,21 @@
 /* Any copyright is dedicated to the Public Domain.
  * http://creativecommons.org/publicdomain/zero/1.0/
  */
 
-var addon_url = "http://localhost:4444/test.xpi";
-var icon32_url = "http://localhost:4444/icon.png";
-var icon64_url = "http://localhost:4444/icon64.png";
+// use httpserver to find an available port
+Components.utils.import("resource://testing-common/httpd.js");
+var gServer = new HttpServer();
+gServer.start(-1);
+gPort = gServer.identity.primaryPort;
+
+var addon_url = "http://localhost:" + gPort + "/test.xpi";
+var icon32_url = "http://localhost:" + gPort + "/icon.png";
+var icon64_url = "http://localhost:" + gPort + "/icon64.png";
 
 function run_test() {
   do_test_pending();
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9.2");
   startupManager();
 
   test_1();
 }
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_locked.js b/toolkit/mozapps/extensions/test/xpcshell/test_locked.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_locked.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_locked.js
@@ -1,17 +1,21 @@
 /* Any copyright is dedicated to the Public Domain.
  * http://creativecommons.org/publicdomain/zero/1.0/
  */
 
 // Checks that we rebuild something sensible from a corrupt database
 
 
 Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+mapFile("/data/test_corrupt.rdf", testserver);
+testserver.registerDirectory("/addons/", do_get_file("addons"));
 
 // The test extension uses an insecure update url.
 Services.prefs.setBoolPref(PREF_EM_CHECK_UPDATE_SECURITY, false);
 Services.prefs.setBoolPref(PREF_EM_STRICT_COMPATIBILITY, false);
 
 // Will be enabled
 var addon1 = {
   id: "addon1@tests.mozilla.org",
@@ -36,30 +40,30 @@ var addon2 = {
   }]
 };
 
 // Will get a compatibility update and stay enabled
 var addon3 = {
   id: "addon3@tests.mozilla.org",
   version: "1.0",
   name: "Test 3",
-  updateURL: "http://localhost:4444/data/test_corrupt.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/test_corrupt.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "1"
   }]
 };
 
 // Will get a compatibility update and be enabled
 var addon4 = {
   id: "addon4@tests.mozilla.org",
   version: "1.0",
   name: "Test 4",
-  updateURL: "http://localhost:4444/data/test_corrupt.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/test_corrupt.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "1"
   }]
 };
 
 // Would stay incompatible with strict compat
@@ -138,22 +142,16 @@ function run_test() {
   writeInstallRDFForExtension(addon3, profileDir);
   writeInstallRDFForExtension(addon4, profileDir);
   writeInstallRDFForExtension(addon5, profileDir);
   writeInstallRDFForExtension(addon6, profileDir);
   writeInstallRDFForExtension(addon7, profileDir);
   writeInstallRDFForExtension(theme1, profileDir);
   writeInstallRDFForExtension(theme2, profileDir);
 
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.registerDirectory("/data/", do_get_file("data"));
-  testserver.start(4444);
-
   // Startup the profile and setup the initial state
   startupManager();
 
   // New profile so new add-ons are ignored
   check_startup_changes(AddonManager.STARTUP_CHANGE_INSTALLED, []);
 
   AddonManager.getAddonsByIDs(["addon2@tests.mozilla.org",
                                "addon3@tests.mozilla.org",
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_locked_strictcompat.js b/toolkit/mozapps/extensions/test/xpcshell/test_locked_strictcompat.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_locked_strictcompat.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_locked_strictcompat.js
@@ -1,17 +1,21 @@
 /* Any copyright is dedicated to the Public Domain.
  * http://creativecommons.org/publicdomain/zero/1.0/
  */
 
 // Checks that we rebuild something sensible from a corrupt database
 
 
 Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+mapFile("/data/test_corrupt.rdf", testserver);
+testserver.registerDirectory("/addons/", do_get_file("addons"));
 
 // The test extension uses an insecure update url.
 Services.prefs.setBoolPref(PREF_EM_CHECK_UPDATE_SECURITY, false);
 Services.prefs.setBoolPref(PREF_EM_STRICT_COMPATIBILITY, true);
 
 // Will be enabled
 var addon1 = {
   id: "addon1@tests.mozilla.org",
@@ -36,30 +40,30 @@ var addon2 = {
   }]
 };
 
 // Will get a compatibility update and be enabled
 var addon3 = {
   id: "addon3@tests.mozilla.org",
   version: "1.0",
   name: "Test 3",
-  updateURL: "http://localhost:4444/data/test_corrupt.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/test_corrupt.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "1"
   }]
 };
 
 // Will get a compatibility update and be disabled
 var addon4 = {
   id: "addon4@tests.mozilla.org",
   version: "1.0",
   name: "Test 4",
-  updateURL: "http://localhost:4444/data/test_corrupt.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/test_corrupt.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "1"
   }]
 };
 
 // Stays incompatible
@@ -138,22 +142,16 @@ function run_test() {
   writeInstallRDFForExtension(addon3, profileDir);
   writeInstallRDFForExtension(addon4, profileDir);
   writeInstallRDFForExtension(addon5, profileDir);
   writeInstallRDFForExtension(addon6, profileDir);
   writeInstallRDFForExtension(addon7, profileDir);
   writeInstallRDFForExtension(theme1, profileDir);
   writeInstallRDFForExtension(theme2, profileDir);
 
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.registerDirectory("/data/", do_get_file("data"));
-  testserver.start(4444);
-
   // Startup the profile and setup the initial state
   startupManager();
 
   // New profile so new add-ons are ignored
   check_startup_changes(AddonManager.STARTUP_CHANGE_INSTALLED, []);
 
   AddonManager.getAddonsByIDs(["addon2@tests.mozilla.org",
                                "addon3@tests.mozilla.org",
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_mapURIToAddonID.js b/toolkit/mozapps/extensions/test/xpcshell/test_mapURIToAddonID.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_mapURIToAddonID.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_mapURIToAddonID.js
@@ -14,19 +14,16 @@ createAppInfo("xpcshell@tests.mozilla.or
 
 const profileDir = gProfD.clone();
 profileDir.append("extensions");
 const userExtDir = gProfD.clone();
 userExtDir.append("extensions2");
 userExtDir.append(gAppInfo.ID);
 registerDirectory("XREUSysExt", userExtDir.parent);
 
-Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
-
 function TestProvider(result) {
   this.result = result;
 }
 TestProvider.prototype = {
   uri: Services.io.newURI("hellow://world", null, null),
   id: "valid@id",
   startup: function() {},
   shutdown: function() {},
@@ -69,21 +66,16 @@ function getActiveVersion() {
   return Services.prefs.getIntPref("bootstraptest.active_version");
 }
 
 function run_test() {
   do_test_pending();
 
   resetPrefs();
 
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.start(4444);
-
   startupManager();
 
   run_test_nomapping();
 }
 
 function run_test_nomapping() {
   do_check_eq(AddonManager.mapURIToAddonID(TestProvider.prototype.uri), null);
   try {
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_migrate3.js b/toolkit/mozapps/extensions/test/xpcshell/test_migrate3.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_migrate3.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_migrate3.js
@@ -107,21 +107,21 @@ function run_test() {
   // Cannot use the LightweightThemeManager before AddonManager has been started
   // so inject the correct prefs
   Services.prefs.setCharPref("lightweightThemes.usedThemes", JSON.stringify([{
     id: "1",
     version: "1",
     name: "Test LW Theme",
     description: "A test theme",
     author: "Mozilla",
-    homepageURL: "http://localhost:4444/data/index.html",
-    headerURL: "http://localhost:4444/data/header.png",
-    footerURL: "http://localhost:4444/data/footer.png",
-    previewURL: "http://localhost:4444/data/preview.png",
-    iconURL: "http://localhost:4444/data/icon.png"
+    homepageURL: "http://localhost/data/index.html",
+    headerURL: "http://localhost/data/header.png",
+    footerURL: "http://localhost/data/footer.png",
+    previewURL: "http://localhost/data/preview.png",
+    iconURL: "http://localhost/data/icon.png"
   }]));
   Services.prefs.setBoolPref("lightweightThemes.isThemeSelected", true);
 
   let stagedXPIs = profileDir.clone();
   stagedXPIs.append("staged-xpis");
   stagedXPIs.append("addon6@tests.mozilla.org");
   stagedXPIs.create(AM_Ci.nsIFile.DIRECTORY_TYPE, 0755);
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_migrate4.js b/toolkit/mozapps/extensions/test/xpcshell/test_migrate4.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_migrate4.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_migrate4.js
@@ -2,16 +2,23 @@
  * http://creativecommons.org/publicdomain/zero/1.0/
  */
 
 // Checks that we migrate data from a previous version of the sqlite database
 
 // The test extension uses an insecure update url.
 Services.prefs.setBoolPref("extensions.checkUpdateSecurity", false);
 
+Components.utils.import("resource://testing-common/httpd.js");
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+mapFile("/data/test_migrate4.rdf", testserver);
+testserver.registerDirectory("/addons/", do_get_file("addons"));
+
 var addon1 = {
   id: "addon1@tests.mozilla.org",
   version: "1.0",
   name: "Test 1",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "1",
     maxVersion: "2"
@@ -51,29 +58,29 @@ var addon4 = {
     maxVersion: "2"
   }]
 };
 
 var addon5 = {
   id: "addon5@tests.mozilla.org",
   version: "2.0",
   name: "Test 5",
-  updateURL: "http://localhost:4444/data/test_migrate4.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/test_migrate4.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "0",
     maxVersion: "1"
   }]
 };
 
 var addon6 = {
   id: "addon6@tests.mozilla.org",
   version: "1.0",
   name: "Test 6",
-  updateURL: "http://localhost:4444/data/test_migrate4.rdf",
+  updateURL: "http://localhost:" + gPort + "/data/test_migrate4.rdf",
   targetApplications: [{
     id: "xpcshell@tests.mozilla.org",
     minVersion: "0",
     maxVersion: "1"
   }]
 };
 
 var defaultTheme = {
@@ -86,30 +93,21 @@ var defaultTheme = {
     minVersion: "1",
     maxVersion: "2"
   }]
 };
 
 const profileDir = gProfD.clone();
 profileDir.append("extensions");
 
-Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
-
 let oldSyncGUIDs = {};
 
 function prepare_profile() {
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9.2");
 
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/data/", do_get_file("data"));
-  testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.start(4444);
-
   writeInstallRDFForExtension(addon1, profileDir);
   writeInstallRDFForExtension(addon2, profileDir);
   writeInstallRDFForExtension(addon3, profileDir);
   writeInstallRDFForExtension(addon4, profileDir);
   writeInstallRDFForExtension(addon5, profileDir);
   writeInstallRDFForExtension(addon6, profileDir);
   writeInstallRDFForExtension(defaultTheme, profileDir);
 
@@ -135,17 +133,17 @@ function prepare_profile() {
       a9.userDisabled = false;
 
       for each (let addon in [a1, a2, a3, a4, a5, a6]) {
         oldSyncGUIDs[addon.id] = addon.syncGUID;
       }
 
       a6.findUpdates({
         onUpdateAvailable: function(aAddon, aInstall6) {
-          AddonManager.getInstallForURL("http://localhost:4444/addons/test_migrate4_7.xpi", function(aInstall7) {
+          AddonManager.getInstallForURL("http://localhost:" + gPort + "/addons/test_migrate4_7.xpi", function(aInstall7) {
             completeAllInstalls([aInstall6, aInstall7], function() {
               restartManager();
   
               AddonManager.getAddonsByIDs(["addon1@tests.mozilla.org",
                                            "addon2@tests.mozilla.org",
                                            "addon3@tests.mozilla.org",
                                            "addon4@tests.mozilla.org",
                                            "addon5@tests.mozilla.org",
@@ -263,30 +261,30 @@ function test_results() {
     do_check_neq(a6, null);
     do_check_eq(a6.syncGUID, oldSyncGUIDs[a6.id]);
     do_check_eq(a6.version, "2.0");
     do_check_true(a6.userDisabled);
     do_check_false(a6.appDisabled);
     do_check_false(a6.isActive);
     do_check_eq(a6.applyBackgroundUpdates, AddonManager.AUTOUPDATE_DEFAULT);
     do_check_true(a6.foreignInstall);
-    do_check_eq(a6.sourceURI.spec, "http://localhost:4444/addons/test_migrate4_6.xpi");
+    do_check_eq(a6.sourceURI.spec, "http://localhost:" + gPort + "/addons/test_migrate4_6.xpi");
     do_check_eq(a6.releaseNotesURI.spec, "http://example.com/updateInfo.xhtml");
     do_check_false(a6.hasBinaryComponents);
     do_check_false(a6.strictCompatibility);
 
     // addon7 was installed manually
     do_check_neq(a7, null);
     do_check_eq(a7.version, "1.0");
     do_check_false(a7.userDisabled);
     do_check_false(a7.appDisabled);
     do_check_true(a7.isActive);
     do_check_eq(a7.applyBackgroundUpdates, AddonManager.AUTOUPDATE_DEFAULT);
     do_check_false(a7.foreignInstall);
-    do_check_eq(a7.sourceURI.spec, "http://localhost:4444/addons/test_migrate4_7.xpi");
+    do_check_eq(a7.sourceURI.spec, "http://localhost:" + gPort + "/addons/test_migrate4_7.xpi");
     do_check_eq(a7.releaseNotesURI, null);
     do_check_false(a7.hasBinaryComponents);
     do_check_false(a7.strictCompatibility);
 
     // addon8 was enabled and has binary components
     do_check_neq(a8, null);
     do_check_false(a8.userDisabled);
     do_check_false(a8.appDisabled);
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_migrateAddonRepository.js b/toolkit/mozapps/extensions/test/xpcshell/test_migrateAddonRepository.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_migrateAddonRepository.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_migrateAddonRepository.js
@@ -64,18 +64,18 @@ function run_test() {
   stmt.execute();
   stmt.finalize();
 
   stmt = db.createStatement("INSERT INTO screenshot VALUES " +
                             "(:addon_internal_id, :num, :url, :thumbnailURL, :caption)");
 
   stmt.params.addon_internal_id = 1;
   stmt.params.num = 0;
-  stmt.params.url = "http://localhost:4444/full1-1.png";
-  stmt.params.thumbnailURL = "http://localhost:4444/thumbnail1-1.png";
+  stmt.params.url = "http://localhost/full1-1.png";
+  stmt.params.thumbnailURL = "http://localhost/thumbnail1-1.png";
   stmt.params.caption = "Caption 1 - 1";
   stmt.execute();
   stmt.finalize();
 
   db.schemaVersion = 1;
   db.close();
 
   Services.obs.addObserver({
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_pluginBlocklistCtp.js b/toolkit/mozapps/extensions/test/xpcshell/test_pluginBlocklistCtp.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_pluginBlocklistCtp.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_pluginBlocklistCtp.js
@@ -1,15 +1,26 @@
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 const nsIBLS = Components.interfaces.nsIBlocklistService;
 Components.utils.import("resource://testing-common/httpd.js");
 
+var gBlocklistService = null;
+var gNotifier = null;
+var gNextTest = null;
+var gPluginHost = null;
+
+var gServer = new HttpServer();
+gServer.start(-1);
+gPort = gServer.identity.primaryPort;
+mapFile("/data/test_pluginBlocklistCtp.xml", gServer);
+mapFile("/data/test_pluginBlocklistCtpUndo.xml", gServer);
+
 var PLUGINS = [{
   // severity=0, vulnerabilitystatus=0 -> outdated
   name: "test_plugin_0",
   version: "5",
   disabled: false,
   blocklisted: false
 },
 {
@@ -43,22 +54,16 @@ var PLUGINS = [{
 {
   // not in the blocklist -> not blocked
   name: "test_plugin_5",
   version: "5",
   disabled: false,
   blocklisted: false
 }];
 
-var gBlocklistService = null;
-var gNotifier = null;
-var gNextTest = null;
-var gServer = null;
-var gPluginHost = null;
-
 function test_basic() {
   var blocklist = Components.classes["@mozilla.org/extensions/blocklist;1"].getService(nsIBLS);
 
   do_check_true(blocklist.getPluginBlocklistState(PLUGINS[0], "1", "1.9") == nsIBLS.STATE_OUTDATED);
 
   do_check_true(blocklist.getPluginBlocklistState(PLUGINS[1], "1", "1.9") == nsIBLS.STATE_VULNERABLE_UPDATE_AVAILABLE);
 
   do_check_true(blocklist.getPluginBlocklistState(PLUGINS[2], "1", "1.9") == nsIBLS.STATE_VULNERABLE_NO_UPDATE);
@@ -86,42 +91,42 @@ function get_test_plugin() {
 // At this time, the blocklist does not have an entry for the test plugin,
 // so it shouldn't be click-to-play.
 function test_is_not_clicktoplay() {
   var plugin = get_test_plugin();
   var blocklistState = gBlocklistService.getPluginBlocklistState(plugin, "1", "1.9");
   do_check_neq(blocklistState, Components.interfaces.nsIBlocklistService.STATE_VULNERABLE_UPDATE_AVAILABLE);
   do_check_neq(blocklistState, Components.interfaces.nsIBlocklistService.STATE_VULNERABLE_NO_UPDATE);
 
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/test_pluginBlocklistCtpUndo.xml");
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" + gPort + "/data/test_pluginBlocklistCtpUndo.xml");
   gNextTest = test_is_clicktoplay;
   gNotifier.notify(null);
 }
 
 // Here, we've updated the blocklist to have a block for the test plugin,
 // so it should be click-to-play.
 function test_is_clicktoplay() {
   var plugin = get_test_plugin();
   var blocklistState = gBlocklistService.getPluginBlocklistState(plugin, "1", "1.9");
   do_check_eq(blocklistState, Components.interfaces.nsIBlocklistService.STATE_VULNERABLE_NO_UPDATE);
 
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/test_pluginBlocklistCtp.xml");
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" + gPort + "/data/test_pluginBlocklistCtp.xml");
   gNextTest = test_is_not_clicktoplay2;
   gNotifier.notify(null);
 }
 
 // But now we've removed that entry from the blocklist (really we've gone back
 // to the old one), so the plugin shouldn't be click-to-play any more.
 function test_is_not_clicktoplay2() {
   var plugin = get_test_plugin();
   var blocklistState = gBlocklistService.getPluginBlocklistState(plugin, "1", "1.9");
   do_check_neq(blocklistState, Components.interfaces.nsIBlocklistService.STATE_VULNERABLE_UPDATE_AVAILABLE);
   do_check_neq(blocklistState, Components.interfaces.nsIBlocklistService.STATE_VULNERABLE_NO_UPDATE);
 
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/test_pluginBlocklistCtpUndo.xml");
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" + gPort + "/data/test_pluginBlocklistCtpUndo.xml");
   gNextTest = test_disable_blocklist;
   gNotifier.notify(null);
 }
 
 // Test that disabling the blocklist when a plugin is ctp-blocklisted will
 // result in the plugin not being click-to-play.
 function test_disable_blocklist() {
   var plugin = get_test_plugin();
@@ -150,21 +155,17 @@ function test_disable_blocklist() {
 function observer() {
   if (gNextTest)
     do_execute_soon(gNextTest);
 }
 
 function run_test() {
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9");
 
-  gServer = new HttpServer();
-  gServer.registerDirectory("/data/", do_get_file("data"));
-  gServer.start(4444);
-
-  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:4444/data/test_pluginBlocklistCtp.xml");
+  Services.prefs.setCharPref("extensions.blocklist.url", "http://localhost:" + gPort + "/data/test_pluginBlocklistCtp.xml");
   startupManager();
 
   gPluginHost = Components.classes["@mozilla.org/plugin/host;1"].getService(Components.interfaces.nsIPluginHost);
   gBlocklistService = Components.classes["@mozilla.org/extensions/blocklist;1"].getService(Components.interfaces.nsIBlocklistService);
   gNotifier = Components.classes["@mozilla.org/extensions/blocklist;1"].getService(Components.interfaces.nsITimerCallback);
   Services.obs.addObserver(observer, "blocklist-updated", false);
 
   do_register_cleanup(function() {
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_theme.js b/toolkit/mozapps/extensions/test/xpcshell/test_theme.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_theme.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_theme.js
@@ -244,36 +244,36 @@ function run_test_3() {
   ]);
 
   LightweightThemeManager.currentTheme = {
     id: "1",
     version: "1",
     name: "Test LW Theme",
     description: "A test theme",
     author: "Mozilla",
-    homepageURL: "http://localhost:4444/data/index.html",
-    headerURL: "http://localhost:4444/data/header.png",
-    footerURL: "http://localhost:4444/data/footer.png",
-    previewURL: "http://localhost:4444/data/preview.png",
-    iconURL: "http://localhost:4444/data/icon.png"
+    homepageURL: "http://localhost/data/index.html",
+    headerURL: "http://localhost/data/header.png",
+    footerURL: "http://localhost/data/footer.png",
+    previewURL: "http://localhost/data/preview.png",
+    iconURL: "http://localhost/data/icon.png"
   };
 
   ensure_test_completed();
 
   AddonManager.getAddonByID("1@personas.mozilla.org", function(p1) {
     do_check_neq(null, p1);
     do_check_eq(p1.name, "Test LW Theme");
     do_check_eq(p1.version, "1");
     do_check_eq(p1.type, "theme");
     do_check_eq(p1.description, "A test theme");
     do_check_eq(p1.creator, "Mozilla");
-    do_check_eq(p1.homepageURL, "http://localhost:4444/data/index.html");
-    do_check_eq(p1.iconURL, "http://localhost:4444/data/icon.png");
+    do_check_eq(p1.homepageURL, "http://localhost/data/index.html");
+    do_check_eq(p1.iconURL, "http://localhost/data/icon.png");
     do_check_eq(p1.screenshots.length, 1);
-    do_check_eq(p1.screenshots[0], "http://localhost:4444/data/preview.png");
+    do_check_eq(p1.screenshots[0], "http://localhost/data/preview.png");
     do_check_false(p1.appDisabled);
     do_check_false(p1.userDisabled);
     do_check_true(p1.isCompatible);
     do_check_true(p1.providesUpdatesSecurely);
     do_check_eq(p1.blocklistState, 0);
     do_check_true(p1.isActive);
     do_check_eq(p1.pendingOperations, 0);
     do_check_eq(p1.permissions, AddonManager.PERM_CAN_UNINSTALL | AddonManager.PERM_CAN_DISABLE);
@@ -329,21 +329,21 @@ function run_test_4() {
   ]);
 
   LightweightThemeManager.currentTheme = {
     id: "2",
     version: "1",
     name: "Test LW Theme",
     description: "A second test theme",
     author: "Mozilla",
-    homepageURL: "http://localhost:4444/data/index.html",
-    headerURL: "http://localhost:4444/data/header.png",
-    footerURL: "http://localhost:4444/data/footer.png",
-    previewURL: "http://localhost:4444/data/preview.png",
-    iconURL: "http://localhost:4444/data/icon.png"
+    homepageURL: "http://localhost/data/index.html",
+    headerURL: "http://localhost/data/header.png",
+    footerURL: "http://localhost/data/footer.png",
+    previewURL: "http://localhost/data/preview.png",
+    iconURL: "http://localhost/data/icon.png"
   };
 
   ensure_test_completed();
 
   AddonManager.getAddonsByIDs(["1@personas.mozilla.org",
                                "2@personas.mozilla.org"], function([p1, p2]) {
     do_check_neq(null, p2);
     do_check_false(p2.appDisabled);
@@ -801,21 +801,21 @@ function check_test_13() {
 // a restart
 function run_test_14() {
   LightweightThemeManager.currentTheme = {
     id: "1",
     version: "1",
     name: "Test LW Theme",
     description: "A test theme",
     author: "Mozilla",
-    homepageURL: "http://localhost:4444/data/index.html",
-    headerURL: "http://localhost:4444/data/header.png",
-    footerURL: "http://localhost:4444/data/footer.png",
-    previewURL: "http://localhost:4444/data/preview.png",
-    iconURL: "http://localhost:4444/data/icon.png"
+    homepageURL: "http://localhost/data/index.html",
+    headerURL: "http://localhost/data/header.png",
+    footerURL: "http://localhost/data/footer.png",
+    previewURL: "http://localhost/data/preview.png",
+    iconURL: "http://localhost/data/icon.png"
   };
 
   AddonManager.getAddonByID("default@tests.mozilla.org", function(d) {
     do_check_true(d.userDisabled);
     do_check_false(d.isActive);
 
     prepare_test({
       "1@personas.mozilla.org": [
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_update.js b/toolkit/mozapps/extensions/test/xpcshell/test_update.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_update.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_update.js
@@ -20,61 +20,61 @@ Components.utils.import("resource://gre/
 
 const PARAMS = "?%REQ_VERSION%/%ITEM_ID%/%ITEM_VERSION%/%ITEM_MAXAPPVERSION%/" +
                "%ITEM_STATUS%/%APP_ID%/%APP_VERSION%/%CURRENT_APP_VERSION%/" +
                "%APP_OS%/%APP_ABI%/%APP_LOCALE%/%UPDATE_TYPE%";
 
 var gInstallDate;
 
 Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+mapFile("/data/test_update.rdf", testserver);
+mapFile("/data/test_update.xml", testserver);
+testserver.registerDirectory("/addons/", do_get_file("addons"));
+
 const profileDir = gProfD.clone();
 profileDir.append("extensions");
 
 let originalSyncGUID;
 
 function run_test() {
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9.2");
   Services.prefs.setBoolPref(PREF_MATCH_OS_LOCALE, false);
   Services.prefs.setCharPref(PREF_SELECTED_LOCALE, "fr-FR");
 
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/data/", do_get_file("data"));
-  testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.start(4444);
-
   writeInstallRDFForExtension({
     id: "addon1@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 1",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon2@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0",
       maxVersion: "0"
     }],
     name: "Test Addon 2",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon3@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "5",
       maxVersion: "5"
     }],
     name: "Test Addon 3",
   }, profileDir);
 
@@ -364,17 +364,17 @@ function check_test_5() {
 
 // Test that background update checks work
 function run_test_6() {
   restartManager();
 
   writeInstallRDFForExtension({
     id: "addon1@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 1",
   }, profileDir);
   restartManager();
@@ -422,48 +422,48 @@ function check_test_6(install) {
 // Test that background update checks work for lightweight themes
 function run_test_7() {
   LightweightThemeManager.currentTheme = {
     id: "1",
     version: "1",
     name: "Test LW Theme",
     description: "A test theme",
     author: "Mozilla",
-    homepageURL: "http://localhost:4444/data/index.html",
-    headerURL: "http://localhost:4444/data/header.png",
-    footerURL: "http://localhost:4444/data/footer.png",
-    previewURL: "http://localhost:4444/data/preview.png",
-    iconURL: "http://localhost:4444/data/icon.png",
-    updateURL: "http://localhost:4444/data/lwtheme.js"
+    homepageURL: "http://localhost:" + gPort + "/data/index.html",
+    headerURL: "http://localhost:" + gPort + "/data/header.png",
+    footerURL: "http://localhost:" + gPort + "/data/footer.png",
+    previewURL: "http://localhost:" + gPort + "/data/preview.png",
+    iconURL: "http://localhost:" + gPort + "/data/icon.png",
+    updateURL: "http://localhost:" + gPort + "/data/lwtheme.js"
   };
 
   // XXX The lightweight theme manager strips non-https updateURLs so hack it
   // back in.
   let themes = JSON.parse(Services.prefs.getCharPref("lightweightThemes.usedThemes"));
   do_check_eq(themes.length, 1);
-  themes[0].updateURL = "http://localhost:4444/data/lwtheme.js";
+  themes[0].updateURL = "http://localhost:" + gPort + "/data/lwtheme.js";
   Services.prefs.setCharPref("lightweightThemes.usedThemes", JSON.stringify(themes));
 
   testserver.registerPathHandler("/data/lwtheme.js", function(request, response) {
     // Server will specify an expiry in one year.
     let expiry = new Date();
     expiry.setFullYear(expiry.getFullYear() + 1);
     response.setHeader("Expires", expiry.toUTCString(), false);
     response.write(JSON.stringify({
       id: "1",
       version: "2",
       name: "Updated Theme",
       description: "A test theme",
       author: "Mozilla",
-      homepageURL: "http://localhost:4444/data/index2.html",
-      headerURL: "http://localhost:4444/data/header.png",
-      footerURL: "http://localhost:4444/data/footer.png",
-      previewURL: "http://localhost:4444/data/preview.png",
-      iconURL: "http://localhost:4444/data/icon2.png",
-      updateURL: "http://localhost:4444/data/lwtheme.js"
+      homepageURL: "http://localhost:" + gPort + "/data/index2.html",
+      headerURL: "http://localhost:" + gPort + "/data/header.png",
+      footerURL: "http://localhost:" + gPort + "/data/footer.png",
+      previewURL: "http://localhost:" + gPort + "/data/preview.png",
+      iconURL: "http://localhost:" + gPort + "/data/icon2.png",
+      updateURL: "http://localhost:" + gPort + "/data/lwtheme.js"
     }));
   });
 
   AddonManager.getAddonByID("1@personas.mozilla.org", function(p1) {
     do_check_neq(p1, null);
     do_check_eq(p1.version, "1");
     do_check_eq(p1.name, "Test LW Theme");
     do_check_true(p1.isActive);
@@ -512,32 +512,32 @@ function check_test_7() {
 
 // Test that background update checks for lightweight themes do not use the cache
 // The update body from test 7 shouldn't be used since the cache should be bypassed.
 function run_test_7_cache() {
   // XXX The lightweight theme manager strips non-https updateURLs so hack it
   // back in.
   let themes = JSON.parse(Services.prefs.getCharPref("lightweightThemes.usedThemes"));
   do_check_eq(themes.length, 1);
-  themes[0].updateURL = "http://localhost:4444/data/lwtheme.js";
+  themes[0].updateURL = "http://localhost:" + gPort + "/data/lwtheme.js";
   Services.prefs.setCharPref("lightweightThemes.usedThemes", JSON.stringify(themes));
 
   testserver.registerPathHandler("/data/lwtheme.js", function(request, response) {
     response.write(JSON.stringify({
       id: "1",
       version: "3",
       name: "Updated Theme v.3",
       description: "A test theme v.3",
       author: "John Smith",
-      homepageURL: "http://localhost:4444/data/index3.html?v=3",
-      headerURL: "http://localhost:4444/data/header.png?v=3",
-      footerURL: "http://localhost:4444/data/footer.png?v=3",
-      previewURL: "http://localhost:4444/data/preview.png?v=3",
-      iconURL: "http://localhost:4444/data/icon2.png?v=3",
-      updateURL: "https://localhost:4444/data/lwtheme.js?v=3"
+      homepageURL: "http://localhost:" + gPort + "/data/index3.html?v=3",
+      headerURL: "http://localhost:" + gPort + "/data/header.png?v=3",
+      footerURL: "http://localhost:" + gPort + "/data/footer.png?v=3",
+      previewURL: "http://localhost:" + gPort + "/data/preview.png?v=3",
+      iconURL: "http://localhost:" + gPort + "/data/icon2.png?v=3",
+      updateURL: "https://localhost:" + gPort + "/data/lwtheme.js?v=3"
     }));
   });
 
   AddonManager.getAddonByID("1@personas.mozilla.org", function(p1) {
     do_check_neq(p1, null);
     do_check_eq(p1.version, "2");
     do_check_eq(p1.name, "Updated Theme");
     do_check_true(p1.isActive);
@@ -563,100 +563,100 @@ function check_test_7_cache() {
   AddonManager.getAddonByID("1@personas.mozilla.org", function(p1) {
     let currentTheme = LightweightThemeManager.currentTheme;
     do_check_neq(p1, null);
     do_check_eq(p1.version, "3");
     do_check_eq(p1.name, "Updated Theme v.3");
     do_check_eq(p1.description, "A test theme v.3");
     do_print(JSON.stringify(p1));
     do_check_eq(p1.creator.name, "John Smith");
-    do_check_eq(p1.homepageURL, "http://localhost:4444/data/index3.html?v=3");
-    do_check_eq(p1.screenshots[0].url, "http://localhost:4444/data/preview.png?v=3");
-    do_check_eq(p1.iconURL, "http://localhost:4444/data/icon2.png?v=3");
-    do_check_eq(currentTheme.headerURL, "http://localhost:4444/data/header.png?v=3");
-    do_check_eq(currentTheme.footerURL, "http://localhost:4444/data/footer.png?v=3");
-    do_check_eq(currentTheme.updateURL, "https://localhost:4444/data/lwtheme.js?v=3");
+    do_check_eq(p1.homepageURL, "http://localhost:" + gPort + "/data/index3.html?v=3");
+    do_check_eq(p1.screenshots[0].url, "http://localhost:" + gPort + "/data/preview.png?v=3");
+    do_check_eq(p1.iconURL, "http://localhost:" + gPort + "/data/icon2.png?v=3");
+    do_check_eq(currentTheme.headerURL, "http://localhost:" + gPort + "/data/header.png?v=3");
+    do_check_eq(currentTheme.footerURL, "http://localhost:" + gPort + "/data/footer.png?v=3");
+    do_check_eq(currentTheme.updateURL, "https://localhost:" + gPort + "/data/lwtheme.js?v=3");
 
     do_check_eq(p1.installDate.getTime(), gInstallDate);
     do_check_true(p1.installDate.getTime() < p1.updateDate.getTime());
 
     run_test_8();
   });
 }
 
 // Verify the parameter escaping in update urls.
 function run_test_8() {
   writeInstallRDFForExtension({
     id: "addon1@tests.mozilla.org",
     version: "5.0",
-    updateURL: "http://localhost:4444/data/param_test.rdf" + PARAMS,
+    updateURL: "http://localhost:" + gPort + "/data/param_test.rdf" + PARAMS,
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "2"
     }],
     name: "Test Addon 1",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon2@tests.mozilla.org",
     version: "67.0.5b1",
-    updateURL: "http://localhost:4444/data/param_test.rdf" + PARAMS,
+    updateURL: "http://localhost:" + gPort + "/data/param_test.rdf" + PARAMS,
     targetApplications: [{
       id: "toolkit@mozilla.org",
       minVersion: "0",
       maxVersion: "3"
     }],
     name: "Test Addon 2",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon3@tests.mozilla.org",
     version: "1.3+",
-    updateURL: "http://localhost:4444/data/param_test.rdf" + PARAMS,
+    updateURL: "http://localhost:" + gPort + "/data/param_test.rdf" + PARAMS,
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0",
       maxVersion: "0"
     }, {
       id: "toolkit@mozilla.org",
       minVersion: "0",
       maxVersion: "3"
     }],
     name: "Test Addon 3",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon4@tests.mozilla.org",
     version: "0.5ab6",
-    updateURL: "http://localhost:4444/data/param_test.rdf" + PARAMS,
+    updateURL: "http://localhost:" + gPort + "/data/param_test.rdf" + PARAMS,
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "5"
     }],
     name: "Test Addon 4",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon5@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/param_test.rdf" + PARAMS,
+    updateURL: "http://localhost:" + gPort + "/data/param_test.rdf" + PARAMS,
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 5",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon6@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/param_test.rdf" + PARAMS,
+    updateURL: "http://localhost:" + gPort + "/data/param_test.rdf" + PARAMS,
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 6",
   }, profileDir);
 
@@ -782,17 +782,17 @@ function run_test_8() {
 }
 
 // Tests that if an install.rdf claims compatibility then the add-on will be
 // seen as compatible regardless of what the update.rdf says.
 function run_test_9() {
   writeInstallRDFForExtension({
     id: "addon4@tests.mozilla.org",
     version: "5.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0",
       maxVersion: "1"
     }],
     name: "Test Addon 1",
   }, profileDir);
 
@@ -853,17 +853,17 @@ function run_test_12() {
 // strict compatibility checking is disabled.
 function run_test_13() {
   restartManager();
 
   // Not initially compatible but the update check will make it compatible
   writeInstallRDFForExtension({
     id: "addon7@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0",
       maxVersion: "0"
     }],
     name: "Test Addon 7",
   }, profileDir);
   restartManager();
@@ -910,29 +910,29 @@ function check_test_13() {
 // allowed to update automatically.
 function run_test_14() {
   restartManager();
 
   // Have an add-on there that will be updated so we see some events from it
   writeInstallRDFForExtension({
     id: "addon1@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 1",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon8@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 8",
   }, profileDir);
   restartManager();
@@ -1010,29 +1010,29 @@ function check_test_14() {
 // pending uninstall
 function run_test_15() {
   restartManager();
 
   // Have an add-on there that will be updated so we see some events from it
   writeInstallRDFForExtension({
     id: "addon1@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 1",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon8@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 8",
   }, profileDir);
   restartManager();
@@ -1103,28 +1103,28 @@ function check_test_15() {
   });
 }
 
 function run_test_16() {
   restartManager();
 
   restartManager();
 
-  let url = "http://localhost:4444/addons/test_install2_1.xpi";
+  let url = "http://localhost:" + gPort + "/addons/test_install2_1.xpi";
   AddonManager.getInstallForURL(url, function(aInstall) {
     aInstall.addListener({
       onInstallEnded: function() {
        do_execute_soon(function install_2_1_ended() {
         restartManager();
 
         AddonManager.getAddonByID("addon2@tests.mozilla.org", function(a1) {
           do_check_neq(a1.syncGUID, null);
           let oldGUID = a1.syncGUID;
 
-          let url = "http://localhost:4444/addons/test_install2_2.xpi";
+          let url = "http://localhost:" + gPort + "/addons/test_install2_2.xpi";
           AddonManager.getInstallForURL(url, function(aInstall) {
             aInstall.addListener({
               onInstallEnded: function() {
                do_execute_soon(function install_2_2_ended() {
                 restartManager();
 
                 AddonManager.getAddonByID("addon2@tests.mozilla.org", function(a2) {
                   do_check_neq(a2.syncGUID, null);
@@ -1149,17 +1149,17 @@ function run_test_16() {
 // Test that the update check correctly observes the
 // extensions.strictCompatibility pref and compatibility overrides.
 function run_test_17() {
   restartManager();
 
   writeInstallRDFForExtension({
     id: "addon9@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0.1",
       maxVersion: "0.2"
     }],
     name: "Test Addon 9",
   }, profileDir);
   restartManager();
@@ -1174,30 +1174,30 @@ function run_test_17() {
       AddonManager.getAddonByID("addon9@tests.mozilla.org", function(a9) {
         a9.uninstall();
         do_execute_soon(run_test_18);
       });
     }
   });
 
   Services.prefs.setCharPref(PREF_GETADDONS_BYIDS_PERFORMANCE,
-                             "http://localhost:4444/data/test_update.xml");
+                             "http://localhost:" + gPort + "/data/test_update.xml");
   Services.prefs.setBoolPref(PREF_GETADDONS_CACHE_ENABLED, true);
   // Fake a timer event
   gInternalManager.notify(null);
 }
 
 // Tests that compatibility updates are applied to addons when the updated
 // compatibility data wouldn't match with strict compatibility enabled.
 function run_test_18() {
   restartManager();
   writeInstallRDFForExtension({
     id: "addon10@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0.1",
       maxVersion: "0.2"
     }],
     name: "Test Addon 10",
   }, profileDir);
   restartManager();
@@ -1224,17 +1224,17 @@ function run_test_18() {
 
 // Test that the update check correctly observes when an addon opts-in to
 // strict compatibility checking.
 function run_test_19() {
   restartManager();
   writeInstallRDFForExtension({
     id: "addon11@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0.1",
       maxVersion: "0.2"
     }],
     name: "Test Addon 11",
   }, profileDir);
   restartManager();
@@ -1261,17 +1261,17 @@ function run_test_19() {
 
 // Test that the update succeeds when the update.rdf URN contains a type prefix
 // different from the add-on type
 function run_test_20() {
   restartManager();
   writeInstallRDFForExtension({
     id: "addon12@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 12",
   }, profileDir);
   restartManager();
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_update_compatmode.js b/toolkit/mozapps/extensions/test/xpcshell/test_update_compatmode.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_update_compatmode.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_update_compatmode.js
@@ -5,71 +5,72 @@
 // This verifies that add-on update check correctly fills in the
 // %COMPATIBILITY_MODE% token in the update URL.
 
 
 // The test extension uses an insecure update url.
 Services.prefs.setBoolPref(PREF_EM_CHECK_UPDATE_SECURITY, false);
 
 Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+mapFile("/data/test_updatecompatmode_ignore.rdf", testserver);
+mapFile("/data/test_updatecompatmode_normal.rdf", testserver);
+mapFile("/data/test_updatecompatmode_strict.rdf", testserver);
+testserver.registerDirectory("/addons/", do_get_file("addons"));
+
 const profileDir = gProfD.clone();
 profileDir.append("extensions");
 
 function run_test() {
   do_test_pending();
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9.2");
-  
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/data/", do_get_file("data"));
-  testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.start(4444);
 
   writeInstallRDFForExtension({
     id: "compatmode-normal@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_updatecompatmode_%COMPATIBILITY_MODE%.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_updatecompatmode_%COMPATIBILITY_MODE%.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon - normal"
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "compatmode-strict@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_updatecompatmode_%COMPATIBILITY_MODE%.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_updatecompatmode_%COMPATIBILITY_MODE%.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon - strict"
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "compatmode-strict-optin@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_updatecompatmode_%COMPATIBILITY_MODE%.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_updatecompatmode_%COMPATIBILITY_MODE%.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon - strict opt-in",
     strictCompatibility: true
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "compatmode-ignore@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_updatecompatmode_%COMPATIBILITY_MODE%.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_updatecompatmode_%COMPATIBILITY_MODE%.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon - ignore",
   }, profileDir);
 
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_update_ignorecompat.js b/toolkit/mozapps/extensions/test/xpcshell/test_update_ignorecompat.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_update_ignorecompat.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_update_ignorecompat.js
@@ -7,40 +7,40 @@
 
 const PREF_GETADDONS_BYIDS_PERFORMANCE = "extensions.getAddons.getWithPerformance.url";
 const PREF_GETADDONS_CACHE_ENABLED = "extensions.getAddons.cache.enabled";
 
 // The test extension uses an insecure update url.
 Services.prefs.setBoolPref(PREF_EM_CHECK_UPDATE_SECURITY, false);
 
 Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+mapFile("/data/test_update.rdf", testserver);
+mapFile("/data/test_update.xml", testserver);
+testserver.registerDirectory("/addons/", do_get_file("addons"));
+
 const profileDir = gProfD.clone();
 profileDir.append("extensions");
 
 
 function run_test() {
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9.2");
 
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/data/", do_get_file("data"));
-  testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.start(4444);
-
   run_test_1();
 }
 
 // Test that the update check correctly observes the
 // extensions.strictCompatibility pref and compatibility overrides.
 function run_test_1() {
   writeInstallRDFForExtension({
     id: "addon9@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0.1",
       maxVersion: "0.2"
     }],
     name: "Test Addon 9",
   }, profileDir);
   restartManager();
@@ -52,29 +52,29 @@ function run_test_1() {
       do_check_eq(aInstall.version, "4.0");
     },
     onDownloadFailed: function(aInstall) {
       do_execute_soon(run_test_2);
     }
   });
 
   Services.prefs.setCharPref(PREF_GETADDONS_BYIDS_PERFORMANCE,
-                             "http://localhost:4444/data/test_update.xml");
+                             "http://localhost:" + gPort + "/data/test_update.xml");
   Services.prefs.setBoolPref(PREF_GETADDONS_CACHE_ENABLED, true);
   // Fake a timer event
   gInternalManager.notify(null);
 }
 
 // Test that the update check correctly observes when an addon opts-in to
 // strict compatibility checking.
 function run_test_2() {
   writeInstallRDFForExtension({
     id: "addon11@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0.1",
       maxVersion: "0.2"
     }],
     name: "Test Addon 11",
   }, profileDir);
   restartManager();
diff --git a/toolkit/mozapps/extensions/test/xpcshell/test_update_strictcompat.js b/toolkit/mozapps/extensions/test/xpcshell/test_update_strictcompat.js
--- a/toolkit/mozapps/extensions/test/xpcshell/test_update_strictcompat.js
+++ b/toolkit/mozapps/extensions/test/xpcshell/test_update_strictcompat.js
@@ -19,60 +19,60 @@ Components.utils.import("resource://gre/
 
 const PARAMS = "?%REQ_VERSION%/%ITEM_ID%/%ITEM_VERSION%/%ITEM_MAXAPPVERSION%/" +
                "%ITEM_STATUS%/%APP_ID%/%APP_VERSION%/%CURRENT_APP_VERSION%/" +
                "%APP_OS%/%APP_ABI%/%APP_LOCALE%/%UPDATE_TYPE%";
 
 var gInstallDate;
 
 Components.utils.import("resource://testing-common/httpd.js");
-var testserver;
+var testserver = new HttpServer();
+testserver.start(-1);
+gPort = testserver.identity.primaryPort;
+mapFile("/data/test_update.rdf", testserver);
+mapFile("/data/test_update.xml", testserver);
+testserver.registerDirectory("/addons/", do_get_file("addons"));
+
 const profileDir = gProfD.clone();
 profileDir.append("extensions");
 
 function run_test() {
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9.2");
   Services.prefs.setBoolPref(PREF_MATCH_OS_LOCALE, false);
   Services.prefs.setCharPref(PREF_SELECTED_LOCALE, "fr-FR");
   Services.prefs.setBoolPref(PREF_EM_STRICT_COMPATIBILITY, true);
 
-  // Create and configure the HTTP server.
-  testserver = new HttpServer();
-  testserver.registerDirectory("/data/", do_get_file("data"));
-  testserver.registerDirectory("/addons/", do_get_file("addons"));
-  testserver.start(4444);
-
   writeInstallRDFForExtension({
     id: "addon1@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 1",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon2@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0",
       maxVersion: "0"
     }],
     name: "Test Addon 2",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon3@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "5",
       maxVersion: "5"
     }],
     name: "Test Addon 3",
   }, profileDir);
 
@@ -358,17 +358,17 @@ function check_test_5() {
 
 // Test that background update checks work
 function run_test_6() {
   restartManager();
 
   writeInstallRDFForExtension({
     id: "addon1@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 1",
   }, profileDir);
   restartManager();
@@ -416,44 +416,44 @@ function run_test_7() {
   restartManager();
 
   LightweightThemeManager.currentTheme = {
     id: "1",
     version: "1",
     name: "Test LW Theme",
     description: "A test theme",
     author: "Mozilla",
-    homepageURL: "http://localhost:4444/data/index.html",
-    headerURL: "http://localhost:4444/data/header.png",
-    footerURL: "http://localhost:4444/data/footer.png",
-    previewURL: "http://localhost:4444/data/preview.png",
-    iconURL: "http://localhost:4444/data/icon.png",
-    updateURL: "http://localhost:4444/data/lwtheme.js"
+    homepageURL: "http://localhost:" + gPort + "/data/index.html",
+    headerURL: "http://localhost:" + gPort + "/data/header.png",
+    footerURL: "http://localhost:" + gPort + "/data/footer.png",
+    previewURL: "http://localhost:" + gPort + "/data/preview.png",
+    iconURL: "http://localhost:" + gPort + "/data/icon.png",
+    updateURL: "http://localhost:" + gPort + "/data/lwtheme.js"
   };
 
   // XXX The lightweight theme manager strips non-https updateURLs so hack it
   // back in.
   let themes = JSON.parse(Services.prefs.getCharPref("lightweightThemes.usedThemes"));
   do_check_eq(themes.length, 1);
-  themes[0].updateURL = "http://localhost:4444/data/lwtheme.js";
+  themes[0].updateURL = "http://localhost:" + gPort + "/data/lwtheme.js";
   Services.prefs.setCharPref("lightweightThemes.usedThemes", JSON.stringify(themes));
 
   testserver.registerPathHandler("/data/lwtheme.js", function(request, response) {
     response.write(JSON.stringify({
       id: "1",
       version: "2",
       name: "Updated Theme",
       description: "A test theme",
       author: "Mozilla",
-      homepageURL: "http://localhost:4444/data/index2.html",
-      headerURL: "http://localhost:4444/data/header.png",
-      footerURL: "http://localhost:4444/data/footer.png",
-      previewURL: "http://localhost:4444/data/preview.png",
-      iconURL: "http://localhost:4444/data/icon2.png",
-      updateURL: "http://localhost:4444/data/lwtheme.js"
+      homepageURL: "http://localhost:" + gPort + "/data/index2.html",
+      headerURL: "http://localhost:" + gPort + "/data/header.png",
+      footerURL: "http://localhost:" + gPort + "/data/footer.png",
+      previewURL: "http://localhost:" + gPort + "/data/preview.png",
+      iconURL: "http://localhost:" + gPort + "/data/icon2.png",
+      updateURL: "http://localhost:" + gPort + "/data/lwtheme.js"
     }));
   });
 
   AddonManager.getAddonByID("1@personas.mozilla.org", function(p1) {
     do_check_neq(p1, null);
     do_check_eq(p1.version, "1");
     do_check_eq(p1.name, "Test LW Theme");
     do_check_true(p1.isActive);
@@ -500,81 +500,81 @@ function check_test_7() {
   });
 }
 
 // Verify the parameter escaping in update urls.
 function run_test_8() {
   writeInstallRDFForExtension({
     id: "addon1@tests.mozilla.org",
     version: "5.0",
-    updateURL: "http://localhost:4444/data/param_test.rdf" + PARAMS,
+    updateURL: "http://localhost:" + gPort + "/data/param_test.rdf" + PARAMS,
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "2"
     }],
     name: "Test Addon 1",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon2@tests.mozilla.org",
     version: "67.0.5b1",
-    updateURL: "http://localhost:4444/data/param_test.rdf" + PARAMS,
+    updateURL: "http://localhost:" + gPort + "/data/param_test.rdf" + PARAMS,
     targetApplications: [{
       id: "toolkit@mozilla.org",
       minVersion: "0",
       maxVersion: "3"
     }],
     name: "Test Addon 2",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon3@tests.mozilla.org",
     version: "1.3+",
-    updateURL: "http://localhost:4444/data/param_test.rdf" + PARAMS,
+    updateURL: "http://localhost:" + gPort + "/data/param_test.rdf" + PARAMS,
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0",
       maxVersion: "0"
     }, {
       id: "toolkit@mozilla.org",
       minVersion: "0",
       maxVersion: "3"
     }],
     name: "Test Addon 3",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon4@tests.mozilla.org",
     version: "0.5ab6",
-    updateURL: "http://localhost:4444/data/param_test.rdf" + PARAMS,
+    updateURL: "http://localhost:" + gPort + "/data/param_test.rdf" + PARAMS,
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "5"
     }],
     name: "Test Addon 4",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon5@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/param_test.rdf" + PARAMS,
+    updateURL: "http://localhost:" + gPort + "/data/param_test.rdf" + PARAMS,
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 5",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon6@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/param_test.rdf" + PARAMS,
+    updateURL: "http://localhost:" + gPort + "/data/param_test.rdf" + PARAMS,
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 6",
   }, profileDir);
 
@@ -700,17 +700,17 @@ function run_test_8() {
 }
 
 // Tests that if an install.rdf claims compatibility then the add-on will be
 // seen as compatible regardless of what the update.rdf says.
 function run_test_9() {
   writeInstallRDFForExtension({
     id: "addon4@tests.mozilla.org",
     version: "5.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0",
       maxVersion: "1"
     }],
     name: "Test Addon 1",
   }, profileDir);
 
@@ -770,17 +770,17 @@ function run_test_12() {
 // version of the app that the caller requested an update check for.
 function run_test_13() {
   restartManager();
 
   // Not initially compatible but the update check will make it compatible
   writeInstallRDFForExtension({
     id: "addon7@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0",
       maxVersion: "0"
     }],
     name: "Test Addon 7",
   }, profileDir);
   restartManager();
@@ -827,29 +827,29 @@ function check_test_13() {
 // allowed to update automatically.
 function run_test_14() {
   restartManager();
 
   // Have an add-on there that will be updated so we see some events from it
   writeInstallRDFForExtension({
     id: "addon1@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 1",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon8@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 8",
   }, profileDir);
   restartManager();
@@ -926,29 +926,29 @@ function check_test_14() {
 // pending uninstall
 function run_test_15() {
   restartManager();
 
   // Have an add-on there that will be updated so we see some events from it
   writeInstallRDFForExtension({
     id: "addon1@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 1",
   }, profileDir);
 
   writeInstallRDFForExtension({
     id: "addon8@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "1",
       maxVersion: "1"
     }],
     name: "Test Addon 8",
   }, profileDir);
   restartManager();
@@ -1022,17 +1022,17 @@ function check_test_15() {
 // Test that the update check correctly observes the
 // extensions.strictCompatibility pref and compatibility overrides.
 function run_test_16() {
   restartManager();
 
   writeInstallRDFForExtension({
     id: "addon9@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0.1",
       maxVersion: "0.2"
     }],
     name: "Test Addon 9",
   }, profileDir);
   restartManager();
@@ -1044,30 +1044,30 @@ function run_test_16() {
       do_check_eq(aInstall.version, "2.0");
     },
     onDownloadFailed: function(aInstall) {
       do_execute_soon(run_test_17);
     }
   });
 
   Services.prefs.setCharPref(PREF_GETADDONS_BYIDS_PERFORMANCE,
-                             "http://localhost:4444/data/test_update.xml");
+                             "http://localhost:" + gPort + "/data/test_update.xml");
   Services.prefs.setBoolPref(PREF_GETADDONS_CACHE_ENABLED, true);
   // Fake a timer event
   gInternalManager.notify(null);
 }
 
 // Test that the update check correctly observes when an addon opts-in to
 // strict compatibility checking.
 function run_test_17() {
 
   writeInstallRDFForExtension({
     id: "addon11@tests.mozilla.org",
     version: "1.0",
-    updateURL: "http://localhost:4444/data/test_update.rdf",
+    updateURL: "http://localhost:" + gPort + "/data/test_update.rdf",
     targetApplications: [{
       id: "xpcshell@tests.mozilla.org",
       minVersion: "0.1",
       maxVersion: "0.2"
     }],
     name: "Test Addon 11",
   }, profileDir);
   restartManager();
diff --git a/toolkit/mozapps/extensions/test/xpcshell/xpcshell.ini b/toolkit/mozapps/extensions/test/xpcshell/xpcshell.ini
--- a/toolkit/mozapps/extensions/test/xpcshell/xpcshell.ini
+++ b/toolkit/mozapps/extensions/test/xpcshell/xpcshell.ini
@@ -4,16 +4,17 @@ tail =
 firefox-appdir = browser
 
 [test_AddonRepository.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
 [test_AddonRepository_cache.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
+run-sequentially = Uses hardcoded ports in xpi files.
 [test_AddonRepository_compatmode.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
 [test_DeferredSave.js]
 [test_LightweightThemeManager.js]
 [test_backgroundupdate.js]
 [test_badschema.js]
 [test_blocklistchange.js]
@@ -22,37 +23,42 @@ skip-if = os == "android"
 [test_blocklist_regexp.js]
 skip-if = os == "android"
 [test_bootstrap.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
 [test_bug299716.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
+run-sequentially = Uses hardcoded ports in xpi files.
 [test_bug299716_2.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
+run-sequentially = Hardcoded port in install.rdf.
 [test_bug324121.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
+run-sequentially = Uses hardcoded ports in xpi files.
 [test_bug335238.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
+run-sequentially = Uses hardcoded ports in xpi files.
 [test_bug371495.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
 [test_bug384052.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
 [test_bug393285.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
 [test_bug394300.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
+run-sequentially = Uses hardcoded ports in xpi files.
 [test_bug397778.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
 [test_bug406118.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
 [test_bug424262.js]
 # Bug 676992: test consistently hangs on Android
@@ -101,16 +107,17 @@ skip-if = os == "android"
 skip-if = os == "android"
 [test_bug514327_3.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
 [test_bug521905.js]
 [test_bug526598.js]
 [test_bug541420.js]
 [test_bug542391.js]
+run-sequentially = Uses hardcoded ports in xpi files.
 [test_bug554133.js]
 [test_bug559800.js]
 [test_bug563256.js]
 # Bug 676992: test consistently fails on Android
 fail-if = os == "android"
 [test_bug564030.js]
 [test_bug566626.js]
 [test_bug567184.js]
@@ -178,16 +185,17 @@ skip-if = os == "android"
 [test_hotfix.js]
 [test_install.js]
 [test_install_icons.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
 [test_install_strictcompat.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
+run-sequentially = Uses hardcoded ports in xpi files.
 [test_locale.js]
 [test_locked.js]
 [test_locked2.js]
 [test_locked_strictcompat.js]
 [test_manifest.js]
 [test_mapURIToAddonID.js]
 # Same as test_bootstrap.js
 skip-if = os == "android"
@@ -226,18 +234,22 @@ skip-if = os == "android"
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
 [test_update_ignorecompat.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
 [test_updatecheck.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
+run-sequentially = Uses hardcoded ports in xpi files.
 [test_updateid.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
+run-sequentially = Uses hardcoded ports in xpi files.
 [test_update_compatmode.js]
 [test_upgrade.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
+run-sequentially = Uses global XCurProcD dir.
 [test_upgrade_strictcompat.js]
 # Bug 676992: test consistently hangs on Android
 skip-if = os == "android"
+run-sequentially = Uses global XCurProcD dir.

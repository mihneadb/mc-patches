# HG changeset patch
# User Chris Manchester <cmanchester@mozilla.com>
# Date 1375810109 25200
#      Tue Aug 06 10:28:29 2013 -0700
# Node ID 0b92345ff58758b3924426f16da2825a42678670
# Parent 44016a6e78e593e84f9f5a089b7f0d94ff2e13d9
Bug 887054 - Synchronize blocks of output when running xpcshell tests in parallel; r=ted

diff --git a/testing/xpcshell/runxpcshelltests.py b/testing/xpcshell/runxpcshelltests.py
--- a/testing/xpcshell/runxpcshelltests.py
+++ b/testing/xpcshell/runxpcshelltests.py
@@ -9,31 +9,37 @@ import re, sys, os, os.path, logging, sh
 import xml.dom.minidom
 from collections import deque
 from distutils import dir_util
 from glob import glob
 from multiprocessing import cpu_count
 from optparse import OptionParser
 from subprocess import Popen, PIPE, STDOUT
 from tempfile import mkdtemp, gettempdir
-from threading import Timer, Thread, Event
+from threading import Timer, Thread, Event, RLock
 import random
 import signal
 import socket
 import time
 
 try:
     import psutil
     HAVE_PSUTIL = True
 except ImportError:
     HAVE_PSUTIL = False
 
 from automation import Automation, getGlobalLog, resetGlobalLog
 from automationutils import *
 
+# Printing buffered output in case of a failure or verbose mode will result
+# in buffered output interleaved with other threads' output.
+# To prevent his, each call to the logger as well as any blocks of output that
+# are intended to be continuous are protected by the same lock.
+LOG_MUTEX = RLock()
+
 HARNESS_TIMEOUT = 5 * 60
 
 # benchmarking on tbpl revealed that this works best for now
 NUM_THREADS = int(cpu_count() * 4)
 
 # --------------------------------------------------------------
 # TODO: this is a hack for mozbase without virtualenv, remove with bug 849900
 #
@@ -350,20 +356,21 @@ class XPCShellTestThread(Thread):
 
         # we try again later at the end of the run for plugin dirs (because windows!)
         if directory == self.pluginsDir:
             self.cleanup_dir_list.append(directory)
             return
 
         # we couldn't clean up the directory, and it's not the plugins dir,
         # which means that something wrong has probably happened
-        message = "TEST-UNEXPECTED-FAIL | %s | Failed to clean up directory: %s" % (name, sys.exc_info()[1])
-        self.log.error(message)
-        self.print_stdout(stdout)
-        self.print_stdout(traceback.format_exc())
+        with LOG_MUTEX:
+            message = "TEST-UNEXPECTED-FAIL | %s | Failed to clean up directory: %s" % (name, sys.exc_info()[1])
+            self.log.error(message)
+            self.print_stdout(stdout)
+            self.print_stdout(traceback.format_exc())
 
         self.failCount += 1
         xunit_result["passed"] = False
         xunit_result["failure"] = {
             "type": "TEST-UNEXPECTED-FAIL",
             "message": message,
             "text": "%s\n%s" % (stdout, traceback.format_exc())
         }
@@ -471,33 +478,38 @@ class XPCShellTestThread(Thread):
                                                 stdout, re.MULTILINE)
                                   and not re.search("^child: CHILD-TEST-COMPLETED",
                                                     stdout, re.MULTILINE)))
 
             if result != expected:
                 failureType = "TEST-UNEXPECTED-%s" % ("FAIL" if expected else "PASS")
                 message = "%s | %s | test failed (with xpcshell return code: %d), see following log:" % (
                               failureType, name, self.getReturnCode(proc))
-                self.log.error(message)
-                self.print_stdout(stdout)
+
+                with LOG_MUTEX:
+                    self.log.error(message)
+                    self.print_stdout(stdout)
+
                 self.failCount += 1
                 self.xunit_result["passed"] = False
 
                 self.xunit_result["failure"] = {
                   "type": failureType,
                   "message": message,
                   "text": stdout
                 }
             else:
                 now = time.time()
                 timeTaken = (now - startTime) * 1000
                 self.xunit_result["time"] = now - startTime
-                self.log.info("TEST-%s | %s | test passed (time: %.3fms)" % ("PASS" if expected else "KNOWN-FAIL", name, timeTaken))
-                if self.verbose:
-                    self.print_stdout(stdout)
+
+                with LOG_MUTEX:
+                    self.log.info("TEST-%s | %s | test passed (time: %.3fms)" % ("PASS" if expected else "KNOWN-FAIL", name, timeTaken))
+                    if self.verbose:
+                        self.print_stdout(stdout)
 
                 self.xunit_result["passed"] = True
 
                 if expected:
                     self.passCount = 1
                 else:
                     self.todoCount = 1
                     self.xunit_result["todo"] = True
@@ -514,19 +526,21 @@ class XPCShellTestThread(Thread):
 
             if self.logfiles and stdout:
                 self.createLogFile(name, stdout)
 
         finally:
             # We can sometimes get here before the process has terminated, which would
             # cause removeDir() to fail - so check for the process & kill it it needed.
             if proc and self.poll(proc) is None:
-                message = "TEST-UNEXPECTED-FAIL | %s | Process still running after test!" % name
-                self.log.error(message)
-                self.print_stdout(stdout)
+                with LOG_MUTEX:
+                    message = "TEST-UNEXPECTED-FAIL | %s | Process still running after test!" % name
+                    self.log.error(message)
+                    self.print_stdout(stdout)
+
                 self.failCount = 1
                 self.xunit_result["passed"] = False
                 self.xunit_result["failure"] = {
                   "type": "TEST-UNEXPECTED-FAIL",
                   "message": message,
                   "text": stdout
                 }
                 self.kill(proc)
@@ -564,16 +578,30 @@ class XPCShellTests(object):
 
     log = getGlobalLog()
     oldcwd = os.getcwd()
 
     def __init__(self, log=None):
         """ Init logging and node status """
         if log:
             resetGlobalLog(log)
+
+        # Each method of the underlying logger must acquire the log
+        # mutex before writing to stdout.
+        log_funs = ['debug', 'info', 'warning', 'error', 'critical', 'log']
+        for fun_name in log_funs:
+            unwrapped = getattr(self.log, fun_name, None)
+            if unwrapped:
+                def wrap(fn):
+                    def wrapped(*args, **kwargs):
+                        with LOG_MUTEX:
+                            fn(*args, **kwargs)
+                    return wrapped
+                setattr(self.log, fun_name, wrap(unwrapped))
+
         self.nodeProc = None
 
     def buildTestList(self):
         """
           read the xpcshell.ini manifest and set self.alltests to be
           an array of test objects.
 
           if we are chunking tests, it will be done here as well
